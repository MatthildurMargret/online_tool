<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Valuation Tool</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .btn-primary { background-color:#161f6d; }
    .btn-primary:hover { background-color:#0f1751; }
    .text-brand { color:#131f72; }
    th, td { white-space: nowrap; }
    table { border-collapse: collapse; width: 100%; }
    th { font-weight: 600; }
    #foundersScroll::-webkit-scrollbar { height: 8px; }
    #foundersScroll::-webkit-scrollbar-thumb {
      background-color: #cbd5e1; border-radius: 4px;
    }
    #searchResults.hidden,
    #recommendedResults.hidden {
      display: none !important;
    }
    .tab-btn {
      transition: all 0.25s ease;
    }

    .tab-btn:hover {
      color: #161f6d; /* your brand color */
    }

    .tab-btn.active {
      border-color: #161f6d;
      color: #161f6d;
    }

    </style>
</head>
<body class="min-h-screen flex" style="background: linear-gradient(to bottom right, #F9FAFF, #E3F1FF, #E3F1FF);">
  <!-- Sidebar -->
  <aside class="w-64 text-white p-6 flex flex-col gap-3" style="background-color: #161F6D;">
    <div class="mb-6 pl-3 flex items-center">
  <img src="montage_logo.png" alt="Monty Logo" class="h-12 object-contain">
</div>

    <button id="btn-welcomeModule"
        class="sidebar-btn text-left py-2 px-3 rounded hover:bg-blue-800"
        onclick="showModule('welcomeModule')">
  Home
</button>

    <button id="btn-valuationModule"
            class="sidebar-btn text-left py-2 px-3 rounded hover:bg-blue-800"
            onclick="showModule('valuationModule')">
      Public Market Data 
    </button>
    <button id="btn-foundersModule"
            class="sidebar-btn text-left py-2 px-3 rounded hover:bg-blue-800"
            onclick="showModule('foundersModule')">
      Sourcing Recommendations
    </button>
  </aside>

  <!-- Main content area -->
  <main class="flex-1 p-8 overflow-y-auto">
    <!-- Welcome page (default) -->
<div id="welcomeModule" class="space-y-10">
  <div class="bg-white rounded-xl shadow-lg w-full max-w-3xl p-6 mx-auto text-center">
    <h2 class="text-2xl font-bold text-brand mb-4">Welcome to Monty</h2>
    <p class="text-gray-600">
      Use the sidebar to explore Monty’s Valuation Tool or Founder Recommendations.
    </p>
  </div>
</div>


    <div id="valuationModule" class="space-y-10 hidden">


  <!-- Single Stock Section -->
  <div class="bg-white rounded-xl shadow-lg w-full max-w-3xl p-6 space-y-6 mx-auto">

    <div class="flex gap-2">
      <input id="tickerInput" type="text" placeholder="Enter ticker (e.g. AAPL)"
        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
        onkeypress="if(event.key==='Enter') fetchData()" />
      <button onclick="fetchData()" class="btn-primary text-white px-4 py-2 rounded-lg font-semibold">Search</button>
    </div>

    <div id="loading" class="hidden text-center py-4">
      <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
      <p class="text-sm text-gray-600 mt-2">Loading...</p>
    </div>

    <div id="errorBox" class="hidden bg-red-50 border border-red-200 text-red-700 text-sm rounded-lg p-3"></div>

    <div id="results" class="hidden space-y-4">
      <div class="flex items-center justify-between">
        <h2 id="companyHeader" class="text-lg font-bold text-brand"></h2>
        <p id="stockPrice" class="text-xl font-semibold text-green-600"></p>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div class="bg-gray-50 p-3 rounded-lg"><p class="text-xs text-gray-500">Revenue</p><p id="revenue" class="font-semibold text-gray-800">—</p></div>
        <div class="bg-gray-50 p-3 rounded-lg"><p class="text-xs text-gray-500">P/E</p><p id="pe" class="font-semibold text-gray-800">—</p></div>
        <div class="bg-gray-50 p-3 rounded-lg"><p class="text-xs text-gray-500">P/S</p><p id="ps" class="font-semibold text-gray-800">—</p></div>
        <div class="bg-gray-50 p-3 rounded-lg"><p class="text-xs text-gray-500">Market Cap</p><p id="marketCap" class="font-semibold text-gray-800">—</p></div>
      </div>

      <button onclick="openModal()" class="w-full text-sm mt-2 py-2 rounded-lg border border-gray-300 hover:bg-gray-100">
        View Full Income Statement →
      </button>
    </div>
  </div>

  <!-- Industry Comparison Section -->
  <div id="industryPicker" class="bg-white rounded-xl shadow-lg w-full max-w-3xl p-6 space-y-5 mx-auto">
    <h2 class="text-2xl font-bold text-brand text-center mb-4">Industry Comparison</h2>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Select Industry</label>
      <select id="industrySelect"
              onchange="updateSectorOptions()"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        <option value="">Select Industry</option>
      </select>
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Select Sector</label>
      <select id="sectorSelect"
              onchange="updateIndustryGroupOptions()"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              disabled>
        <option value="">Select Sector</option>
      </select>
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Select Industry Group (optional)</label>
      <select id="industryGroupSelect"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-gray-100"
              disabled>
        <option value="">All Groups in Sector</option>
      </select>
    </div>

    <button type="button"
            onclick="fetchIndustryComparison()"
            class="w-full btn-primary text-white py-3 px-6 rounded-lg font-semibold">
      Compare Companies
    </button>
  </div>

</div>


  <div id="modalOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center" onclick="closeModal()"></div>
  <div id="modal" class="hidden fixed inset-8 bg-white rounded-xl shadow-2xl z-50 overflow-auto p-6">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-brand">Income Statement</h2>
        <button onclick="closeModal()" class="text-2xl leading-none text-gray-700">×</button>
    </div>
    <div id="modalBody"></div>
    </div>
    </div> <!-- end valuationModule -->
    <div id="foundersModule" class="hidden">
  <div class="bg-white rounded-xl shadow-lg w-full p-6 space-y-4">
    <h2 class="text-2xl font-bold text-brand text-center mb-4">Monty's Sourcing Recommendations</h2>

<!-- Tabs (always visible) -->
<div class="flex justify-center border-b border-gray-300 mt-4">
  <button
    id="recommendedTab"
    onclick="showTab('recommended')"
    class="tab-btn border-b-2 border-blue-700 text-blue-700 font-semibold px-6 py-2">
    Recommended
  </button>
  <button
    id="searchTab"
    onclick="showTab('search')"
    class="tab-btn border-b-2 border-transparent text-gray-600 hover:text-blue-700 px-6 py-2">
    Search Database
  </button>
</div>


<!-- Recommended Filters -->
<div id="treePathFilters" class="space-y-3 hidden">
  <label class="block text-sm font-medium text-gray-700 mb-1">
    Filter by vertical 
  </label>

  <select id="treeLevel1"
          onchange="updateTreeLevel2()"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
    <option value="">All</option>
  </select>

<div id="treeLevel2Container" class="hidden">
  <select id="treeLevel2"
          onchange="updateTreeLevel3()"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
    <option value="">All</option>
  </select>
</div>


<div id="treeLevel3Container" class="hidden">
  <select id="treeLevel3"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
    <option value="">All</option>
  </select>
</div>
</div>
<!-- Search Filters -->
<div id="searchPanel" class="space-y-3 hidden">
  <!-- Tree Path Filters for Search -->
<div class="space-y-2">
  <label class="block text-sm font-medium text-gray-700 mb-1">
    Optional filters
  </label>

  <select id="searchTreeLevel1"
          onchange="updateSearchTreeLevel2()"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
    <option value="">All verticals</option>
  </select>

  <div id="searchTreeLevel2Container" class="hidden">
  <select id="searchTreeLevel2"
          onchange="updateSearchTreeLevel3()"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
          disabled>
    <option value="">All</option>
  </select>
  </div>

  <div id="searchTreeLevel3Container" class="hidden">
  <select id="searchTreeLevel3"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
          disabled>
    <option value="">All</option>
  </select>
</div>
</div>


  <input id="searchKeyword" type="text"
         placeholder="Keyword (e.g. company or founder)"
         class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">

  <select id="searchLocation"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
    <option value="">Location</option>
  </select>

  <input id="searchTag" type="text"
         placeholder="Tag"
         class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">

  <button onclick="searchFounders()"
          class="w-full mt-2 btn-primary text-white py-2 px-4 rounded-lg font-semibold">
    Search
  </button>
</div>



    <!-- Two-column layout -->
    <div class="flex gap-6 mt-6">
      <!-- Left: scroll list -->
      <div class="w-1/2">
        <div id="foundersLoading" class="hidden text-center py-4">
          <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
          <p class="text-sm text-gray-600 mt-2">Loading...</p>
        </div>

        <!-- Recommended results -->
      <div id="recommendedResults" class="hidden overflow-y-auto max-h-[700px] border border-gray-200 rounded-lg p-3">
        <div id="recommendedScroll" class="flex flex-col gap-4"></div>
      </div>

      <!-- Search results -->
      <div id="searchResults"
     class="hidden overflow-y-auto max-h-[700px] border border-gray-200 rounded-lg p-3">
  <div id="searchScroll" class="flex flex-col gap-4"></div>
</div>

      </div>

      <!-- Right: detail panel -->
      <div id="founderDetailPanel" class="w-1/2 bg-gray-50 border border-gray-200 rounded-lg p-4 hidden">
        <h3 id="founderDetailTitle" class="text-xl font-bold text-brand mb-3">Founder Details</h3>
        <div id="founderDetailBody" class="text-sm text-gray-700 space-y-2"></div>
      </div>
    </div>
  </div>
</div>

  </main>
</body>

<script>
function showModule(id) {
  ["welcomeModule", "valuationModule", "foundersModule"].forEach(m =>
    document.getElementById(m).classList.add("hidden")
  );
  document.getElementById(id).classList.remove("hidden");

  document.querySelectorAll(".sidebar-btn").forEach(b =>
    b.classList.remove("bg-blue-700")
  );
  document.getElementById("btn-" + id).classList.add("bg-blue-700");

  if (id === "foundersModule") {
    loadFilters().then(() => showTab("recommended"));
  }
}




</script>

  <script>
    
    const API_URL = "";
    const $ = (id) => document.getElementById(id);

    function fmtNum(v) {
      if (v == null || isNaN(v)) return "N/A";
      if (Math.abs(v) >= 1e9) return `$${(v / 1e9).toFixed(2)}B`;
      if (Math.abs(v) >= 1e6) return `$${(v / 1e6).toFixed(2)}M`;
      if (Math.abs(v) >= 1e3) return `$${(v / 1e3).toFixed(2)}K`;
      return `$${v.toFixed(2)}`;
    }

    async function fetchData() {
        const ticker = $("tickerInput").value.trim().toUpperCase();
        if (!ticker) return showError("Enter a ticker symbol.");
        hideError(); $("results").classList.add("hidden"); $("loading").classList.remove("hidden");

        try {
            async function safeFetchJSON(url) {
            const res = await fetch(url);
            const text = await res.text();
            const cleanText = text
                .replace(/\b-?Infinity\b/g, "null") // handles Infinity and -Infinity
                .replace(/\bNaN\b/g, "null");
            return JSON.parse(cleanText);
            }

            const [finRes, incRes, priceRes, valRes] = await Promise.all([
            safeFetchJSON(`${API_URL}/api/financials/${ticker}`),
            safeFetchJSON(`${API_URL}/api/income/${ticker}`),
            safeFetchJSON(`${API_URL}/api/stock-price/${ticker}`),
            safeFetchJSON(`${API_URL}/api/valuation/${ticker}`),
            ]);

            $("loading").classList.add("hidden");

            if (!finRes.success || !priceRes.success || !valRes.success) {
            return showError("Unable to retrieve data for this ticker.");
            }

            $("companyHeader").textContent = ticker;
            $("stockPrice").textContent = priceRes.data?.price ? `$${priceRes.data.price.toFixed(2)}` : "N/A";
            $("revenue").textContent = fmtNum(finRes.data?.revenue);
            $("pe").textContent = valRes.data?.pe ? valRes.data.pe.toFixed(2) : "N/A";
            $("ps").textContent = valRes.data?.ps ? valRes.data.ps.toFixed(2) : "N/A";
            $("marketCap").textContent = fmtNum(valRes.data?.market_cap);

            if (incRes?.success) {
            window.latestIncome = incRes.data?.income_statement || null;
            window.fullFinancials = incRes.data || null;
            } else {
            window.latestIncome = null;
            window.fullFinancials = null;
            }

            $("results").classList.remove("hidden");
        } catch (err) {
            console.error(err);
            showError("Failed to connect to backend.");
            $("loading").classList.add("hidden");
        }
        }

    function showError(msg){$("errorBox").textContent=msg;$("errorBox").classList.remove("hidden");}
    function hideError(){$("errorBox").classList.add("hidden");}

    // Helper: find all period keys and sort newest → oldest
    function extractPeriods(statement) {
        return Object.keys(statement)
        .filter(k => /^\d{4}-\d{2}(-\d{2})?$/.test(k))
        .sort((a, b) => b.localeCompare(a));
    }

    // Helper: normalize a date key to YYYY-MM for mapping
    const norm = (s) => (s || "").slice(0, 7);

    // Heuristic formatting (reuses your fmtNum for currency-like values)
    function formatCell(label, v) {
        if (v === null || v === undefined || !isFinite(v)) return "N/A";
        const lower = (label || "").toLowerCase();
        if (lower.includes("earnings per share")) return v.toFixed(2);
        if (lower.includes("shares")) {
        const abs = Math.abs(v);
        if (abs >= 1e9) return (v / 1e9).toFixed(2) + "B";
        if (abs >= 1e6) return (v / 1e6).toFixed(2) + "M";
        return v.toLocaleString("en-US", { maximumFractionDigits: 0 });
        }
        return fmtNum(v); // your existing formatter
    }
    function openEmptyModal(title = "Results") {
        $("modalBody").innerHTML = "";
        $("modalOverlay").classList.remove("hidden");
        $("modal").classList.remove("hidden");
        document.querySelector("#modal h2").textContent = title;
        }

    function openModal() {
        const full = window.fullFinancials || null;
        const income = full?.income_statement || null;
        const meta = full?.filing_metadata || [];

        if (!income || !income.label) {
            $("modalBody").innerHTML =
            `<div class="p-6 text-center text-gray-500">No income data</div>`;
            $("modalOverlay").classList.remove("hidden");
            $("modal").classList.remove("hidden");
            return;
        }

        // Helpers
        const periods = Object.keys(income)
            .filter(k => /^\d{4}-\d{2}(-\d{2})?$/.test(k))
            .sort((a,b) => b.localeCompare(a)); // newest → left
        const labelsMap = income.label || {};
        const labelIdxs = Object.keys(labelsMap).sort((a,b)=>Number(a)-Number(b));
        const norm = s => (s || "").slice(0,7);
        const metaByPeriod = {};
        meta.forEach(m => metaByPeriod[norm(m.period_end)] = m);

        // Build table shell
        const body = $("modalBody");
        if (!body) { console.error("Missing #modalBody"); return; }
        body.innerHTML = `
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="px-6 py-4 bg-gray-50 border-b border-gray-200 flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-800">Income Statement</h3>
                <div class="text-xs text-gray-500">Periods: ${periods.join(" • ")}</div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                <thead class="bg-gray-100 border-b border-gray-200" id="incomeThead"></thead>
                <tbody class="divide-y divide-gray-200" id="incomeTable"></tbody>
                </table>
            </div>
            </div>
        `;

        // Header row
        const thead = $("incomeThead");
        thead.innerHTML = `
            <tr>
            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700 sticky left-0 bg-gray-100 z-10">Line Item</th>
            ${periods.map(p => {
                const m = metaByPeriod[norm(p)];
                const type = m?.type || "—";
                const pe = m?.period_end || p;
                return `
                <th class="px-6 py-3 text-right text-sm font-semibold text-gray-700">
                    <div class="flex flex-col items-end">
                    <span class="inline-block text-xs px-2 py-0.5 rounded bg-gray-200 text-gray-700">${type}</span>
                    <span class="text-xs text-gray-500 mt-1">${pe}</span>
                    </div>
                </th>`;
            }).join("")}
            </tr>
        `;

        // Body rows
        const tbody = $("incomeTable");
        labelIdxs.forEach(idx => {
            const label = labelsMap[idx];
            const tr = document.createElement("tr");
            tr.className = "hover:bg-gray-50";

            // sticky label
            const th = document.createElement("td");
            th.className = "px-6 py-3 text-sm text-gray-800 sticky left-0 bg-white z-10";
            th.textContent = label;
            tr.appendChild(th);

            // cells per period
            periods.forEach(p => {
            const rowVals = income[p] || {};
            const v = Object.prototype.hasOwnProperty.call(rowVals, idx) ? rowVals[idx] : null;
            const td = document.createElement("td");
            td.className = "px-6 py-3 text-sm text-gray-800 text-right";
            td.textContent = formatCell(label, v);
            tr.appendChild(td);
            });

            tbody.appendChild(tr);
        });

        $("modalOverlay").classList.remove("hidden");
        $("modal").classList.remove("hidden");

        // simple formatter that reuses your fmtNum for currency-like values
        function formatCell(label, v) {
            if (v === null || v === undefined || !isFinite(v)) return "N/A";
            const lower = (label || "").toLowerCase();
            if (lower.includes("earnings per share")) return Number(v).toFixed(2);
            if (lower.includes("shares")) {
            const n = Number(v);
            const abs = Math.abs(n);
            if (abs >= 1e9) return (n/1e9).toFixed(2) + "B";
            if (abs >= 1e6) return (n/1e6).toFixed(2) + "M";
            return n.toLocaleString("en-US", { maximumFractionDigits: 0 });
            }
            return fmtNum(Number(v));
        }
        }

        function closeModal() {
        $("modalOverlay").classList.add("hidden");
        $("modal").classList.add("hidden");
        }

  </script>
  <script>
  // In-memory map
  let industryMapData = null;

  // Load map on page load
  document.addEventListener("DOMContentLoaded", () => {
    loadIndustryMap();
  });

  async function loadIndustryMap() {
    try {
      // try API first, then fall back to static file if you serve one
      const res = await fetch(`${API_URL || ""}/api/industry-map`);
      const json = await res.json();
      if (!json.success || !json.data) throw new Error("bad payload");

      industryMapData = json.data; // expects shape { industries: { [industry]: { sectors: { [sector]: { industry_groups: { [group]: [tickers] } } } } } }
      populateIndustryDropdown();
    } catch (e) {
      console.error("industry map load failed", e);
      showError("Failed to load industry map.");
    }
  }

  function populateIndustryDropdown() {
    const industrySelect = $("industrySelect");
    industrySelect.innerHTML = `<option value="">Select Industry</option>`;
    const industries = Object.keys(industryMapData.industries || {}).sort();
    for (const name of industries) {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      industrySelect.appendChild(opt);
    }
    // reset dependents
    const sectorSelect = $("sectorSelect");
    const groupSelect = $("industryGroupSelect");
    sectorSelect.disabled = true;
    groupSelect.disabled = true;
    groupSelect.classList.add("bg-gray-100");
  }

  function updateSectorOptions() {
    const industry = $("industrySelect").value;
    const sectorSelect = $("sectorSelect");
    const groupSelect = $("industryGroupSelect");

    // reset
    sectorSelect.innerHTML = `<option value="">Select Sector</option>`;
    groupSelect.innerHTML = `<option value="">All Groups in Sector</option>`;
    groupSelect.disabled = true;
    groupSelect.classList.add("bg-gray-100");

    if (!industry) {
      sectorSelect.disabled = true;
      return;
    }
    sectorSelect.disabled = false;

    const sectors = Object.keys(industryMapData.industries[industry].sectors || {}).sort();
    for (const s of sectors) {
      const opt = document.createElement("option");
      opt.value = s;
      opt.textContent = s;
      sectorSelect.appendChild(opt);
    }
  }

  function updateIndustryGroupOptions() {
    const industry = $("industrySelect").value;
    const sector = $("sectorSelect").value;
    const groupSelect = $("industryGroupSelect");

    groupSelect.innerHTML = `<option value="">All Groups in Sector</option>`;

    if (!sector) {
      groupSelect.disabled = true;
      groupSelect.classList.add("bg-gray-100");
      return;
    }
    groupSelect.disabled = false;
    groupSelect.classList.remove("bg-gray-100");

    const groups = Object.keys(
      industryMapData.industries[industry].sectors[sector].industry_groups || {}
    ).sort();

    for (const g of groups) {
      const opt = document.createElement("option");
      opt.value = g;
      opt.textContent = g;
      groupSelect.appendChild(opt);
    }
  }

async function fetchIndustryComparison() {
  const industry = $("industrySelect").value;
  const sector = $("sectorSelect").value;
  const group = $("industryGroupSelect").value;
  if (!industry || !sector) {
    showError("Please select at least an industry and sector");
    return;
  }

  // Fetch tickers for selection
  const path = `${industry}/${sector}/${group || ""}`.replace(/\/$/, "");
  const tickersRes = await fetch(`${API_URL}/api/industry-tickers/${path}`);
  const tickersJson = await tickersRes.json();
  const tickers = tickersJson?.data?.tickers || [];
  if (!tickers.length) {
    showError("No tickers found");
    return;
  }

  // open modal for results
  openEmptyModal("Industry Comparison");
  $("modalBody").innerHTML = `<p class="text-gray-600 p-4">Loading ${tickers.length} companies...</p>`;

  const resp = await fetch(`${API_URL}/api/industry-comparison-stream`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ tickers }),
  });

  const reader = resp.body.getReader();
  const decoder = new TextDecoder();
  let buffer = "";

  $("modalBody").innerHTML = `
    <div class="overflow-x-auto">
      <table id="comparisonTable" class="min-w-full border border-gray-200 text-sm text-gray-800">
        <thead class="bg-gray-100 text-gray-700 font-semibold">
          <tr>
            <th class="text-left px-4 py-2">Ticker</th>
            <th class="text-left px-4 py-2">Company</th>
            <th class="text-right px-4 py-2">Revenue</th>
            <th class="text-right px-4 py-2">P/E</th>
            <th class="text-right px-4 py-2">P/S</th>
            <th class="text-right px-4 py-2">Market Cap</th>
          </tr>
        </thead>
        <tbody id="comparisonTableBody"></tbody>
      </table>
    </div>
  `;

  const tbody = $("comparisonTableBody");
  const missing = [];
  const validRows = [];

  // --- this replaces the old while loop entirely ---
  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    buffer += decoder.decode(value, { stream: true });
    const lines = buffer.split("\n");
    buffer = lines.pop();

    for (const line of lines) {
      if (!line.trim()) continue;
      const msg = JSON.parse(line);

      if (msg.type === "company") {
        const c = msg.data;
        validRows.push(c);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="px-4 py-2 text-blue-600">${c.ticker}</td>
          <td class="px-4 py-2 text-gray-700">${c.company_name || "—"}</td>
          <td class="px-4 py-2 text-right">${fmtNum(c.revenue)}</td>
          <td class="px-4 py-2 text-right">${c.pe?.toFixed(2) ?? "N/A"}</td>
          <td class="px-4 py-2 text-right">${c.ps?.toFixed(2) ?? "N/A"}</td>
          <td class="px-4 py-2 text-right">${fmtNum(c.market_cap)}</td>`;
        tbody.appendChild(tr);
      }

      if (msg.type === "skip") missing.push(msg.ticker);
    }
  }

  // --- after streaming completes ---
  if (validRows.length) {
    const avg = (key) =>
      validRows.reduce((a, b) => a + (Number(b[key]) || 0), 0) / validRows.length;

    const tr = document.createElement("tr");
    tr.className = "bg-gray-100 font-semibold border-t";
    tr.innerHTML = `
    <td class="px-4 py-2 text-gray-700" colspan="2">Average (${validRows.length})</td>
    <td class="px-4 py-2 text-right">${fmtNum(avg("revenue"))}</td>
    <td class="px-4 py-2 text-right">${avg("pe").toFixed(2)}</td>
    <td class="px-4 py-2 text-right">${avg("ps").toFixed(2)}</td>
    <td class="px-4 py-2 text-right">${fmtNum(avg("market_cap"))}</td>`;
    tbody.appendChild(tr);
  }

  if (missing.length) {
    const missHeader = document.createElement("tr");
    missHeader.innerHTML = `<td colspan="5" class="pt-6 pb-2 font-bold text-gray-700">Tickers with missing data</td>`;
    tbody.appendChild(missHeader);

    for (const t of missing) {
      const tr = document.createElement("tr");
      tr.className = "text-gray-400 italic";
      tr.innerHTML = `
        <td class="px-4 py-2">${t}</td>
        <td class="px-4 py-2 text-right" colspan="4">No data available</td>`;
      tbody.appendChild(tr);
    }
  }
}


</script>
<script>
  const API_KEY = "5f8e7ac4f6f8a3b6b2d91c66e01d0f7d1a91f4f4bfc1f3263e57b85c14f6a733";

const FOUNDERS_API = "https://monty-api-production.up.railway.app";

async function loadFounders(endpoint) {
  $("foundersLoading").classList.remove("hidden");
  $("foundersResults").classList.add("hidden");
  $("foundersScroll").innerHTML = "";

  try {
    // fetch the data first
    const res = await fetch(`${FOUNDERS_API}/${endpoint}`, {
      headers: {
        "x-api-key": "5f8e7ac4f6f8a3b6b2d91c66e01d0f7d1a91f4f4bfc1f3263e57b85c14f6a733"
      }
    });
    const json = await res.json();
    let data = json.data || [];

    // sort descending by access_date
    data.sort((a, b) => new Date(b.access_date) - new Date(a.access_date));

    $("foundersLoading").classList.add("hidden");
    $("foundersResults").classList.remove("hidden");

    if (!data.length) {
      $("foundersScroll").innerHTML = `<p class="text-gray-500 px-4">No data found.</p>`;
      return;
    }

    const scroll = $("foundersScroll");
    for (const row of data.slice(0, 50)) {
      const company = row.company_name || "Unknown";
      const treePath = row.tree_path || "—";
      const companyWebsite = row.company_website || "—";
      const profileUrl = row.profile_url || "—";
      const tags = (row.company_tags || "")
      .split(",")
      .map(t => t.trim())
      .filter(t => t && t.toLowerCase() !== "none");

      const card = document.createElement("div");
      card.className =
        "min-w-[250px] bg-gray-50 border border-gray-200 rounded-lg p-4 hover:shadow-md cursor-pointer flex flex-col justify-between";
      card.innerHTML = `
        <div>
          <h3 class="font-semibold text-brand text-lg truncate">${company}</h3>
          <p class="text-xs text-gray-500 mt-1">${treePath}</p>
        </div>
        ${tags.length
          ? `<div class="flex flex-wrap gap-1 mt-3">
              ${tags.map(t => `<span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full">${t}</span>`).join("")}
            </div>`
          : ""}
      `;

      // Add click handler to show detail modal
      card.addEventListener("click", () => openFounderModal(row));
      scroll.appendChild(card);
    }

  } catch (err) {
    $("foundersLoading").classList.add("hidden");
    console.error(err);
    $("foundersScroll").innerHTML = `<p class="text-red-500 px-4">Error loading data.</p>`;
  }
}
function openFounderModal(data) {
  const panel = $("founderDetailPanel");
  const title = $("founderDetailTitle");
  const body = $("founderDetailBody");

  title.textContent = data.company_name || "Founder Details";
  body.innerHTML = `
    <p><strong>Founder:</strong> ${data.name || "—"}</p>
    <p><strong>Company:</strong> ${data.company_name || "—"}</p>
    <p><strong>Description:</strong> ${data.product || "—"}</p>
    <p><strong>Location:</strong> ${data.location || "—"}</p>
    <p><strong>Access Date:</strong> ${data.access_date || "—"}</p>
    ${data.profile_url ? `<p><strong>LinkedIn:</strong> <a href="${data.profile_url}" target="_blank" class="text-blue-600 underline">View Profile</a></p>` : ""}
    ${data.company_website ? `<p><strong>Website:</strong> <a href="${data.company_website}" target="_blank" class="text-blue-600 underline">Visit Site</a></p>` : ""}
  `;

  panel.classList.remove("hidden");
}
function toggleSearchPanel() {
  const panel = $("searchPanel");
  panel.classList.toggle("hidden");
}

// Search and reuse loadFounders-style rendering
async function searchFounders() {
  // clear previous
  $("foundersLoading").classList.remove("hidden");
  $("searchResults").classList.add("hidden");
  $("searchScroll").innerHTML = "";

  const keyword = $("searchKeyword").value.trim();
  const location = $("searchLocation").value.trim();
  const tree_path_prefix = getSearchSelectedTreePath();
  const tag = $("searchTag")?.value.trim() || "";

  const query = new URLSearchParams();
  if (keyword) query.append("keyword", keyword);
  if (location) query.append("location", location);
  if (tree_path_prefix) query.append("tree_path_prefix", tree_path_prefix);
  if (tag) query.append("tag", tag);

  try {
    const res = await fetch(`${FOUNDERS_API}/search?${query.toString()}`, {
      headers: { "x-api-key": API_KEY }
    });
    const json = await res.json();
    const data = json.data || [];

    $("foundersLoading").classList.add("hidden");

    if (!data.length) {
      $("searchResults").classList.remove("hidden");
      $("searchScroll").innerHTML = `<p class="text-gray-500 px-4">No results found.</p>`;
      return;
    }

    const scroll = $("searchScroll");
    for (const row of data.slice(0, 50)) {
      const company = row.company_name || "Unknown";
      const treePath = row.tree_path || "—";
      const tags = (row.company_tags || "")
        .split(",")
        .map(t => t.trim())
        .filter(t => t && t.toLowerCase() !== "none");

      const card = document.createElement("div");
      card.className =
        "min-w-[250px] bg-gray-50 border border-gray-200 rounded-lg p-4 hover:shadow-md cursor-pointer flex flex-col justify-between";
      card.innerHTML = `
        <div>
          <h3 class="font-semibold text-brand text-lg truncate">${company}</h3>
          <p class="text-xs text-gray-500 mt-1">${treePath}</p>
        </div>
        ${
          tags.length
            ? `<div class="flex flex-wrap gap-1 mt-3">
                ${tags.map(t => `<span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full">${t}</span>`).join("")}
              </div>`
            : ""
        }
      `;
      card.addEventListener("click", () => openFounderModal(row));
      scroll.appendChild(card);
    }

    $("searchResults").classList.remove("hidden");
  } catch (err) {
    console.error(err);
    $("foundersLoading").classList.add("hidden");
    $("searchResults").classList.remove("hidden");
    $("searchScroll").innerHTML = `<p class="text-red-500 px-4">Search failed.</p>`;
  }
}

function populateSelect(selectEl, items) {
  if (!selectEl) return;
  // Only append if we're still at the initial "All ..." option
  if (selectEl.options.length > 1) return;

  const uniqueSorted = [...new Set(items.filter(Boolean))]
    .sort((a, b) => a.localeCompare(b));

  const frag = document.createDocumentFragment();
  for (const v of uniqueSorted) {
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v;
    frag.appendChild(opt);
  }
  selectEl.appendChild(frag);
}
function expandTreePrefixes(treePaths) {
  const prefixes = new Set();
  for (const path of treePaths) {
    const parts = path.split(" > ");
    for (let i = 1; i <= parts.length; i++) {
      prefixes.add(parts.slice(0, i).join(" > "));
    }
  }
  return Array.from(prefixes).sort();
}

async function loadFilters() {
  try {
    const res = await fetch(`${FOUNDERS_API}/filters`, {
      headers: { "x-api-key": API_KEY }
    });
    const json = await res.json();
    const locations = json.locations || [];
    const treePaths = json.tree_paths || [];

    populateSelect($("searchLocation"), locations);
    buildTreeHierarchy(treePaths);
    populateTreeLevel1(); // for recommended
    populateSearchTreeLevel1(); // for search
  } catch (e) {
    console.error("Failed to load filters", e);
  }
}
function populateSearchTreeLevel1() {
  const allowedTopLevels = ["AI", "Fintech", "Healthcare", "Commerce", "Other"];
  const l1Sel = $("searchTreeLevel1");
  l1Sel.innerHTML = "<option value=''>All Top Categories</option>";

  const validKeys = Object.keys(treeHierarchy)
    .filter(k => allowedTopLevels.includes(k));

  for (const k of validKeys.sort()) {
    const opt = document.createElement("option");
    opt.value = k;
    opt.textContent = k;
    l1Sel.appendChild(opt);
  }

  $("searchTreeLevel2").disabled = true;
  $("searchTreeLevel3").disabled = true;
}



function buildTreeHierarchy(treePaths) {
  treeHierarchy = {};
  for (const path of treePaths) {
    const parts = path.split(" > ");
    parts.reduce((acc, part) => acc[part] ||= {}, treeHierarchy);
  }
}

function populateTreeLevel1() {
  const allowedTopLevels = ["AI", "Fintech", "Healthcare", "Commerce", "Other"];
  const l1Sel = $("treeLevel1");
  l1Sel.innerHTML = "<option value=''>All Top Categories</option>";

  const validKeys = Object.keys(treeHierarchy)
    .filter(k => allowedTopLevels.includes(k));

  for (const k of validKeys.sort()) {
    const opt = document.createElement("option");
    opt.value = k;
    opt.textContent = k;
    l1Sel.appendChild(opt);
  }

  $("treeLevel2").disabled = true;
  $("treeLevel3").disabled = true;
}


function updateTreeLevel2() {
  const l1 = $("treeLevel1").value;
  const l2Sel = $("treeLevel2");
  const l3Sel = $("treeLevel3");
  const l2Container = $("treeLevel2Container");
  const l3Container = $("treeLevel3Container");

  // reset
  l2Sel.innerHTML = "<option value=''>All Subcategories</option>";
  l3Sel.innerHTML = "<option value=''>All Sub-Subcategories</option>";
  l3Sel.disabled = true;
  l3Container.classList.add("hidden");

  if (!l1) {
    l2Sel.disabled = true;
    l2Container.classList.add("hidden");
    return;
  }

  const subs = Object.keys(treeHierarchy[l1] || {});
  l2Sel.disabled = !subs.length;
  l2Container.classList.toggle("hidden", !subs.length);

  for (const s of subs.sort()) {
    const opt = document.createElement("option");
    opt.value = s;
    opt.textContent = s;
    l2Sel.appendChild(opt);
  }
}

function updateTreeLevel3() {
  const l1 = $("treeLevel1").value;
  const l2 = $("treeLevel2").value;
  const l3Sel = $("treeLevel3");
  const l3Container = $("treeLevel3Container");

  l3Sel.innerHTML = "<option value=''>All Sub-Subcategories</option>";

  if (!l2) {
    l3Sel.disabled = true;
    l3Container.classList.add("hidden");
    return;
  }

  const subs = Object.keys(treeHierarchy[l1]?.[l2] || {});
  l3Sel.disabled = !subs.length;
  l3Container.classList.toggle("hidden", !subs.length);

  for (const s of subs.sort()) {
    const opt = document.createElement("option");
    opt.value = s;
    opt.textContent = s;
    l3Sel.appendChild(opt);
  }
}

function updateSearchTreeLevel2() {
  const l1 = $("searchTreeLevel1").value;
  const l2Sel = $("searchTreeLevel2");
  const l3Sel = $("searchTreeLevel3");
  const l2Container = $("searchTreeLevel2Container");
  const l3Container = $("searchTreeLevel3Container");

  // reset
  l2Sel.innerHTML = "<option value=''>All Subcategories</option>";
  l3Sel.innerHTML = "<option value=''>All Sub-Subcategories</option>";
  l3Sel.disabled = true;
  l3Container.classList.add("hidden");

  if (!l1) {
    l2Sel.disabled = true;
    l2Container.classList.add("hidden");
    return;
  }

  const subs = Object.keys(treeHierarchy[l1] || {});
  l2Sel.disabled = !subs.length;
  l2Container.classList.toggle("hidden", !subs.length);

  for (const s of subs.sort()) {
    const opt = document.createElement("option");
    opt.value = s;
    opt.textContent = s;
    l2Sel.appendChild(opt);
  }
}

function updateSearchTreeLevel3() {
  const l1 = $("searchTreeLevel1").value;
  const l2 = $("searchTreeLevel2").value;
  const l3Sel = $("searchTreeLevel3");
  const l3Container = $("searchTreeLevel3Container");

  l3Sel.innerHTML = "<option value=''>All Sub-Subcategories</option>";

  if (!l2) {
    l3Sel.disabled = true;
    l3Container.classList.add("hidden");
    return;
  }

  const subs = Object.keys(treeHierarchy[l1]?.[l2] || {});
  l3Sel.disabled = !subs.length;
  l3Container.classList.toggle("hidden", !subs.length);

  for (const s of subs.sort()) {
    const opt = document.createElement("option");
    opt.value = s;
    opt.textContent = s;
    l3Sel.appendChild(opt);
  }
}

function getSearchSelectedTreePath() {
  const parts = [
    $("searchTreeLevel1").value,
    $("searchTreeLevel2").value,
    $("searchTreeLevel3").value
  ].filter(Boolean);
  return parts.join(" > ");
}


function getSelectedTreePath() {
  const parts = [
    $("treeLevel1").value,
    $("treeLevel2").value,
    $("treeLevel3").value
  ].filter(Boolean);
  return parts.join(" > ");
}

async function loadRecommendedFiltered() {
  const treePath = getSelectedTreePath();

  $("foundersLoading").classList.remove("hidden");
  $("recommendedResults").classList.add("hidden");
  $("recommendedScroll").innerHTML = "";

  try {
    const query = treePath ? `?tree_path_prefix=${encodeURIComponent(treePath)}` : "";
    const res = await fetch(`${FOUNDERS_API}/recommended-founders${query}`, {
      headers: { "x-api-key": API_KEY }
    });
    const json = await res.json();
    const data = json.data || [];

    $("foundersLoading").classList.add("hidden");

    if (!data.length) {
      $("recommendedResults").classList.remove("hidden");
      $("recommendedScroll").innerHTML = `<p class="text-gray-500 px-4">No results found.</p>`;
      return;
    }

    const scroll = $("recommendedScroll");
    for (const row of data.slice(0, 50)) {
      const company = row.company_name || "Unknown";
      const treePath = row.tree_path || "—";
      const tags = (row.company_tags || "")
        .split(",")
        .map(t => t.trim())
        .filter(t => t && t.toLowerCase() !== "none");

      const card = document.createElement("div");
      card.className =
        "min-w-[250px] bg-gray-50 border border-gray-200 rounded-lg p-4 hover:shadow-md cursor-pointer flex flex-col justify-between";
      card.innerHTML = `
        <div>
          <h3 class="font-semibold text-brand text-lg truncate">${company}</h3>
          <p class="text-xs text-gray-500 mt-1">${treePath}</p>
        </div>
        ${tags.length
          ? `<div class="flex flex-wrap gap-1 mt-3">
              ${tags.map(t => `<span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full">${t}</span>`).join("")}
            </div>`
          : ""}
      `;
      card.addEventListener("click", () => openFounderModal(row));
      scroll.appendChild(card);
    }

    $("recommendedResults").classList.remove("hidden");
  } catch (err) {
    console.error(err);
    $("foundersLoading").classList.add("hidden");
    $("recommendedScroll").innerHTML = `<p class="text-red-500 px-4">Error loading data.</p>`;
  }
}

function showTab(tab) {
  const recommendedBtn = $("recommendedTab");
  const searchBtn = $("searchTab");

  // Reset all tab styles
  [recommendedBtn, searchBtn].forEach(btn => {
    btn.classList.remove("active");
    btn.classList.remove("border-blue-700", "text-blue-700");
    btn.classList.add("border-transparent", "text-gray-600");
  });

  // Set active tab
  const activeBtn = tab === "recommended" ? recommendedBtn : searchBtn;
  activeBtn.classList.add("active", "border-blue-700", "text-blue-700");
  activeBtn.classList.remove("border-transparent", "text-gray-600");

  // Show correct panels
  $("treePathFilters").classList.add("hidden");
  $("searchPanel")?.classList.add("hidden");
  $("recommendedResults").classList.add("hidden");
  $("searchResults").classList.add("hidden");

  if (tab === "recommended") {
    $("treePathFilters").classList.remove("hidden");
    $("recommendedResults").classList.remove("hidden");
    if ($("recommendedScroll").children.length === 0) loadRecommendedFiltered();
  } else {
    $("searchPanel")?.classList.remove("hidden");
    const hasResults = $("searchScroll").children.length > 0;
    $("searchResults").classList.toggle("hidden", !hasResults);
  }
}

</script>


</body>
</html>
