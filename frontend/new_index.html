<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Valuation Tool</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .btn-primary { background-color:#161f6d; }
    .btn-primary:hover { background-color:#0f1751; }
    .text-brand { color:#131f72; }
    th, td { white-space: nowrap; }
    table { border-collapse: collapse; width: 100%; }
    th { font-weight: 600; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center py-12 px-4">
  <div class="bg-white rounded-xl shadow-lg w-full max-w-lg p-6 space-y-6">
    <h1 class="text-2xl font-bold text-brand text-center">Valuation Tool</h1>

    <div class="flex gap-2">
      <input id="tickerInput" type="text" placeholder="Enter ticker (e.g. AAPL)"
        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
        onkeypress="if(event.key==='Enter') fetchData()" />
      <button onclick="fetchData()" class="btn-primary text-white px-4 py-2 rounded-lg font-semibold">Search</button>
    </div>

    <div id="loading" class="hidden text-center py-4">
      <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
      <p class="text-sm text-gray-600 mt-2">Loading...</p>
    </div>

    <div id="errorBox" class="hidden bg-red-50 border border-red-200 text-red-700 text-sm rounded-lg p-3"></div>

    <div id="results" class="hidden space-y-4">
      <div class="flex items-center justify-between">
        <h2 id="companyHeader" class="text-lg font-bold text-brand"></h2>
        <p id="stockPrice" class="text-xl font-semibold text-green-600"></p>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div class="bg-gray-50 p-3 rounded-lg"><p class="text-xs text-gray-500">Revenue</p><p id="revenue" class="font-semibold text-gray-800">—</p></div>
        <div class="bg-gray-50 p-3 rounded-lg"><p class="text-xs text-gray-500">P/E</p><p id="pe" class="font-semibold text-gray-800">—</p></div>
        <div class="bg-gray-50 p-3 rounded-lg"><p class="text-xs text-gray-500">P/S</p><p id="ps" class="font-semibold text-gray-800">—</p></div>
        <div class="bg-gray-50 p-3 rounded-lg"><p class="text-xs text-gray-500">Market Cap</p><p id="marketCap" class="font-semibold text-gray-800">—</p></div>
      </div>

      <button onclick="openModal()" class="w-full text-sm mt-2 py-2 rounded-lg border border-gray-300 hover:bg-gray-100">
        View Full Income Statement →
      </button>
    </div>
    <!-- Industry picker -->
    <div id="industryPicker" class="bg-white rounded-xl shadow-lg w-full max-w-lg p-6 space-y-5 mt-6">
    <h2 class="text-lg font-bold text-brand">Industry Comparison Setup</h2>

    <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Select Industry</label>
        <select id="industrySelect"
                onchange="updateSectorOptions()"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        <option value="">-- Select Industry --</option>
        </select>
    </div>

    <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Select Sector</label>
        <select id="sectorSelect"
                onchange="updateIndustryGroupOptions()"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                disabled>
        <option value="">-- Select Sector --</option>
        </select>
    </div>

    <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Select Industry Group (optional)</label>
        <select id="industryGroupSelect"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-gray-100"
                disabled>
        <option value="">-- All Groups in Sector --</option>
        </select>
    </div>

    <!-- Disabled action for now -->
    <button type="button"
            onclick="fetchIndustryComparison()"
            class="w-full btn-primary text-white py-3 px-6 rounded-lg font-semibold">
        Compare Companies
    </button>

    </div>

  </div>

  <div id="modalOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center" onclick="closeModal()"></div>
  <div id="modal" class="hidden fixed inset-8 bg-white rounded-xl shadow-2xl z-50 overflow-auto p-6">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-brand">Income Statement</h2>
        <button onclick="closeModal()" class="text-2xl leading-none text-gray-700">×</button>
    </div>
    <div id="modalBody"></div>
    </div>


  <script>
    const API_URL = "";
    const $ = (id) => document.getElementById(id);

    function fmtNum(v) {
      if (v == null || isNaN(v)) return "N/A";
      if (Math.abs(v) >= 1e9) return `$${(v / 1e9).toFixed(2)}B`;
      if (Math.abs(v) >= 1e6) return `$${(v / 1e6).toFixed(2)}M`;
      if (Math.abs(v) >= 1e3) return `$${(v / 1e3).toFixed(2)}K`;
      return `$${v.toFixed(2)}`;
    }

    async function fetchData() {
        const ticker = $("tickerInput").value.trim().toUpperCase();
        if (!ticker) return showError("Enter a ticker symbol.");
        hideError(); $("results").classList.add("hidden"); $("loading").classList.remove("hidden");

        try {
            async function safeFetchJSON(url) {
            const res = await fetch(url);
            const text = await res.text();
            const cleanText = text
                .replace(/\b-?Infinity\b/g, "null") // handles Infinity and -Infinity
                .replace(/\bNaN\b/g, "null");
            return JSON.parse(cleanText);
            }

            const [finRes, incRes, priceRes, valRes] = await Promise.all([
            safeFetchJSON(`${API_URL}/api/financials/${ticker}`),
            safeFetchJSON(`${API_URL}/api/income/${ticker}`),
            safeFetchJSON(`${API_URL}/api/stock-price/${ticker}`),
            safeFetchJSON(`${API_URL}/api/valuation/${ticker}`),
            ]);

            $("loading").classList.add("hidden");

            if (!finRes.success || !priceRes.success || !valRes.success) {
            return showError("Unable to retrieve data for this ticker.");
            }

            $("companyHeader").textContent = ticker;
            $("stockPrice").textContent = priceRes.data?.price ? `$${priceRes.data.price.toFixed(2)}` : "N/A";
            $("revenue").textContent = fmtNum(finRes.data?.revenue);
            $("pe").textContent = valRes.data?.pe ? valRes.data.pe.toFixed(2) : "N/A";
            $("ps").textContent = valRes.data?.ps ? valRes.data.ps.toFixed(2) : "N/A";
            $("marketCap").textContent = fmtNum(valRes.data?.market_cap);

            if (incRes?.success) {
            window.latestIncome = incRes.data?.income_statement || null;
            window.fullFinancials = incRes.data || null;
            } else {
            window.latestIncome = null;
            window.fullFinancials = null;
            }

            $("results").classList.remove("hidden");
        } catch (err) {
            console.error(err);
            showError("Failed to connect to backend.");
            $("loading").classList.add("hidden");
        }
        }

    function showError(msg){$("errorBox").textContent=msg;$("errorBox").classList.remove("hidden");}
    function hideError(){$("errorBox").classList.add("hidden");}

    // Helper: find all period keys and sort newest → oldest
    function extractPeriods(statement) {
        return Object.keys(statement)
        .filter(k => /^\d{4}-\d{2}(-\d{2})?$/.test(k))
        .sort((a, b) => b.localeCompare(a));
    }

    // Helper: normalize a date key to YYYY-MM for mapping
    const norm = (s) => (s || "").slice(0, 7);

    // Heuristic formatting (reuses your fmtNum for currency-like values)
    function formatCell(label, v) {
        if (v === null || v === undefined || !isFinite(v)) return "N/A";
        const lower = (label || "").toLowerCase();
        if (lower.includes("earnings per share")) return v.toFixed(2);
        if (lower.includes("shares")) {
        const abs = Math.abs(v);
        if (abs >= 1e9) return (v / 1e9).toFixed(2) + "B";
        if (abs >= 1e6) return (v / 1e6).toFixed(2) + "M";
        return v.toLocaleString("en-US", { maximumFractionDigits: 0 });
        }
        return fmtNum(v); // your existing formatter
    }
    function openEmptyModal(title = "Results") {
        $("modalBody").innerHTML = "";
        $("modalOverlay").classList.remove("hidden");
        $("modal").classList.remove("hidden");
        document.querySelector("#modal h2").textContent = title;
        }

    function openModal() {
        const full = window.fullFinancials || null;
        const income = full?.income_statement || null;
        const meta = full?.filing_metadata || [];

        if (!income || !income.label) {
            $("modalBody").innerHTML =
            `<div class="p-6 text-center text-gray-500">No income data</div>`;
            $("modalOverlay").classList.remove("hidden");
            $("modal").classList.remove("hidden");
            return;
        }

        // Helpers
        const periods = Object.keys(income)
            .filter(k => /^\d{4}-\d{2}(-\d{2})?$/.test(k))
            .sort((a,b) => b.localeCompare(a)); // newest → left
        const labelsMap = income.label || {};
        const labelIdxs = Object.keys(labelsMap).sort((a,b)=>Number(a)-Number(b));
        const norm = s => (s || "").slice(0,7);
        const metaByPeriod = {};
        meta.forEach(m => metaByPeriod[norm(m.period_end)] = m);

        // Build table shell
        const body = $("modalBody");
        if (!body) { console.error("Missing #modalBody"); return; }
        body.innerHTML = `
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="px-6 py-4 bg-gray-50 border-b border-gray-200 flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-800">Income Statement</h3>
                <div class="text-xs text-gray-500">Periods: ${periods.join(" • ")}</div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                <thead class="bg-gray-100 border-b border-gray-200" id="incomeThead"></thead>
                <tbody class="divide-y divide-gray-200" id="incomeTable"></tbody>
                </table>
            </div>
            </div>
        `;

        // Header row
        const thead = $("incomeThead");
        thead.innerHTML = `
            <tr>
            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700 sticky left-0 bg-gray-100 z-10">Line Item</th>
            ${periods.map(p => {
                const m = metaByPeriod[norm(p)];
                const type = m?.type || "—";
                const pe = m?.period_end || p;
                return `
                <th class="px-6 py-3 text-right text-sm font-semibold text-gray-700">
                    <div class="flex flex-col items-end">
                    <span class="inline-block text-xs px-2 py-0.5 rounded bg-gray-200 text-gray-700">${type}</span>
                    <span class="text-xs text-gray-500 mt-1">${pe}</span>
                    </div>
                </th>`;
            }).join("")}
            </tr>
        `;

        // Body rows
        const tbody = $("incomeTable");
        labelIdxs.forEach(idx => {
            const label = labelsMap[idx];
            const tr = document.createElement("tr");
            tr.className = "hover:bg-gray-50";

            // sticky label
            const th = document.createElement("td");
            th.className = "px-6 py-3 text-sm text-gray-800 sticky left-0 bg-white z-10";
            th.textContent = label;
            tr.appendChild(th);

            // cells per period
            periods.forEach(p => {
            const rowVals = income[p] || {};
            const v = Object.prototype.hasOwnProperty.call(rowVals, idx) ? rowVals[idx] : null;
            const td = document.createElement("td");
            td.className = "px-6 py-3 text-sm text-gray-800 text-right";
            td.textContent = formatCell(label, v);
            tr.appendChild(td);
            });

            tbody.appendChild(tr);
        });

        $("modalOverlay").classList.remove("hidden");
        $("modal").classList.remove("hidden");

        // simple formatter that reuses your fmtNum for currency-like values
        function formatCell(label, v) {
            if (v === null || v === undefined || !isFinite(v)) return "N/A";
            const lower = (label || "").toLowerCase();
            if (lower.includes("earnings per share")) return Number(v).toFixed(2);
            if (lower.includes("shares")) {
            const n = Number(v);
            const abs = Math.abs(n);
            if (abs >= 1e9) return (n/1e9).toFixed(2) + "B";
            if (abs >= 1e6) return (n/1e6).toFixed(2) + "M";
            return n.toLocaleString("en-US", { maximumFractionDigits: 0 });
            }
            return fmtNum(Number(v));
        }
        }

        function closeModal() {
        $("modalOverlay").classList.add("hidden");
        $("modal").classList.add("hidden");
        }

  </script>
  <script>
  // In-memory map
  let industryMapData = null;

  // Load map on page load
  document.addEventListener("DOMContentLoaded", () => {
    loadIndustryMap();
  });

  async function loadIndustryMap() {
    try {
      // try API first, then fall back to static file if you serve one
      const res = await fetch(`${API_URL || ""}/api/industry-map`);
      const json = await res.json();
      if (!json.success || !json.data) throw new Error("bad payload");

      industryMapData = json.data; // expects shape { industries: { [industry]: { sectors: { [sector]: { industry_groups: { [group]: [tickers] } } } } } }
      populateIndustryDropdown();
    } catch (e) {
      console.error("industry map load failed", e);
      showError("Failed to load industry map.");
    }
  }

  function populateIndustryDropdown() {
    const industrySelect = $("industrySelect");
    industrySelect.innerHTML = `<option value="">Select Industry</option>`;
    const industries = Object.keys(industryMapData.industries || {}).sort();
    for (const name of industries) {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      industrySelect.appendChild(opt);
    }
    // reset dependents
    const sectorSelect = $("sectorSelect");
    const groupSelect = $("industryGroupSelect");
    sectorSelect.disabled = true;
    groupSelect.disabled = true;
    groupSelect.classList.add("bg-gray-100");
  }

  function updateSectorOptions() {
    const industry = $("industrySelect").value;
    const sectorSelect = $("sectorSelect");
    const groupSelect = $("industryGroupSelect");

    // reset
    sectorSelect.innerHTML = `<option value="">Select Sector</option>`;
    groupSelect.innerHTML = `<option value="">All Groups in Sector</option>`;
    groupSelect.disabled = true;
    groupSelect.classList.add("bg-gray-100");

    if (!industry) {
      sectorSelect.disabled = true;
      return;
    }
    sectorSelect.disabled = false;

    const sectors = Object.keys(industryMapData.industries[industry].sectors || {}).sort();
    for (const s of sectors) {
      const opt = document.createElement("option");
      opt.value = s;
      opt.textContent = s;
      sectorSelect.appendChild(opt);
    }
  }

  function updateIndustryGroupOptions() {
    const industry = $("industrySelect").value;
    const sector = $("sectorSelect").value;
    const groupSelect = $("industryGroupSelect");

    groupSelect.innerHTML = `<option value="">All Groups in Sector</option>`;

    if (!sector) {
      groupSelect.disabled = true;
      groupSelect.classList.add("bg-gray-100");
      return;
    }
    groupSelect.disabled = false;
    groupSelect.classList.remove("bg-gray-100");

    const groups = Object.keys(
      industryMapData.industries[industry].sectors[sector].industry_groups || {}
    ).sort();

    for (const g of groups) {
      const opt = document.createElement("option");
      opt.value = g;
      opt.textContent = g;
      groupSelect.appendChild(opt);
    }
  }

async function fetchIndustryComparison() {
  const industry = $("industrySelect").value;
  const sector = $("sectorSelect").value;
  const group = $("industryGroupSelect").value;
  if (!industry || !sector) {
    showError("Please select at least an industry and sector");
    return;
  }

  // Fetch tickers for selection
  const path = `${industry}/${sector}/${group || ""}`.replace(/\/$/, "");
  const tickersRes = await fetch(`${API_URL}/api/industry-tickers/${path}`);
  const tickersJson = await tickersRes.json();
  const tickers = tickersJson?.data?.tickers || [];
  if (!tickers.length) {
    showError("No tickers found");
    return;
  }

  // open modal for results
  openEmptyModal("Industry Comparison");
  $("modalBody").innerHTML = `<p class="text-gray-600 p-4">Loading ${tickers.length} companies...</p>`;

  const resp = await fetch(`${API_URL}/api/industry-comparison-stream`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ tickers }),
  });

  const reader = resp.body.getReader();
  const decoder = new TextDecoder();
  let buffer = "";

  $("modalBody").innerHTML = `
    <div class="overflow-x-auto">
      <table id="comparisonTable" class="min-w-full border border-gray-200 text-sm text-gray-800">
        <thead class="bg-gray-100 text-gray-700 font-semibold">
          <tr>
            <th class="text-left px-4 py-2">Ticker</th>
            <th class="text-left px-4 py-2">Company</th>
            <th class="text-right px-4 py-2">Revenue</th>
            <th class="text-right px-4 py-2">P/E</th>
            <th class="text-right px-4 py-2">P/S</th>
            <th class="text-right px-4 py-2">Market Cap</th>
          </tr>
        </thead>
        <tbody id="comparisonTableBody"></tbody>
      </table>
    </div>
  `;

  const tbody = $("comparisonTableBody");
  const missing = [];
  const validRows = [];

  // --- this replaces the old while loop entirely ---
  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    buffer += decoder.decode(value, { stream: true });
    const lines = buffer.split("\n");
    buffer = lines.pop();

    for (const line of lines) {
      if (!line.trim()) continue;
      const msg = JSON.parse(line);

      if (msg.type === "company") {
        const c = msg.data;
        validRows.push(c);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="px-4 py-2 text-blue-600">${c.ticker}</td>
          <td class="px-4 py-2 text-gray-700">${c.company_name || "—"}</td>
          <td class="px-4 py-2 text-right">${fmtNum(c.revenue)}</td>
          <td class="px-4 py-2 text-right">${c.pe?.toFixed(2) ?? "N/A"}</td>
          <td class="px-4 py-2 text-right">${c.ps?.toFixed(2) ?? "N/A"}</td>
          <td class="px-4 py-2 text-right">${fmtNum(c.market_cap)}</td>`;
        tbody.appendChild(tr);
      }

      if (msg.type === "skip") missing.push(msg.ticker);
    }
  }

  // --- after streaming completes ---
  if (validRows.length) {
    const avg = (key) =>
      validRows.reduce((a, b) => a + (Number(b[key]) || 0), 0) / validRows.length;

    const tr = document.createElement("tr");
    tr.className = "bg-gray-100 font-semibold border-t";
    tr.innerHTML = `
    <td class="px-4 py-2 text-gray-700" colspan="2">Average (${validRows.length})</td>
    <td class="px-4 py-2 text-right">${fmtNum(avg("revenue"))}</td>
    <td class="px-4 py-2 text-right">${avg("pe").toFixed(2)}</td>
    <td class="px-4 py-2 text-right">${avg("ps").toFixed(2)}</td>
    <td class="px-4 py-2 text-right">${fmtNum(avg("market_cap"))}</td>`;
    tbody.appendChild(tr);
  }

  if (missing.length) {
    const missHeader = document.createElement("tr");
    missHeader.innerHTML = `<td colspan="5" class="pt-6 pb-2 font-bold text-gray-700">Tickers with missing data</td>`;
    tbody.appendChild(missHeader);

    for (const t of missing) {
      const tr = document.createElement("tr");
      tr.className = "text-gray-400 italic";
      tr.innerHTML = `
        <td class="px-4 py-2">${t}</td>
        <td class="px-4 py-2 text-right" colspan="4">No data available</td>`;
      tbody.appendChild(tr);
    }
  }
}


</script>

</body>
</html>
