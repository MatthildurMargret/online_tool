<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Valuation Tool</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .btn-primary { background-color:#161f6d; }
    .btn-primary:hover { background-color:#0f1751; }
    .text-brand { color:#131f72; }
    th, td { white-space: nowrap; }
    table { border-collapse: collapse; width: 100%; }
    th { font-weight: 600; }
    #foundersScroll::-webkit-scrollbar { height: 8px; }
    #foundersScroll::-webkit-scrollbar-thumb {
      background-color: #cbd5e1; border-radius: 4px;
    }
    #searchResults.hidden,
    #recommendedResults.hidden {
      display: none !important;
    }
    .tab-btn {
      transition: all 0.25s ease;
    }

    .tab-btn:hover {
      color: #161f6d; /* your brand color */
    }

    .tab-btn.active {
      border-color: #161f6d;
      color: #161f6d;
    }

    .hero-title {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
      letter-spacing: 0.02em;
      font-weight: 400;
    }

    .hero-title-line1 {
      font-size: 1.25rem;
      font-weight: 400;
      font-style: normal;
      opacity: 0.8;
    }

    @media (min-width: 640px) {
      .hero-title-line1 {
        font-size: 1.75rem;
      }
    }

    .hero-title-line2 {
      font-size: 1.75rem;
      font-weight: 500;
      font-style: normal;
      line-height: 1.3;
    }

    @media (min-width: 640px) {
      .hero-title-line2 {
        font-size: 2.5rem;
      }
    }

    /* Sidebar styling */
    .sidebar-btn {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
      font-weight: 300;
      font-size: 0.95rem;
      letter-spacing: 0.02em;
      transition: all 0.2s ease;
      color: rgba(255, 255, 255, 0.85);
    }

    .sidebar-btn:hover {
      color: rgba(255, 255, 255, 1);
      background-color: rgba(255, 255, 255, 0.1);
    }

    .sidebar-btn.bg-blue-700 {
      background-color: rgba(255, 255, 255, 0.15);
      color: rgba(255, 255, 255, 1);
      font-weight: 400;
    }

    /* Module card styling */
    .module-card {
      background: linear-gradient(to bottom, #ffffff, #fafbfc);
      border: 1px solid rgba(226, 232, 240, 0.8);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
      transition: all 0.3s ease;
    }

    .module-card:hover {
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
      transform: translateY(-2px);
    }

    .module-title {
      font-weight: 600;
      letter-spacing: -0.01em;
    }

    /* Mobile sidebar styles */
    .sidebar-mobile-overlay {
      display: none;
    }

    .sidebar-container {
      position: relative;
      height: 100%;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .sidebar-container aside {
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    @media (max-width: 768px) {
      .sidebar-mobile-overlay {
        position: fixed;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 40;
        display: none;
      }
      
      .sidebar-mobile-overlay.active {
        display: block;
      }
      
      .sidebar-container {
        position: fixed;
        left: 0;
        top: 0;
        bottom: 0;
        width: 16rem;
        height: 100vh;
        z-index: 50;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
      }
      
      .sidebar-container.active {
        transform: translateX(0);
      }
    }

    /* Hamburger menu button */
    .hamburger-btn {
      display: none;
      position: fixed;
      top: 1rem;
      left: 1rem;
      z-index: 60;
      background-color: #161F6D;
      color: white;
      border: none;
      padding: 0.75rem;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .hamburger-btn:hover {
      background-color: #0f1751;
    }

    @media (max-width: 768px) {
      .hamburger-btn {
        display: block;
      }
    }

    /* Responsive hero section height */
    .hero-section-height {
      min-height: 30vh;
    }

    @media (min-width: 768px) {
      .hero-section-height {
        min-height: 40vh;
      }
    }

    </style>
</head>
<body class="h-screen flex overflow-hidden" style="background: linear-gradient(to bottom right, #F9FAFF, #E3F1FF, #E3F1FF);">
  <!-- Hamburger Menu Button (Mobile Only) -->
  <button id="hamburgerBtn" class="hamburger-btn" onclick="toggleSidebar()" aria-label="Toggle menu">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
    </svg>
  </button>

  <!-- Mobile Overlay -->
  <div id="sidebarOverlay" class="sidebar-mobile-overlay" onclick="toggleSidebar()"></div>

  <!-- Sidebar Container -->
  <div class="sidebar-container">
    <aside class="w-64 text-white p-6 flex flex-col gap-3" style="background-color: #161F6D;">
    <div class="mb-6 pl-3 flex items-center justify-between">
      <img src="montage_logo.png" alt="Monty Logo" class="h-12 object-contain cursor-pointer hover:opacity-80 transition-opacity" onclick="showModule('welcomeModule')">
      <button onclick="toggleSidebar()" class="md:hidden text-white hover:text-gray-200 p-2" aria-label="Close menu">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <button id="btn-welcomeModule"
        class="sidebar-btn text-left py-3 px-4 rounded"
        onclick="showModule('welcomeModule')">
  Home
</button>

    <button id="btn-foundersModule"
            class="sidebar-btn text-left py-3 px-4 rounded"
            onclick="showModule('foundersModule')">
      Monty's Sourcing
    </button>
    <button id="btn-dealsModule"
            class="sidebar-btn text-left py-3 px-4 rounded"
            onclick="showModule('dealsModule')">
      Deals
    </button>
    <button id="btn-interestingPeopleModule"
            class="sidebar-btn text-left py-3 px-4 rounded"
            onclick="showModule('interestingPeopleModule')">
      Interesting People
    </button>
    <button id="btn-prospectingModule"
            class="sidebar-btn text-left py-3 px-4 rounded"
            onclick="showModule('prospectingModule')">
      Prospecting
    </button>
    <button id="btn-valuationModule"
            class="sidebar-btn text-left py-3 px-4 rounded"
            onclick="showModule('valuationModule')">
      Public Markets
    </button>
  </aside>
  </div>

  <!-- Main content area -->
  <main class="flex-1 p-4 sm:p-6 md:p-8 overflow-y-auto">
    <!-- Welcome page (default) -->
<div id="welcomeModule" class="space-y-10">
  <!-- Hero Section -->
  <div class="w-full flex items-center justify-start pl-4 sm:pl-6 md:pl-8 hero-section-height">
    <div class="hero-title text-brand">
      <div class="hero-title-line1">
        Monty's  
      </div>
      <div class="hero-title-line2">
        Data and Sourcing Results
      </div>
    </div>
  </div>
  
  <!-- Dashboard Section -->
  <div class="w-full max-w-7xl mx-auto">
    
    <!-- Dashboard Grid - Easy to add more modules -->
    <div id="dashboardGrid" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      
      <!-- Recent Founder Recommendations Module -->
      <div class="module-card rounded-xl p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl module-title text-brand">Recent sourcing recommendations</h3>
          <button onclick="showModule('foundersModule')" class="text-sm text-blue-600 hover:text-blue-800 font-medium transition-colors">
            View All →
          </button>
        </div>
        
        <div id="dashboardFoundersLoading" class="hidden text-center py-4">
          <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
          <p class="text-sm text-gray-600 mt-2">Loading...</p>
        </div>
        
        <div id="dashboardFoundersList" class="space-y-3">
          <!-- Cards will be inserted here -->
        </div>
      </div>

      <!-- Recent Pre-Seed Deals Module -->
      <div class="module-card rounded-xl p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl module-title text-brand">Recent pre-seed deals</h3>
          <button onclick="showModule('dealsModule')" class="text-sm text-blue-600 hover:text-blue-800 font-medium transition-colors">
            View All →
          </button>
        </div>
        
        <div id="dashboardDealsLoading" class="hidden text-center py-4">
          <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
          <p class="text-sm text-gray-600 mt-2">Loading...</p>
        </div>
        
        <div id="dashboardDealsList" class="space-y-3">
          <!-- Cards will be inserted here -->
        </div>
      </div>
      
    </div>
  </div>
</div>


    <div id="valuationModule" class="space-y-10 hidden">


  <!-- Single Stock Section -->
  <div class="bg-white rounded-xl shadow-lg w-full max-w-3xl p-6 space-y-6 mx-auto">

    <div class="flex gap-2">
      <input id="tickerInput" type="text" placeholder="Enter ticker (e.g. AAPL)"
        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
        onkeypress="if(event.key==='Enter') fetchData()" />
      <button onclick="fetchData()" class="btn-primary text-white px-4 py-2 rounded-lg font-semibold">Search</button>
    </div>

    <div id="loading" class="hidden text-center py-4">
      <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
      <p class="text-sm text-gray-600 mt-2">Loading...</p>
    </div>

    <div id="errorBox" class="hidden bg-red-50 border border-red-200 text-red-700 text-sm rounded-lg p-3"></div>

    <div id="results" class="hidden space-y-4">
      <div class="flex items-center justify-between">
        <h2 id="companyHeader" class="text-lg font-bold text-brand"></h2>
        <p id="stockPrice" class="text-xl font-semibold text-green-600"></p>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div class="bg-gray-50 p-3 rounded-lg"><p class="text-xs text-gray-500">Revenue</p><p id="revenue" class="font-semibold text-gray-800">—</p></div>
        <div class="bg-gray-50 p-3 rounded-lg"><p class="text-xs text-gray-500">P/E</p><p id="pe" class="font-semibold text-gray-800">—</p></div>
        <div class="bg-gray-50 p-3 rounded-lg"><p class="text-xs text-gray-500">P/S</p><p id="ps" class="font-semibold text-gray-800">—</p></div>
        <div class="bg-gray-50 p-3 rounded-lg"><p class="text-xs text-gray-500">Market Cap</p><p id="marketCap" class="font-semibold text-gray-800">—</p></div>
      </div>

      <button onclick="openModal()" class="w-full text-sm mt-2 py-2 rounded-lg border border-gray-300 hover:bg-gray-100">
        View Full Income Statement →
      </button>
    </div>
  </div>

  <!-- Industry Comparison Section -->
  <div id="industryPicker" class="bg-white rounded-xl shadow-lg w-full max-w-3xl p-6 space-y-5 mx-auto">
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Select Industry</label>
      <select id="industrySelect"
              onchange="updateSectorOptions()"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        <option value="">Select Industry</option>
      </select>
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Select Sector</label>
      <select id="sectorSelect"
              onchange="updateIndustryGroupOptions()"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              disabled>
        <option value="">Select Sector</option>
      </select>
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Select Industry Group (optional)</label>
      <select id="industryGroupSelect"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-gray-100"
              disabled>
        <option value="">All Groups in Sector</option>
      </select>
    </div>

    <button type="button"
            onclick="fetchIndustryComparison()"
            class="w-full btn-primary text-white py-3 px-6 rounded-lg font-semibold">
      Compare Companies
    </button>
  </div>

</div>


  <div id="modalOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center" onclick="closeModal()"></div>
  <div id="modal" class="hidden fixed inset-8 bg-white rounded-xl shadow-2xl z-50 overflow-auto p-6">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-brand">Income Statement</h2>
        <button onclick="closeModal()" class="text-2xl leading-none text-gray-700">×</button>
    </div>
    <div id="modalBody"></div>
    </div>
    </div> <!-- end valuationModule -->
    <div id="foundersModule" class="hidden">
  <div class="module-card rounded-xl w-full p-6 space-y-4">
<!-- Tabs (always visible) -->
<div class="flex justify-center border-b border-gray-300 mt-4">
  <button
    id="recommendedTab"
    onclick="showTab('recommended')"
    class="tab-btn border-b-2 border-blue-700 text-blue-700 font-semibold px-6 py-2">
    Recommended
  </button>
  <button
    id="searchTab"
    onclick="showTab('search')"
    class="tab-btn border-b-2 border-transparent text-gray-600 hover:text-blue-700 px-6 py-2">
    Search Database
  </button>
</div>


<!-- Recommended Filters -->
<div id="treePathFilters" class="space-y-3 hidden">
  <label class="block text-sm font-medium text-gray-700 mb-1">
    Filter by vertical 
  </label>

  <select id="treeLevel1"
          onchange="updateTreeLevel2(); loadRecommendedFiltered();"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
    <option value="">All</option>
  </select>

<div id="treeLevel2Container" class="hidden">
  <select id="treeLevel2"
          onchange="updateTreeLevel3(); loadRecommendedFiltered();"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
    <option value="">All</option>
  </select>
</div>


<div id="treeLevel3Container" class="hidden">
  <select id="treeLevel3"
          onchange="loadRecommendedFiltered();"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
    <option value="">All</option>
  </select>
</div>
</div>
<!-- Search Filters -->
<div id="searchPanel" class="space-y-3 hidden">
  <!-- Tree Path Filters for Search -->
<div class="space-y-2">
  <label class="block text-sm font-medium text-gray-700 mb-1">
    Optional filters
  </label>

  <select id="searchTreeLevel1"
          onchange="updateSearchTreeLevel2()"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
    <option value="">All verticals</option>
  </select>

  <div id="searchTreeLevel2Container" class="hidden">
  <select id="searchTreeLevel2"
          onchange="updateSearchTreeLevel3()"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
          disabled>
    <option value="">All</option>
  </select>
  </div>

  <div id="searchTreeLevel3Container" class="hidden">
  <select id="searchTreeLevel3"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
          disabled>
    <option value="">All</option>
  </select>
</div>
</div>


  <input id="searchKeyword" type="text"
         placeholder="Keyword (e.g. company or founder)"
         class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">

  <select id="searchLocation"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
    <option value="">Location</option>
  </select>

  <input id="searchTag" type="text"
         placeholder="Tag"
         class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">

  <button onclick="searchFounders()"
          class="w-full mt-2 btn-primary text-white py-2 px-4 rounded-lg font-semibold">
    Search
  </button>
</div>



    <!-- Two-column layout -->
    <div class="flex gap-6 mt-6">
      <!-- Left: scroll list -->
      <div class="w-1/2">
        <div id="foundersLoading" class="hidden text-center py-4">
          <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
          <p class="text-sm text-gray-600 mt-2">Loading...</p>
        </div>

        <!-- Recommended results -->
      <div id="recommendedResults" class="hidden overflow-y-auto max-h-[700px] border border-gray-200 rounded-lg p-3">
        <div id="recommendedScroll" class="flex flex-col gap-4"></div>
      </div>

      <!-- Search results -->
      <div id="searchResults"
     class="hidden overflow-y-auto max-h-[700px] border border-gray-200 rounded-lg p-3">
  <div id="searchScroll" class="flex flex-col gap-4"></div>
</div>

      </div>

      <!-- Right: detail panel -->
      <div id="founderDetailPanel" class="w-1/2 bg-gray-50 border border-gray-200 rounded-lg p-4 hidden">
        <h3 id="founderDetailTitle" class="text-xl font-bold text-brand mb-3">Founder Details</h3>
        <div id="founderDetailBody" class="text-sm text-gray-700 space-y-2"></div>
      </div>
    </div>
  </div>
</div>

    <!-- Interesting People Module -->
    <div id="interestingPeopleModule" class="hidden">
      <div class="module-card rounded-xl w-full p-6 space-y-4">
        <p class="text-gray-600 mt-8 mb-10 px-6 py-4">
          This page displays potential future founders based on their profiles, skills, and recent activity. 
          People are ranked by their potential interest as founders, with those who have recently been acquired, 
          are building new ventures, or show strong entrepreneurial indicators appearing first.
        </p>
        <!-- Two-column layout -->
        <div class="flex gap-6 mt-6">
          <!-- Left: scroll list -->
          <div class="w-1/2">
            <div id="peopleLoading" class="hidden text-center py-4">
              <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
              <p class="text-sm text-gray-600 mt-2">Loading...</p>
            </div>

            <!-- People results -->
            <div id="peopleResults" class="hidden overflow-y-auto max-h-[700px] border border-gray-200 rounded-lg p-3">
              <div id="peopleScroll" class="flex flex-col gap-4"></div>
            </div>
          </div>

          <!-- Right: detail panel -->
          <div id="personDetailPanel" class="w-1/2 bg-gray-50 border border-gray-200 rounded-lg p-4 hidden">
            <h3 id="personDetailTitle" class="text-xl font-bold text-brand mb-3">Person Details</h3>
            <div id="personDetailBody" class="text-sm text-gray-700 space-y-2"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Prospecting Module -->
    <div id="prospectingModule" class="hidden">
      <div class="module-card rounded-xl w-full p-6 space-y-4">
        <p class="text-gray-600 mt-8 mb-10 px-6 py-4">
          Use this tool to search for prospects based on keywords, role, and company name. 
          Enter your search criteria below and click search to find matching prospects.
        </p>
        
        <!-- Search Form -->
        <div class="space-y-4">
          <div id="prospectingErrorBox" class="hidden bg-red-50 border border-red-200 text-red-700 text-sm rounded-lg p-3"></div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Keywords <span class="text-gray-500 text-xs">(one keyword only)</span>
            </label>
            <input 
              id="prospectingKeywords" 
              type="text" 
              placeholder="Enter one keyword (e.g. machine learning)"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Role <span class="text-gray-500 text-xs">(one role only)</span>
            </label>
            <input 
              id="prospectingRole" 
              type="text" 
              placeholder="Enter one role (e.g. CEO)"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Company Name <span class="text-gray-500 text-xs">(one company only)</span>
            </label>
            <input 
              id="prospectingCompany" 
              type="text" 
              placeholder="Enter one company name"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>

          <button 
            onclick="searchProspects()"
            class="w-full mt-4 btn-primary text-white py-3 px-6 rounded-lg font-semibold">
            Search
          </button>
        </div>

        <!-- Loading indicator -->
        <div id="prospectingLoading" class="hidden text-center py-4">
          <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
          <p class="text-sm text-gray-600 mt-2">Searching...</p>
        </div>

        <!-- Results -->
        <div id="prospectingResults" class="hidden mt-6">
          <div class="mb-4 flex items-center justify-between">
            <div id="prospectingResultsHeader" class="text-sm text-gray-600 font-medium"></div>
            <button 
              id="exportCsvBtn"
              onclick="exportProspectingResultsToCSV()"
              class="hidden px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium">
              Export to CSV
            </button>
          </div>
          <div class="overflow-y-auto border border-gray-200 rounded-lg p-3" style="max-height: calc(100vh - 350px); min-height: 400px;">
            <div id="prospectingScroll" class="flex flex-col gap-4"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Deals Module -->
    <div id="dealsModule" class="hidden">
      <div class="module-card rounded-xl w-full p-6 space-y-4">
        <p class="text-gray-600 mt-8 mb-10 px-6 py-4">
          Here we have a list of early stage deals, including pre-seed and seed funding rounds. 
          Use the filters below to explore deals by category and funding round.
          Currently they are sorted by recency.
        </p>
        <!-- Filters -->
        <div class="space-y-3">
          <div class="flex gap-4">
            <div class="flex-1">
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Filter by Category
              </label>
              <div class="relative">
                <button type="button" 
                        onclick="toggleMultiSelect('dealCategory')"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white text-left flex items-center justify-between">
                  <span id="dealCategoryDisplay">All Categories</span>
                  <span class="text-gray-400">▼</span>
                </button>
                <div id="dealCategoryDropdown" class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                  <div class="p-2">
                    <label class="flex items-center p-2 hover:bg-gray-50 cursor-pointer rounded">
                      <input type="checkbox" 
                             class="mr-2" 
                             onchange="toggleCategoryOption('all')"
                             id="dealCategoryAll">
                      <span>All Categories</span>
                    </label>
                    <div id="dealCategoryOptions" class="border-t border-gray-200 mt-1 pt-1">
                      <!-- Options will be populated here -->
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="flex-1">
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Filter by Funding Round
              </label>
              <div class="relative">
                <button type="button" 
                        onclick="toggleMultiSelect('dealFundingRound')"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white text-left flex items-center justify-between">
                  <span id="dealFundingRoundDisplay">All Funding Rounds</span>
                  <span class="text-gray-400">▼</span>
                </button>
                <div id="dealFundingRoundDropdown" class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                  <div class="p-2">
                    <label class="flex items-center p-2 hover:bg-gray-50 cursor-pointer rounded">
                      <input type="checkbox" 
                             class="mr-2" 
                             onchange="toggleFundingRoundOption('all')"
                             id="dealFundingRoundAll">
                      <span>All Funding Rounds</span>
                    </label>
                    <div id="dealFundingRoundOptions" class="border-t border-gray-200 mt-1 pt-1">
                      <!-- Options will be populated here -->
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Loading indicator -->
        <div id="dealsLoading" class="hidden text-center py-4">
          <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
          <p class="text-sm text-gray-600 mt-2">Loading...</p>
        </div>

        <!-- Results -->
        <div id="dealsResults" class="hidden overflow-y-auto max-h-[700px] border border-gray-200 rounded-lg p-3">
          <div id="dealsScroll" class="flex flex-col gap-4"></div>
        </div>
      </div>
    </div>

  </main>
</body>

<script>
// Toggle sidebar on mobile
function toggleSidebar() {
  const sidebar = document.querySelector('.sidebar-container');
  const overlay = document.getElementById('sidebarOverlay');
  
  if (sidebar && overlay) {
    sidebar.classList.toggle('active');
    overlay.classList.toggle('active');
  }
}

// Close sidebar on mobile when clicking outside or selecting a module
function closeSidebarMobile() {
  if (window.innerWidth <= 768) {
    const sidebar = document.querySelector('.sidebar-container');
    const overlay = document.getElementById('sidebarOverlay');
    
    if (sidebar && overlay) {
      sidebar.classList.remove('active');
      overlay.classList.remove('active');
    }
  }
}

function showModule(id) {
  ["welcomeModule", "valuationModule", "foundersModule", "dealsModule", "interestingPeopleModule", "prospectingModule"].forEach(m =>
    document.getElementById(m).classList.add("hidden")
  );
  document.getElementById(id).classList.remove("hidden");

  document.querySelectorAll(".sidebar-btn").forEach(b =>
    b.classList.remove("bg-blue-700")
  );
  document.getElementById("btn-" + id).classList.add("bg-blue-700");
  
  // Close sidebar on mobile after selecting a module
  closeSidebarMobile();

  if (id === "foundersModule") {
    loadFilters().then(() => showTab("recommended"));
  }
  
  // Load dashboard when showing home page
  if (id === "welcomeModule") {
    loadDashboardRecommendations();
    loadDashboardDeals();
  }
  
  // Load deals when showing deals module
  if (id === "dealsModule") {
    loadDealsFilters().then(() => loadDeals());
  }
  
  // Load interesting people when showing interesting people module
  if (id === "interestingPeopleModule") {
    loadInterestingPeople();
  }
}




</script>

  <script>
    
    const API_URL = "";
    const $ = (id) => document.getElementById(id);

    function fmtNum(v) {
      if (v == null || isNaN(v)) return "N/A";
      if (Math.abs(v) >= 1e9) return `$${(v / 1e9).toFixed(2)}B`;
      if (Math.abs(v) >= 1e6) return `$${(v / 1e6).toFixed(2)}M`;
      if (Math.abs(v) >= 1e3) return `$${(v / 1e3).toFixed(2)}K`;
      return `$${v.toFixed(2)}`;
    }

    async function fetchData() {
        const ticker = $("tickerInput").value.trim().toUpperCase();
        if (!ticker) return showError("Enter a ticker symbol.");
        hideError(); $("results").classList.add("hidden"); $("loading").classList.remove("hidden");

        try {
            async function safeFetchJSON(url) {
            const res = await fetch(url);
            const text = await res.text();
            const cleanText = text
                .replace(/\b-?Infinity\b/g, "null") // handles Infinity and -Infinity
                .replace(/\bNaN\b/g, "null");
            return JSON.parse(cleanText);
            }

            const [finRes, incRes, priceRes, valRes] = await Promise.all([
            safeFetchJSON(`${API_URL}/api/financials/${ticker}`),
            safeFetchJSON(`${API_URL}/api/income/${ticker}`),
            safeFetchJSON(`${API_URL}/api/stock-price/${ticker}`),
            safeFetchJSON(`${API_URL}/api/valuation/${ticker}`),
            ]);

            $("loading").classList.add("hidden");

            if (!finRes.success || !priceRes.success || !valRes.success) {
            return showError("Unable to retrieve data for this ticker.");
            }

            $("companyHeader").textContent = ticker;
            $("stockPrice").textContent = priceRes.data?.price ? `$${priceRes.data.price.toFixed(2)}` : "N/A";
            $("revenue").textContent = fmtNum(finRes.data?.revenue);
            $("pe").textContent = valRes.data?.pe ? valRes.data.pe.toFixed(2) : "N/A";
            $("ps").textContent = valRes.data?.ps ? valRes.data.ps.toFixed(2) : "N/A";
            $("marketCap").textContent = fmtNum(valRes.data?.market_cap);

            if (incRes?.success) {
            window.latestIncome = incRes.data?.income_statement || null;
            window.fullFinancials = incRes.data || null;
            } else {
            window.latestIncome = null;
            window.fullFinancials = null;
            }

            $("results").classList.remove("hidden");
        } catch (err) {
            console.error(err);
            showError("Failed to connect to backend.");
            $("loading").classList.add("hidden");
        }
        }

    function showError(msg){$("errorBox").textContent=msg;$("errorBox").classList.remove("hidden");}
    function hideError(){$("errorBox").classList.add("hidden");}

    // Helper: find all period keys and sort newest → oldest
    function extractPeriods(statement) {
        return Object.keys(statement)
        .filter(k => /^\d{4}-\d{2}(-\d{2})?$/.test(k))
        .sort((a, b) => b.localeCompare(a));
    }

    // Helper: normalize a date key to YYYY-MM for mapping
    const norm = (s) => (s || "").slice(0, 7);

    // Heuristic formatting (reuses your fmtNum for currency-like values)
    function formatCell(label, v) {
        if (v === null || v === undefined || !isFinite(v)) return "N/A";
        const lower = (label || "").toLowerCase();
        if (lower.includes("earnings per share")) return v.toFixed(2);
        if (lower.includes("shares")) {
        const abs = Math.abs(v);
        if (abs >= 1e9) return (v / 1e9).toFixed(2) + "B";
        if (abs >= 1e6) return (v / 1e6).toFixed(2) + "M";
        return v.toLocaleString("en-US", { maximumFractionDigits: 0 });
        }
        return fmtNum(v); // your existing formatter
    }
    function openEmptyModal(title = "Results") {
        $("modalBody").innerHTML = "";
        $("modalOverlay").classList.remove("hidden");
        $("modal").classList.remove("hidden");
        document.querySelector("#modal h2").textContent = title;
        }

    function openModal() {
        const full = window.fullFinancials || null;
        const income = full?.income_statement || null;
        const meta = full?.filing_metadata || [];

        if (!income || !income.label) {
            $("modalBody").innerHTML =
            `<div class="p-6 text-center text-gray-500">No income data</div>`;
            $("modalOverlay").classList.remove("hidden");
            $("modal").classList.remove("hidden");
            return;
        }

        // Helpers
        const periods = Object.keys(income)
            .filter(k => /^\d{4}-\d{2}(-\d{2})?$/.test(k))
            .sort((a,b) => b.localeCompare(a)); // newest → left
        const labelsMap = income.label || {};
        const labelIdxs = Object.keys(labelsMap).sort((a,b)=>Number(a)-Number(b));
        const norm = s => (s || "").slice(0,7);
        const metaByPeriod = {};
        meta.forEach(m => metaByPeriod[norm(m.period_end)] = m);

        // Build table shell
        const body = $("modalBody");
        if (!body) { console.error("Missing #modalBody"); return; }
        body.innerHTML = `
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="px-6 py-4 bg-gray-50 border-b border-gray-200 flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-800">Income Statement</h3>
                <div class="text-xs text-gray-500">Periods: ${periods.join(" • ")}</div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                <thead class="bg-gray-100 border-b border-gray-200" id="incomeThead"></thead>
                <tbody class="divide-y divide-gray-200" id="incomeTable"></tbody>
                </table>
            </div>
            </div>
        `;

        // Header row
        const thead = $("incomeThead");
        thead.innerHTML = `
            <tr>
            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700 sticky left-0 bg-gray-100 z-10">Line Item</th>
            ${periods.map(p => {
                const m = metaByPeriod[norm(p)];
                const type = m?.type || "—";
                const pe = m?.period_end || p;
                return `
                <th class="px-6 py-3 text-right text-sm font-semibold text-gray-700">
                    <div class="flex flex-col items-end">
                    <span class="inline-block text-xs px-2 py-0.5 rounded bg-gray-200 text-gray-700">${type}</span>
                    <span class="text-xs text-gray-500 mt-1">${pe}</span>
                    </div>
                </th>`;
            }).join("")}
            </tr>
        `;

        // Body rows
        const tbody = $("incomeTable");
        labelIdxs.forEach(idx => {
            const label = labelsMap[idx];
            const tr = document.createElement("tr");
            tr.className = "hover:bg-gray-50";

            // sticky label
            const th = document.createElement("td");
            th.className = "px-6 py-3 text-sm text-gray-800 sticky left-0 bg-white z-10";
            th.textContent = label;
            tr.appendChild(th);

            // cells per period
            periods.forEach(p => {
            const rowVals = income[p] || {};
            const v = Object.prototype.hasOwnProperty.call(rowVals, idx) ? rowVals[idx] : null;
            const td = document.createElement("td");
            td.className = "px-6 py-3 text-sm text-gray-800 text-right";
            td.textContent = formatCell(label, v);
            tr.appendChild(td);
            });

            tbody.appendChild(tr);
        });

        $("modalOverlay").classList.remove("hidden");
        $("modal").classList.remove("hidden");

        // simple formatter that reuses your fmtNum for currency-like values
        function formatCell(label, v) {
            if (v === null || v === undefined || !isFinite(v)) return "N/A";
            const lower = (label || "").toLowerCase();
            if (lower.includes("earnings per share")) return Number(v).toFixed(2);
            if (lower.includes("shares")) {
            const n = Number(v);
            const abs = Math.abs(n);
            if (abs >= 1e9) return (n/1e9).toFixed(2) + "B";
            if (abs >= 1e6) return (n/1e6).toFixed(2) + "M";
            return n.toLocaleString("en-US", { maximumFractionDigits: 0 });
            }
            return fmtNum(Number(v));
        }
        }

        function closeModal() {
        $("modalOverlay").classList.add("hidden");
        $("modal").classList.add("hidden");
        }

  </script>
  <script>
  // In-memory map
  let industryMapData = null;

  // Load map on page load
  document.addEventListener("DOMContentLoaded", () => {
    loadIndustryMap();
    // Load dashboard on initial page load
    loadDashboardRecommendations();
    loadDashboardDeals();
  });

  async function loadIndustryMap() {
    try {
      // try API first, then fall back to static file if you serve one
      const res = await fetch(`${API_URL || ""}/api/industry-map`);
      const json = await res.json();
      if (!json.success || !json.data) throw new Error("bad payload");

      industryMapData = json.data; // expects shape { industries: { [industry]: { sectors: { [sector]: { industry_groups: { [group]: [tickers] } } } } } }
      populateIndustryDropdown();
    } catch (e) {
      console.error("industry map load failed", e);
      showError("Failed to load industry map.");
    }
  }

  function populateIndustryDropdown() {
    const industrySelect = $("industrySelect");
    industrySelect.innerHTML = `<option value="">Select Industry</option>`;
    const industries = Object.keys(industryMapData.industries || {}).sort();
    for (const name of industries) {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      industrySelect.appendChild(opt);
    }
    // reset dependents
    const sectorSelect = $("sectorSelect");
    const groupSelect = $("industryGroupSelect");
    sectorSelect.disabled = true;
    groupSelect.disabled = true;
    groupSelect.classList.add("bg-gray-100");
  }

  function updateSectorOptions() {
    const industry = $("industrySelect").value;
    const sectorSelect = $("sectorSelect");
    const groupSelect = $("industryGroupSelect");

    // reset
    sectorSelect.innerHTML = `<option value="">Select Sector</option>`;
    groupSelect.innerHTML = `<option value="">All Groups in Sector</option>`;
    groupSelect.disabled = true;
    groupSelect.classList.add("bg-gray-100");

    if (!industry) {
      sectorSelect.disabled = true;
      return;
    }
    sectorSelect.disabled = false;

    const sectors = Object.keys(industryMapData.industries[industry].sectors || {}).sort();
    for (const s of sectors) {
      const opt = document.createElement("option");
      opt.value = s;
      opt.textContent = s;
      sectorSelect.appendChild(opt);
    }
  }

  function updateIndustryGroupOptions() {
    const industry = $("industrySelect").value;
    const sector = $("sectorSelect").value;
    const groupSelect = $("industryGroupSelect");

    groupSelect.innerHTML = `<option value="">All Groups in Sector</option>`;

    if (!sector) {
      groupSelect.disabled = true;
      groupSelect.classList.add("bg-gray-100");
      return;
    }
    groupSelect.disabled = false;
    groupSelect.classList.remove("bg-gray-100");

    const groups = Object.keys(
      industryMapData.industries[industry].sectors[sector].industry_groups || {}
    ).sort();

    for (const g of groups) {
      const opt = document.createElement("option");
      opt.value = g;
      opt.textContent = g;
      groupSelect.appendChild(opt);
    }
  }

async function fetchIndustryComparison() {
  const industry = $("industrySelect").value;
  const sector = $("sectorSelect").value;
  const group = $("industryGroupSelect").value;
  if (!industry || !sector) {
    showError("Please select at least an industry and sector");
    return;
  }

  // Fetch tickers for selection
  const path = `${industry}/${sector}/${group || ""}`.replace(/\/$/, "");
  const tickersRes = await fetch(`${API_URL}/api/industry-tickers/${path}`);
  const tickersJson = await tickersRes.json();
  const tickers = tickersJson?.data?.tickers || [];
  if (!tickers.length) {
    showError("No tickers found");
    return;
  }

  // open modal for results
  openEmptyModal("Industry Comparison");
  $("modalBody").innerHTML = `<p class="text-gray-600 p-4">Loading ${tickers.length} companies...</p>`;

  const resp = await fetch(`${API_URL}/api/industry-comparison-stream`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ tickers }),
  });

  const reader = resp.body.getReader();
  const decoder = new TextDecoder();
  let buffer = "";

  $("modalBody").innerHTML = `
    <div class="overflow-x-auto">
      <table id="comparisonTable" class="min-w-full border border-gray-200 text-sm text-gray-800">
        <thead class="bg-gray-100 text-gray-700 font-semibold">
          <tr>
            <th class="text-left px-4 py-2">Ticker</th>
            <th class="text-left px-4 py-2">Company</th>
            <th class="text-right px-4 py-2">Revenue</th>
            <th class="text-right px-4 py-2">P/E</th>
            <th class="text-right px-4 py-2">P/S</th>
            <th class="text-right px-4 py-2">Market Cap</th>
          </tr>
        </thead>
        <tbody id="comparisonTableBody"></tbody>
      </table>
    </div>
  `;

  const tbody = $("comparisonTableBody");
  const missing = [];
  const validRows = [];

  // --- this replaces the old while loop entirely ---
  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    buffer += decoder.decode(value, { stream: true });
    const lines = buffer.split("\n");
    buffer = lines.pop();

    for (const line of lines) {
      if (!line.trim()) continue;
      const msg = JSON.parse(line);

      if (msg.type === "company") {
        const c = msg.data;
        validRows.push(c);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="px-4 py-2 text-blue-600">${c.ticker}</td>
          <td class="px-4 py-2 text-gray-700">${c.company_name || "—"}</td>
          <td class="px-4 py-2 text-right">${fmtNum(c.revenue)}</td>
          <td class="px-4 py-2 text-right">${c.pe?.toFixed(2) ?? "N/A"}</td>
          <td class="px-4 py-2 text-right">${c.ps?.toFixed(2) ?? "N/A"}</td>
          <td class="px-4 py-2 text-right">${fmtNum(c.market_cap)}</td>`;
        tbody.appendChild(tr);
      }

      if (msg.type === "skip") missing.push(msg.ticker);
    }
  }

  // --- after streaming completes ---
  if (validRows.length) {
    const avg = (key) =>
      validRows.reduce((a, b) => a + (Number(b[key]) || 0), 0) / validRows.length;

    const tr = document.createElement("tr");
    tr.className = "bg-gray-100 font-semibold border-t";
    tr.innerHTML = `
    <td class="px-4 py-2 text-gray-700" colspan="2">Average (${validRows.length})</td>
    <td class="px-4 py-2 text-right">${fmtNum(avg("revenue"))}</td>
    <td class="px-4 py-2 text-right">${avg("pe").toFixed(2)}</td>
    <td class="px-4 py-2 text-right">${avg("ps").toFixed(2)}</td>
    <td class="px-4 py-2 text-right">${fmtNum(avg("market_cap"))}</td>`;
    tbody.appendChild(tr);
  }

  if (missing.length) {
    const missHeader = document.createElement("tr");
    missHeader.innerHTML = `<td colspan="5" class="pt-6 pb-2 font-bold text-gray-700">Tickers with missing data</td>`;
    tbody.appendChild(missHeader);

    for (const t of missing) {
      const tr = document.createElement("tr");
      tr.className = "text-gray-400 italic";
      tr.innerHTML = `
        <td class="px-4 py-2">${t}</td>
        <td class="px-4 py-2 text-right" colspan="4">No data available</td>`;
      tbody.appendChild(tr);
    }
  }
}


</script>
<script>
  const API_KEY = "5f8e7ac4f6f8a3b6b2d91c66e01d0f7d1a91f4f4bfc1f3263e57b85c14f6a733";

const FOUNDERS_API = "https://monty-api-production.up.railway.app";

async function loadFounders(endpoint) {
  $("foundersLoading").classList.remove("hidden");
  $("foundersResults").classList.add("hidden");
  $("foundersScroll").innerHTML = "";

  try {
    // fetch the data first
    const res = await fetch(`${FOUNDERS_API}/${endpoint}`, {
      headers: {
        "x-api-key": "5f8e7ac4f6f8a3b6b2d91c66e01d0f7d1a91f4f4bfc1f3263e57b85c14f6a733"
      }
    });
    const json = await res.json();
    let data = json.data || [];

    // sort descending by access_date
    data.sort((a, b) => new Date(b.access_date) - new Date(a.access_date));

    $("foundersLoading").classList.add("hidden");
    $("foundersResults").classList.remove("hidden");

    if (!data.length) {
      $("foundersScroll").innerHTML = `<p class="text-gray-500 px-4">No data found.</p>`;
      return;
    }

    const scroll = $("foundersScroll");
    for (const row of data.slice(0, 50)) {
      const company = row.company_name || "Unknown";
      const treePath = row.tree_path || "—";
      const companyWebsite = row.company_website || "—";
      const profileUrl = row.profile_url || "—";
      const tags = (row.company_tags || "")
      .split(",")
      .map(t => t.trim())
      .filter(t => t && t.toLowerCase() !== "none");

      const card = document.createElement("div");
      card.className =
        "min-w-[250px] bg-gray-50 border border-gray-200 rounded-lg p-4 hover:shadow-md cursor-pointer flex flex-col justify-between";
      card.innerHTML = `
        <div>
          <h3 class="font-semibold text-brand text-lg truncate">${company}</h3>
          <p class="text-xs text-gray-500 mt-1">${treePath}</p>
        </div>
        ${tags.length
          ? `<div class="flex flex-wrap gap-1 mt-3">
              ${tags.map(t => `<span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full">${t}</span>`).join("")}
            </div>`
          : ""}
      `;

      // Add click handler to show detail modal
      card.addEventListener("click", () => openFounderModal(row));
      scroll.appendChild(card);
    }

  } catch (err) {
    $("foundersLoading").classList.add("hidden");
    console.error(err);
    $("foundersScroll").innerHTML = `<p class="text-red-500 px-4">Error loading data.</p>`;
  }
}
function clean(value) {
  if (value === null || value === undefined) return "";
  if (typeof value === "number" && isNaN(value)) return "";
  const str = String(value).trim();
  if (!str || str.toLowerCase() === "nan" || str.toLowerCase() === "none") return "";
  return str;
}


function openFounderModal(data) {
  const panel = $("founderDetailPanel");
  const title = $("founderDetailTitle");
  const body = $("founderDetailBody");

  title.textContent = clean(data.company_name) || "Founder Details";

  // Build tags section
  const tags = [];
  
  // Repeat Founder tag (only if true)
  if (data.repeat_founder === true || data.repeat_founder === "true" || String(data.repeat_founder).toLowerCase() === "true") {
    tags.push('<span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">Repeat Founder</span>');
  }
  
  // Technical tag (only if true)
  if (data.technical === true || data.technical === "true" || String(data.technical).toLowerCase() === "true") {
    tags.push('<span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded-full">Technical</span>');
  }
  
  // Tree Thesis tag (only if it exists and is not "No specific thesis on this space")
  const treeThesis = clean(data.tree_thesis);
  if (treeThesis && treeThesis.toLowerCase() !== "no specific thesis on this space") {
    tags.push(`<span class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full">${treeThesis}</span>`);
  }

  let html = `<div class="space-y-3 text-sm text-gray-700">`;

  // Tags section at the top
  if (tags.length > 0) {
    html += `<div class="flex flex-wrap gap-2 mb-4 pb-3 border-b border-gray-200">${tags.join("")}</div>`;
  }

  // Main fields (excluding those we're handling differently)
  const fields = [
    ["Founder", data.name],
    ["Company", data.company_name],
    ["Product", data.product],
    ["Location", data.location],
    ["Building Since", data.building_since],
    ["Business Stage", data.business_stage],
    ["Market", data.market],
    ["Funding", data.funding],
    ["Source", data.source],
    ["Industry Expertise Score", data.industry_expertise_score],
    ["Past Success Indication Score", data.past_success_indication_score],
    ["Company Tech Score", data.company_tech_score],
  ];

  // Add only non-empty fields
  for (const [label, value] of fields) {
    const cleaned = clean(value);
    if (cleaned) html += `<p><strong>${label}:</strong> ${cleaned}</p>`;
  }

  // Helper function to parse and display tags
  function parseTags(value) {
    if (!value) return [];
    if (Array.isArray(value)) return value.filter(Boolean);
    if (typeof value === 'string') {
      return value.split(',').map(t => t.trim()).filter(t => t && t.toLowerCase() !== 'none');
    }
    return [];
  }

  // Verticals section
  const verticals = parseTags(data.verticals);
  if (verticals.length > 0) {
    html += `<div class="mt-3"><strong class="text-gray-700">Verticals:</strong><div class="flex flex-wrap gap-2 mt-2">`;
    verticals.forEach(v => {
      // Remove parentheses and their contents (e.g., "Retail Technology (high)" -> "Retail Technology")
      const cleaned = v.replace(/\s*\([^)]*\)\s*/g, '').trim();
      html += `<span class="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded-full">${cleaned}</span>`;
    });
    html += `</div></div>`;
  }

  // School Tags section
  const schoolTags = parseTags(data.school_tags);
  if (schoolTags.length > 0) {
    html += `<div class="mt-3"><strong class="text-gray-700">School Tags:</strong><div class="flex flex-wrap gap-2 mt-2">`;
    schoolTags.forEach(tag => {
      html += `<span class="text-xs bg-amber-100 text-amber-700 px-2 py-1 rounded-full">${tag}</span>`;
    });
    html += `</div></div>`;
  }

  // Company Tags section
  const companyTags = parseTags(data.company_tags);
  if (companyTags.length > 0) {
    html += `<div class="mt-3"><strong class="text-gray-700">Tags:</strong><div class="flex flex-wrap gap-2 mt-2">`;
    companyTags.forEach(tag => {
      html += `<span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full">${tag}</span>`;
    });
    html += `</div></div>`;
  }

  // Headcount (only if not 0)
  const headcount = data.headcount;
  if (headcount && headcount !== 0 && headcount !== "0") {
    html += `<p><strong>Headcount:</strong> ${headcount}</p>`;
  }

  // Optional sections
  // Embedded News (only if not empty)
  const embeddedNews = data.embeddednews;
  if (embeddedNews && clean(embeddedNews)) {
    // Check if it's an array or string
    let newsContent = embeddedNews;
    if (Array.isArray(embeddedNews)) {
      if (embeddedNews.length > 0) {
        newsContent = embeddedNews.join(", ");
        html += `<div class="mt-2"><strong>Embedded News:</strong><div class="mt-1 text-gray-600">${newsContent}</div></div>`;
      }
    } else {
      html += `<div class="mt-2"><strong>Embedded News:</strong><div class="mt-1 text-gray-600">${newsContent}</div></div>`;
    }
  }

  // Links section
  const links = [];
  if (data.profile_url)
    links.push(`<a href="${data.profile_url}" target="_blank" class="text-blue-600 underline hover:text-blue-800">LinkedIn Profile</a>`);
  
  if (data.company_website)
    links.push(`<a href="${data.company_website}" target="_blank" class="text-blue-600 underline hover:text-blue-800">Company Website</a>`);
  
  if (data.twitter)
    links.push(`<a href="${data.twitter}" target="_blank" class="text-blue-600 underline hover:text-blue-800">Twitter</a>`);

  if (links.length > 0) {
    html += `<div class="mt-4 pt-3 border-t border-gray-200 flex flex-wrap gap-3">${links.join("")}</div>`;
  }

  html += `</div>`;
  body.innerHTML = html;

  panel.classList.remove("hidden");
}

function toggleSearchPanel() {
  const panel = $("searchPanel");
  panel.classList.toggle("hidden");
}

// Search and reuse loadFounders-style rendering
async function searchFounders() {
  // clear previous
  $("foundersLoading").classList.remove("hidden");
  $("searchResults").classList.add("hidden");
  $("searchScroll").innerHTML = "";

  const keyword = $("searchKeyword").value.trim();
  const location = $("searchLocation").value.trim();
  const tree_path_prefix = getSearchSelectedTreePath();
  const tag = $("searchTag")?.value.trim() || "";

  const query = new URLSearchParams();
  if (keyword) query.append("keyword", keyword);
  if (location) query.append("location", location);
  if (tree_path_prefix) query.append("tree_path_prefix", tree_path_prefix);
  if (tag) query.append("tag", tag);

  try {
    const res = await fetch(`${FOUNDERS_API}/search?${query.toString()}`, {
      headers: { "x-api-key": API_KEY }
    });
    const json = await res.json();
    const data = json.data || [];

    $("foundersLoading").classList.add("hidden");

    if (!data.length) {
      $("searchResults").classList.remove("hidden");
      $("searchScroll").innerHTML = `<p class="text-gray-500 px-4">No results found.</p>`;
      return;
    }

    const scroll = $("searchScroll");
    for (const row of data.slice(0, 50)) {
      const card = document.createElement("div");
      card.className = "bg-gray-50 border border-gray-200 rounded-lg p-4 hover:shadow-md cursor-pointer transition-shadow";
      card.innerHTML = createFounderCardHTML(row);
      card.addEventListener("click", () => openFounderModal(row));
      scroll.appendChild(card);
    }

    $("searchResults").classList.remove("hidden");
  } catch (err) {
    console.error(err);
    $("foundersLoading").classList.add("hidden");
    $("searchResults").classList.remove("hidden");
    $("searchScroll").innerHTML = `<p class="text-red-500 px-4">Search failed.</p>`;
  }
}

function populateSelect(selectEl, items) {
  if (!selectEl) return;
  // Only append if we're still at the initial "All ..." option
  if (selectEl.options.length > 1) return;

  const uniqueSorted = [...new Set(items.filter(Boolean))]
    .sort((a, b) => a.localeCompare(b));

  const frag = document.createDocumentFragment();
  for (const v of uniqueSorted) {
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v;
    frag.appendChild(opt);
  }
  selectEl.appendChild(frag);
}
function expandTreePrefixes(treePaths) {
  const prefixes = new Set();
  for (const path of treePaths) {
    const parts = path.split(" > ");
    for (let i = 1; i <= parts.length; i++) {
      prefixes.add(parts.slice(0, i).join(" > "));
    }
  }
  return Array.from(prefixes).sort();
}

async function loadFilters() {
  try {
    const res = await fetch(`${FOUNDERS_API}/filters`, {
      headers: { "x-api-key": API_KEY }
    });
    const json = await res.json();
    const locations = json.locations || [];
    const treePaths = json.tree_paths || [];

    populateSelect($("searchLocation"), locations);
    buildTreeHierarchy(treePaths);
    populateTreeLevel1(); // for recommended
    populateSearchTreeLevel1(); // for search
  } catch (e) {
    console.error("Failed to load filters", e);
  }
}
function populateSearchTreeLevel1() {
  const allowedTopLevels = ["AI", "Fintech", "Healthcare", "Commerce", "Other"];
  const l1Sel = $("searchTreeLevel1");
  l1Sel.innerHTML = "<option value=''>All Top Categories</option>";

  const validKeys = Object.keys(treeHierarchy)
    .filter(k => allowedTopLevels.includes(k));

  for (const k of validKeys.sort()) {
    const opt = document.createElement("option");
    opt.value = k;
    opt.textContent = k;
    l1Sel.appendChild(opt);
  }

  $("searchTreeLevel2").disabled = true;
  $("searchTreeLevel3").disabled = true;
}



function buildTreeHierarchy(treePaths) {
  treeHierarchy = {};
  for (const path of treePaths) {
    const parts = path.split(" > ");
    parts.reduce((acc, part) => acc[part] ||= {}, treeHierarchy);
  }
}

function populateTreeLevel1() {
  const allowedTopLevels = ["AI", "Fintech", "Healthcare", "Commerce", "Other"];
  const l1Sel = $("treeLevel1");
  l1Sel.innerHTML = "<option value=''>All Top Categories</option>";

  const validKeys = Object.keys(treeHierarchy)
    .filter(k => allowedTopLevels.includes(k));

  for (const k of validKeys.sort()) {
    const opt = document.createElement("option");
    opt.value = k;
    opt.textContent = k;
    l1Sel.appendChild(opt);
  }

  $("treeLevel2").disabled = true;
  $("treeLevel3").disabled = true;
}


function updateTreeLevel2() {
  const l1 = $("treeLevel1").value;
  const l2Sel = $("treeLevel2");
  const l3Sel = $("treeLevel3");
  const l2Container = $("treeLevel2Container");
  const l3Container = $("treeLevel3Container");

  // reset
  l2Sel.innerHTML = "<option value=''>All Subcategories</option>";
  l3Sel.innerHTML = "<option value=''>All Sub-Subcategories</option>";
  l3Sel.disabled = true;
  l3Container.classList.add("hidden");

  if (!l1) {
    l2Sel.disabled = true;
    l2Container.classList.add("hidden");
    return;
  }

  const subs = Object.keys(treeHierarchy[l1] || {});
  l2Sel.disabled = !subs.length;
  l2Container.classList.toggle("hidden", !subs.length);

  for (const s of subs.sort()) {
    const opt = document.createElement("option");
    opt.value = s;
    opt.textContent = s;
    l2Sel.appendChild(opt);
  }
}

function updateTreeLevel3() {
  const l1 = $("treeLevel1").value;
  const l2 = $("treeLevel2").value;
  const l3Sel = $("treeLevel3");
  const l3Container = $("treeLevel3Container");

  l3Sel.innerHTML = "<option value=''>All Sub-Subcategories</option>";

  if (!l2) {
    l3Sel.disabled = true;
    l3Container.classList.add("hidden");
    return;
  }

  const subs = Object.keys(treeHierarchy[l1]?.[l2] || {});
  l3Sel.disabled = !subs.length;
  l3Container.classList.toggle("hidden", !subs.length);

  for (const s of subs.sort()) {
    const opt = document.createElement("option");
    opt.value = s;
    opt.textContent = s;
    l3Sel.appendChild(opt);
  }
}

function updateSearchTreeLevel2() {
  const l1 = $("searchTreeLevel1").value;
  const l2Sel = $("searchTreeLevel2");
  const l3Sel = $("searchTreeLevel3");
  const l2Container = $("searchTreeLevel2Container");
  const l3Container = $("searchTreeLevel3Container");

  // reset
  l2Sel.innerHTML = "<option value=''>All Subcategories</option>";
  l3Sel.innerHTML = "<option value=''>All Sub-Subcategories</option>";
  l3Sel.disabled = true;
  l3Container.classList.add("hidden");

  if (!l1) {
    l2Sel.disabled = true;
    l2Container.classList.add("hidden");
    return;
  }

  const subs = Object.keys(treeHierarchy[l1] || {});
  l2Sel.disabled = !subs.length;
  l2Container.classList.toggle("hidden", !subs.length);

  for (const s of subs.sort()) {
    const opt = document.createElement("option");
    opt.value = s;
    opt.textContent = s;
    l2Sel.appendChild(opt);
  }
}

function updateSearchTreeLevel3() {
  const l1 = $("searchTreeLevel1").value;
  const l2 = $("searchTreeLevel2").value;
  const l3Sel = $("searchTreeLevel3");
  const l3Container = $("searchTreeLevel3Container");

  l3Sel.innerHTML = "<option value=''>All Sub-Subcategories</option>";

  if (!l2) {
    l3Sel.disabled = true;
    l3Container.classList.add("hidden");
    return;
  }

  const subs = Object.keys(treeHierarchy[l1]?.[l2] || {});
  l3Sel.disabled = !subs.length;
  l3Container.classList.toggle("hidden", !subs.length);

  for (const s of subs.sort()) {
    const opt = document.createElement("option");
    opt.value = s;
    opt.textContent = s;
    l3Sel.appendChild(opt);
  }
}

function getSearchSelectedTreePath() {
  const parts = [
    $("searchTreeLevel1").value,
    $("searchTreeLevel2").value,
    $("searchTreeLevel3").value
  ].filter(Boolean);
  return parts.join(" > ");
}


function getSelectedTreePath() {
  const parts = [
    $("treeLevel1").value,
    $("treeLevel2").value,
    $("treeLevel3").value
  ].filter(Boolean);
  return parts.join(" > ");
}

// Helper function to create founder card HTML
function createFounderCardHTML(row) {
  const company = row.company_name || "Unknown";
  const founder = row.name || "";
  const treePath = row.tree_path || "—";
  const location = row.location || "";
  const funding = row.funding || "";
  const businessStage = row.business_stage || "";
  const repeatFounder = row.repeat_founder === true || row.repeat_founder === "true" || String(row.repeat_founder).toLowerCase() === "true";
  const technical = row.technical === true || row.technical === "true" || String(row.technical).toLowerCase() === "true";
  
  const tags = (row.company_tags || "")
    .split(",")
    .map(t => t.trim())
    .filter(t => t && t.toLowerCase() !== "none");
  
  const verticals = (row.verticals || "")
    .split(",")
    .map(v => v.trim())
    .filter(v => v && v.toLowerCase() !== "none")
    .map(v => v.replace(/\s*\([^)]*\)\s*/g, '').trim())
    .filter(v => v);

  return `
    <div class="space-y-2">
      <div>
        <h3 class="font-semibold text-brand text-lg">${company}</h3>
        ${founder ? `<p class="text-xs text-gray-600 mt-0.5">${founder}</p>` : ""}
        <p class="text-xs text-gray-500 mt-1">${treePath}</p>
      </div>
      
      ${location || funding || businessStage ? `
        <div class="flex flex-wrap gap-x-4 gap-y-1 text-xs text-gray-600">
          ${location ? `<span>📍 ${location}</span>` : ""}
          ${businessStage ? `<span>🏢 ${businessStage}</span>` : ""}
          ${funding ? `<span>💰 ${funding}</span>` : ""}
        </div>
      ` : ""}
      
      ${repeatFounder || technical ? `
        <div class="flex flex-wrap gap-1">
          ${repeatFounder ? `<span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">Repeat Founder</span>` : ""}
          ${technical ? `<span class="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full">Technical</span>` : ""}
        </div>
      ` : ""}
      
      ${verticals.length > 0 ? `
        <div class="flex flex-wrap gap-1">
          ${verticals.slice(0, 2).map(v => `<span class="text-xs bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full">${v}</span>`).join("")}
          ${verticals.length > 2 ? `<span class="text-xs text-gray-500">+${verticals.length - 2} more</span>` : ""}
        </div>
      ` : ""}
      
      ${tags.length > 0 ? `
        <div class="flex flex-wrap gap-1">
          ${tags.slice(0, 2).map(t => `<span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full">${t}</span>`).join("")}
          ${tags.length > 2 ? `<span class="text-xs text-gray-500">+${tags.length - 2} more</span>` : ""}
        </div>
      ` : ""}
    </div>
  `;
}

async function loadRecommendedFiltered() {
  const treePath = getSelectedTreePath();

  $("foundersLoading").classList.remove("hidden");
  $("recommendedResults").classList.add("hidden");
  $("recommendedScroll").innerHTML = "";

  try {
    const query = treePath ? `?tree_path_prefix=${encodeURIComponent(treePath)}` : "";
    const res = await fetch(`${FOUNDERS_API}/recommended-founders${query}`, {
      headers: { "x-api-key": API_KEY }
    });
    const json = await res.json();
    const data = json.data || [];

    $("foundersLoading").classList.add("hidden");

    if (!data.length) {
      $("recommendedResults").classList.remove("hidden");
      $("recommendedScroll").innerHTML = `<p class="text-gray-500 px-4">No results found.</p>`;
      return;
    }

    const scroll = $("recommendedScroll");
    for (const row of data.slice(0, 50)) {
      const card = document.createElement("div");
      card.className = "bg-gray-50 border border-gray-200 rounded-lg p-4 hover:shadow-md cursor-pointer transition-shadow";
      card.innerHTML = createFounderCardHTML(row);
      card.addEventListener("click", () => openFounderModal(row));
      scroll.appendChild(card);
    }

    $("recommendedResults").classList.remove("hidden");
  } catch (err) {
    console.error(err);
    $("foundersLoading").classList.add("hidden");
    $("recommendedScroll").innerHTML = `<p class="text-red-500 px-4">Error loading data.</p>`;
  }
}

// Load dashboard recommendations (top 5)
async function loadDashboardRecommendations() {
  const loadingEl = $("dashboardFoundersLoading");
  const listEl = $("dashboardFoundersList");
  
  if (!loadingEl || !listEl) return; // Dashboard not visible
  
  loadingEl.classList.remove("hidden");
  listEl.innerHTML = "";

  try {
    const res = await fetch(`${FOUNDERS_API}/recommended-founders`, {
      headers: { "x-api-key": API_KEY }
    });
    const json = await res.json();
    const data = json.data || [];

    loadingEl.classList.add("hidden");

    if (!data.length) {
      listEl.innerHTML = `<p class="text-gray-500 text-sm text-center py-4">No recommendations available.</p>`;
      return;
    }

    // Show only top 5
    const top5 = data.slice(0, 5);
    
    top5.forEach((row, index) => {
      const card = document.createElement("div");
      card.className = "bg-gray-50 border border-gray-200 rounded-lg p-4 hover:shadow-md cursor-pointer transition-shadow";
      card.innerHTML = createFounderCardHTML(row);
      card.addEventListener("click", () => {
        showModule('foundersModule');
        // Small delay to ensure module is visible before opening modal
        setTimeout(() => openFounderModal(row), 100);
      });
      listEl.appendChild(card);
    });

  } catch (err) {
    console.error("Failed to load dashboard recommendations", err);
    loadingEl.classList.add("hidden");
    listEl.innerHTML = `<p class="text-red-500 text-sm text-center py-4">Error loading recommendations.</p>`;
  }
}

// Load dashboard pre-seed deals (top 5)
async function loadDashboardDeals() {
  const loadingEl = $("dashboardDealsLoading");
  const listEl = $("dashboardDealsList");
  
  if (!loadingEl || !listEl) return; // Dashboard not visible
  
  loadingEl.classList.remove("hidden");
  listEl.innerHTML = "";

  try {
    const res = await fetch(`${API_URL}/api/deals`);
    const json = await res.json();
    
    if (!json.success) {
      throw new Error(json.error || "Failed to load deals");
    }
    
    const allDeals = json.data || [];
    
    // Filter for pre-seed deals (case-insensitive)
    const preSeedDeals = allDeals.filter(deal => {
      const fundingRound = (deal["Funding Round"] || "").toLowerCase();
      return fundingRound.includes("pre-seed") || fundingRound.includes("pre seed");
    });
    
    loadingEl.classList.add("hidden");

    if (!preSeedDeals.length) {
      listEl.innerHTML = `<p class="text-gray-500 text-sm text-center py-4">No pre-seed deals available.</p>`;
      return;
    }

    // Show only top 5 most recent
    const top5 = preSeedDeals.slice(0, 5);
    
    top5.forEach((deal) => {
      const card = document.createElement("div");
      card.className = "bg-gray-50 border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow";
      card.innerHTML = createDashboardDealCardHTML(deal);
      listEl.appendChild(card);
    });

  } catch (err) {
    console.error("Failed to load dashboard deals", err);
    loadingEl.classList.add("hidden");
    listEl.innerHTML = `<p class="text-red-500 text-sm text-center py-4">Error loading deals.</p>`;
  }
}

// Helper function to create compact deal card HTML for dashboard
function createDashboardDealCardHTML(deal) {
  const company = deal.Company || "Unknown";
  const amount = deal.Amount || "";
  const investors = formatInvestors(deal.Investors);
  const date = deal.Date || "";
  const category = deal.Category || "";

  return `
    <div class="space-y-2">
      <div>
        <h3 class="font-semibold text-brand text-base">${company}</h3>
        ${date ? `<p class="text-xs text-gray-500 mt-0.5">${date}</p>` : ""}
      </div>
      
      ${amount ? `
        <div class="text-xs text-gray-600">
          <span class="font-semibold text-green-600">💰 ${amount}</span>
        </div>
      ` : ""}
      
      ${investors ? `
        <div class="text-xs text-gray-600">
          <span class="font-medium">Investors:</span> ${investors}
        </div>
      ` : ""}
      
      ${category ? `
        <div class="flex flex-wrap gap-1">
          <span class="text-xs bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded-full">${category}</span>
        </div>
      ` : ""}
    </div>
  `;
}

function showTab(tab) {
  const recommendedBtn = $("recommendedTab");
  const searchBtn = $("searchTab");

  // Reset all tab styles
  [recommendedBtn, searchBtn].forEach(btn => {
    btn.classList.remove("active");
    btn.classList.remove("border-blue-700", "text-blue-700");
    btn.classList.add("border-transparent", "text-gray-600");
  });

  // Set active tab
  const activeBtn = tab === "recommended" ? recommendedBtn : searchBtn;
  activeBtn.classList.add("active", "border-blue-700", "text-blue-700");
  activeBtn.classList.remove("border-transparent", "text-gray-600");

  // Show correct panels
  $("treePathFilters").classList.add("hidden");
  $("searchPanel")?.classList.add("hidden");
  $("recommendedResults").classList.add("hidden");
  $("searchResults").classList.add("hidden");

  if (tab === "recommended") {
    $("treePathFilters").classList.remove("hidden");
    $("recommendedResults").classList.remove("hidden");
    if ($("recommendedScroll").children.length === 0) loadRecommendedFiltered();
  } else {
    $("searchPanel")?.classList.remove("hidden");
    const hasResults = $("searchScroll").children.length > 0;
    $("searchResults").classList.toggle("hidden", !hasResults);
  }
}

// Multi-select state
let selectedCategories = new Set();
let selectedFundingRounds = new Set();

// Toggle multi-select dropdown
function toggleMultiSelect(type) {
  const dropdown = $(type + "Dropdown");
  if (dropdown) {
    dropdown.classList.toggle("hidden");
    // Close other dropdowns
    if (type === "dealCategory") {
      $("dealFundingRoundDropdown")?.classList.add("hidden");
    } else {
      $("dealCategoryDropdown")?.classList.add("hidden");
    }
  }
}

// Close dropdowns when clicking outside
document.addEventListener("click", (e) => {
  const categoryDropdown = $("dealCategoryDropdown");
  const fundingDropdown = $("dealFundingRoundDropdown");
  
  // Check if click is outside category dropdown and its button
  if (categoryDropdown && !categoryDropdown.contains(e.target) && 
      !e.target.closest("button[onclick*='dealCategory']")) {
    categoryDropdown.classList.add("hidden");
  }
  
  // Check if click is outside funding round dropdown and its button
  if (fundingDropdown && !fundingDropdown.contains(e.target) && 
      !e.target.closest("button[onclick*='dealFundingRound']")) {
    fundingDropdown.classList.add("hidden");
  }
});

// Toggle category option
function toggleCategoryOption(value) {
  if (value === "all") {
    const allChecked = $("dealCategoryAll").checked;
    selectedCategories.clear();
    if (allChecked) {
      // Select all categories
      document.querySelectorAll("#dealCategoryOptions input[type='checkbox']").forEach(cb => {
        if (cb.id !== "dealCategoryAll") {
          cb.checked = true;
          selectedCategories.add(cb.value);
        }
      });
    } else {
      // Unselect all
      document.querySelectorAll("#dealCategoryOptions input[type='checkbox']").forEach(cb => {
        cb.checked = false;
      });
    }
  } else {
    const checkboxId = `dealCategory_${value.replace(/[^a-zA-Z0-9]/g, "_")}`;
    const checkbox = document.getElementById(checkboxId);
    if (checkbox) {
      if (checkbox.checked) {
        selectedCategories.add(value);
        // Uncheck "All" if a specific option is selected
        $("dealCategoryAll").checked = false;
      } else {
        selectedCategories.delete(value);
      }
    }
  }
  updateCategoryDisplay();
  loadDeals();
}

// Toggle funding round option
function toggleFundingRoundOption(value) {
  if (value === "all") {
    const allChecked = $("dealFundingRoundAll").checked;
    selectedFundingRounds.clear();
    if (allChecked) {
      // Select all funding rounds
      document.querySelectorAll("#dealFundingRoundOptions input[type='checkbox']").forEach(cb => {
        if (cb.id !== "dealFundingRoundAll") {
          cb.checked = true;
          selectedFundingRounds.add(cb.value);
        }
      });
    } else {
      // Unselect all
      document.querySelectorAll("#dealFundingRoundOptions input[type='checkbox']").forEach(cb => {
        cb.checked = false;
      });
    }
  } else {
    const checkboxId = `dealFundingRound_${value.replace(/[^a-zA-Z0-9]/g, "_")}`;
    const checkbox = document.getElementById(checkboxId);
    if (checkbox) {
      if (checkbox.checked) {
        selectedFundingRounds.add(value);
        // Uncheck "All" if a specific option is selected
        $("dealFundingRoundAll").checked = false;
      } else {
        selectedFundingRounds.delete(value);
      }
    }
  }
  updateFundingRoundDisplay();
  loadDeals();
}

// Update category display text
function updateCategoryDisplay() {
  const display = $("dealCategoryDisplay");
  if (selectedCategories.size === 0) {
    display.textContent = "All Categories";
  } else if (selectedCategories.size === 1) {
    display.textContent = Array.from(selectedCategories)[0];
  } else {
    display.textContent = `${selectedCategories.size} selected`;
  }
}

// Update funding round display text
function updateFundingRoundDisplay() {
  const display = $("dealFundingRoundDisplay");
  if (selectedFundingRounds.size === 0) {
    display.textContent = "All Funding Rounds";
  } else if (selectedFundingRounds.size === 1) {
    display.textContent = Array.from(selectedFundingRounds)[0];
  } else {
    display.textContent = `${selectedFundingRounds.size} selected`;
  }
}

// Load deals filters (categories and funding rounds)
async function loadDealsFilters() {
  try {
    const res = await fetch(`${API_URL}/api/deals/filters`);
    const json = await res.json();
    if (!json.success) throw new Error("Failed to load filters");

    const categories = json.data.categories || [];
    const fundingRounds = json.data.funding_rounds || [];

    // Populate category checkboxes
    const categoryOptions = $("dealCategoryOptions");
    if (categoryOptions) {
      categoryOptions.innerHTML = "";
      categories.forEach(cat => {
        const label = document.createElement("label");
        label.className = "flex items-center p-2 hover:bg-gray-50 cursor-pointer rounded";
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.className = "mr-2";
        checkbox.value = cat;
        checkbox.id = `dealCategory_${cat.replace(/[^a-zA-Z0-9]/g, "_")}`;
        checkbox.onchange = () => toggleCategoryOption(cat);
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(cat));
        categoryOptions.appendChild(label);
      });
    }

    // Populate funding round checkboxes
    const fundingOptions = $("dealFundingRoundOptions");
    if (fundingOptions) {
      fundingOptions.innerHTML = "";
      fundingRounds.forEach(round => {
        const label = document.createElement("label");
        label.className = "flex items-center p-2 hover:bg-gray-50 cursor-pointer rounded";
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.className = "mr-2";
        checkbox.value = round;
        checkbox.id = `dealFundingRound_${round.replace(/[^a-zA-Z0-9]/g, "_")}`;
        checkbox.onchange = () => toggleFundingRoundOption(round);
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(round));
        fundingOptions.appendChild(label);
      });
    }
  } catch (e) {
    console.error("Failed to load deals filters", e);
  }
}

// Load and display deals
async function loadDeals() {
  const loadingEl = $("dealsLoading");
  const resultsEl = $("dealsResults");
  const scrollEl = $("dealsScroll");

  if (!loadingEl || !resultsEl || !scrollEl) return;

  loadingEl.classList.remove("hidden");
  resultsEl.classList.add("hidden");
  scrollEl.innerHTML = "";

  try {
    const query = new URLSearchParams();
    
    // Add categories if any are selected
    if (selectedCategories.size > 0) {
      Array.from(selectedCategories).forEach(cat => {
        query.append("category", cat);
      });
    }
    
    // Add funding rounds if any are selected
    if (selectedFundingRounds.size > 0) {
      Array.from(selectedFundingRounds).forEach(round => {
        query.append("funding_round", round);
      });
    }

    const res = await fetch(`${API_URL}/api/deals?${query.toString()}`);
    const json = await res.json();

    if (!json.success) {
      throw new Error(json.error || "Failed to load deals");
    }

    const deals = json.data || [];
    loadingEl.classList.add("hidden");

    if (!deals.length) {
      resultsEl.classList.remove("hidden");
      scrollEl.innerHTML = `<p class="text-gray-500 px-4">No deals found.</p>`;
      return;
    }

    // Display deals
    deals.forEach(deal => {
      const card = document.createElement("div");
      card.className = "bg-gray-50 border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow";
      card.innerHTML = createDealCardHTML(deal);
      scrollEl.appendChild(card);
    });

    resultsEl.classList.remove("hidden");
  } catch (err) {
    console.error("Failed to load deals", err);
    loadingEl.classList.add("hidden");
    resultsEl.classList.remove("hidden");
    scrollEl.innerHTML = `<p class="text-red-500 px-4">Error loading deals: ${err.message}</p>`;
  }
}

// Helper function to format investors string
function formatInvestors(investors) {
  if (!investors) return "";
  
  // If it's already an array, use it directly
  if (Array.isArray(investors)) {
    return investors.filter(Boolean).join(", ");
  }
  
  // Convert to string
  const investorsStr = String(investors).trim();
  if (!investorsStr) return "";
  
  // Try to parse as JSON array first
  try {
    const parsed = JSON.parse(investorsStr);
    if (Array.isArray(parsed)) {
      return parsed.filter(Boolean).join(", ");
    }
  } catch (e) {
    // Not valid JSON, continue with other parsing
  }
  
  // Check if it looks like a Python list string representation (e.g., "['Name1', 'Name2']")
  const listMatch = investorsStr.match(/^\[(.*)\]$/);
  if (listMatch) {
    const content = listMatch[1];
    // Extract quoted strings
    const items = content.match(/'([^']+)'/g) || content.match(/"([^"]+)"/g);
    if (items) {
      return items.map(item => item.slice(1, -1)).filter(Boolean).join(", ");
    }
    // If no quotes, try splitting by comma
    return content.split(',').map(item => item.trim()).filter(Boolean).join(", ");
  }
  
  // If it's a comma-separated string, return it as is (already formatted)
  // But clean up any extra whitespace
  return investorsStr.split(',').map(item => item.trim()).filter(Boolean).join(", ");
}

// Helper function to create deal card HTML
function createDealCardHTML(deal) {
  const company = deal.Company || "Unknown";
  const amount = deal.Amount || "";
  const fundingRound = deal["Funding Round"] || "";
  const vertical = deal.Vertical || "";
  const link = deal.Link || "";
  const investors = formatInvestors(deal.Investors);
  const category = deal.Category || "";
  const source = deal.Source || "";
  const date = deal.Date || "";

  return `
    <div class="space-y-2">
      <div>
        <h3 class="font-semibold text-brand text-lg">${company}</h3>
        ${date ? `<p class="text-xs text-gray-500 mt-1">${date}</p>` : ""}
      </div>
      
      ${amount || fundingRound ? `
        <div class="flex flex-wrap gap-x-4 gap-y-1 text-xs text-gray-600">
          ${amount ? `<span class="font-semibold text-green-600">💰 ${amount}</span>` : ""}
          ${fundingRound ? `<span>📊 ${fundingRound}</span>` : ""}
        </div>
      ` : ""}
      
      ${category || vertical ? `
        <div class="flex flex-wrap gap-1">
          ${category ? `<span class="text-xs bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded-full">${category}</span>` : ""}
          ${vertical ? `<span class="text-xs bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full">${vertical}</span>` : ""}
        </div>
      ` : ""}
      
      ${investors ? `
        <div class="text-xs text-gray-600">
          <span class="font-medium">Investors:</span> ${investors}
        </div>
      ` : ""}
      
      ${source ? `
        <div class="text-xs text-gray-500">
          <span class="font-medium">Source:</span> ${source}
        </div>
      ` : ""}
      
      ${link ? `
        <div class="pt-2">
          <a href="${link}" target="_blank" class="text-xs text-blue-600 hover:text-blue-800 underline">
            View Deal →
          </a>
        </div>
      ` : ""}
    </div>
  `;
}

// ---------------------------------------------------------------------
// INTERESTING PEOPLE FUNCTIONS
// ---------------------------------------------------------------------

// Helper function to parse JSON array or comma-separated string
function parseArrayOrString(value) {
  if (!value) return [];
  if (Array.isArray(value)) return value.filter(Boolean);
  if (typeof value === 'string') {
    try {
      const parsed = JSON.parse(value);
      if (Array.isArray(parsed)) return parsed.filter(Boolean);
    } catch (e) {
      // Not JSON, try comma-separated
      return value.split(',').map(s => s.trim()).filter(s => s && s.toLowerCase() !== 'none');
    }
  }
  return [];
}

// Helper function to score person based on headline keywords
function scorePersonInterest(person) {
  const headline = (person.headline || "").toLowerCase();
  let score = 0;

  // High score: Acquisition indicators (10 points)
  const acquisitionPatterns = [
    /acq\. by/i,
    /acquired by/i,
    /\(acquired\)/i,
    /\(acq\. by/i,
    /\bacquired\b/i
  ];
  if (acquisitionPatterns.some(pattern => pattern.test(headline))) {
    score += 10;
  }

  // Strong: Founder (8 points)
  if (/\bfounder\b/i.test(headline)) {
    score += 8;
  }

  // Strong: Member of Technical Staff (8 points)
  if (/member of technical staff/i.test(headline) || /\bmts\b/i.test(headline)) {
    score += 8;
  }

  // Good: Working on something new, building, stealth (5 points each)
  if (/\bworking on something new\b/i.test(headline)) {
    score += 5;
  }
  if (/\bstealth\b/i.test(headline)) {
    score += 5;
  }
  // Building is good, but exclude "building X for Y" (employee context)
  if (/\bbuilding\b/i.test(headline) && !/\bbuilding\b.*\bfor\b/i.test(headline)) {
    score += 5;
  }

  // Good: Entrepreneur (5 points)
  if (/\bentrepreneur\b/i.test(headline)) {
    score += 5;
  }

  return score;
}

// Helper function to create person card HTML
function createPersonCardHTML(person) {
  const fullName = person.full_name || "Unknown";
  const headline = person.headline || "";
  const location = person.location || "";
  const currentCompany = person.current_company_name || "";
  const skills = parseArrayOrString(person.skills);
  const highlightList = parseArrayOrString(person.computed_highlight_list);

  return `
    <div class="space-y-2">
      <div>
        <h3 class="font-semibold text-brand text-lg">${fullName}</h3>
        ${headline ? `<p class="text-xs text-gray-600 mt-0.5">${headline}</p>` : ""}
      </div>
      
      ${location || currentCompany ? `
        <div class="flex flex-wrap gap-x-4 gap-y-1 text-xs text-gray-600">
          ${location ? `<span>📍 ${location}</span>` : ""}
          ${currentCompany ? `<span>🏢 ${currentCompany}</span>` : ""}
        </div>
      ` : ""}
      
      ${highlightList.length > 0 ? `
        <div class="flex flex-wrap gap-1">
          ${highlightList.slice(0, 3).map(h => `<span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">${h}</span>`).join("")}
          ${highlightList.length > 3 ? `<span class="text-xs text-gray-500">+${highlightList.length - 3} more</span>` : ""}
        </div>
      ` : ""}
      
      ${skills.length > 0 ? `
        <div class="flex flex-wrap gap-1">
          ${skills.slice(0, 2).map(s => `<span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full">${s}</span>`).join("")}
          ${skills.length > 2 ? `<span class="text-xs text-gray-500">+${skills.length - 2} more</span>` : ""}
        </div>
      ` : ""}
    </div>
  `;
}

// Load and display interesting people
async function loadInterestingPeople() {
  const loadingEl = $("peopleLoading");
  const resultsEl = $("peopleResults");
  const scrollEl = $("peopleScroll");

  if (!loadingEl || !resultsEl || !scrollEl) return;

  loadingEl.classList.remove("hidden");
  resultsEl.classList.add("hidden");
  scrollEl.innerHTML = "";

  try {
    const res = await fetch(`${API_URL}/api/interesting-people`);
    const json = await res.json();

    if (!json.success) {
      throw new Error(json.error || "Failed to load people");
    }

    let people = json.data || [];
    loadingEl.classList.add("hidden");

    if (!people.length) {
      resultsEl.classList.remove("hidden");
      scrollEl.innerHTML = `<p class="text-gray-500 px-4">No people found.</p>`;
      return;
    }

    // Score and sort people by interest score (highest first)
    people = people.map(person => ({
      ...person,
      _interestScore: scorePersonInterest(person)
    })).sort((a, b) => b._interestScore - a._interestScore);

    // Display people
    people.forEach((person, index) => {
      const card = document.createElement("div");
      card.className = "bg-gray-50 border border-gray-200 rounded-lg p-4 hover:shadow-md cursor-pointer transition-shadow";
      card.innerHTML = createPersonCardHTML(person);
      card.addEventListener("click", () => openPersonModal(person));
      scrollEl.appendChild(card);
    });

    resultsEl.classList.remove("hidden");

    // Automatically open the first person's details
    if (people.length > 0) {
      openPersonModal(people[0]);
    }
  } catch (err) {
    console.error("Failed to load interesting people", err);
    loadingEl.classList.add("hidden");
    resultsEl.classList.remove("hidden");
    scrollEl.innerHTML = `<p class="text-red-500 px-4">Error loading people: ${err.message}</p>`;
  }
}

// Open person detail modal
function openPersonModal(person) {
  const panel = $("personDetailPanel");
  const title = $("personDetailTitle");
  const body = $("personDetailBody");

  if (!panel || !title || !body) return;

  // Set title and headline
  if (person.headline) {
    title.innerHTML = `<div>${person.full_name || "Person Details"}</div><div class="text-sm font-normal text-gray-600 mt-1">${person.headline}</div>`;
  } else {
    title.textContent = person.full_name || "Person Details";
  }

  let html = `<div class="space-y-3 text-sm text-gray-700">`;

  // Main fields (excluding Full Name, Headline, LinkedIn ID, and Aviato ID)
  const fields = [
    ["Location", person.location],
    ["Current Company", person.current_company_name],
    ["LinkedIn", person.linkedin_url ? `<a href="https://${person.linkedin_url}" target="_blank" class="text-blue-600 underline hover:text-blue-800">${person.linkedin_url}</a>` : null],
    ["Last Updated", person.last_updated ? new Date(person.last_updated).toLocaleDateString() : null],
  ];

  for (const [label, value] of fields) {
    if (value) {
      html += `<p><strong>${label}:</strong> ${value}</p>`;
    }
  }

  // Highlight list
  const highlightList = parseArrayOrString(person.computed_highlight_list);
  if (highlightList.length > 0) {
    html += `<div class="mt-3"><strong class="text-gray-700">Highlights:</strong><div class="flex flex-wrap gap-2 mt-2">`;
    highlightList.forEach(h => {
      html += `<span class="text-xs bg-amber-100 text-amber-700 px-2 py-1 rounded-full">${h}</span>`;
    });
    html += `</div></div>`;
  }

  // Skills
  const skills = parseArrayOrString(person.skills);
  if (skills.length > 0) {
    html += `<div class="mt-3"><strong class="text-gray-700">Skills:</strong><div class="flex flex-wrap gap-2 mt-2">`;
    skills.forEach(skill => {
      html += `<span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full">${skill}</span>`;
    });
    html += `</div></div>`;
  }

  html += `</div>`;
  body.innerHTML = html;

  panel.classList.remove("hidden");
}

// ---------------------------------------------------------------------
// PROSPECTING FUNCTIONS
// ---------------------------------------------------------------------

// Store current prospecting results for export
let currentProspectingResults = [];

// Helper function to validate single value (no commas, semicolons, or multiple entries)
function validateSingleValue(value, fieldName) {
  if (!value) return null; // Empty is allowed
  
  // Check for commas or semicolons (common separators)
  if (value.includes(',') || value.includes(';')) {
    return `${fieldName} must contain only one value. Please remove commas or semicolons.`;
  }
  
  // Check for pipe separator
  if (value.includes('|')) {
    return `${fieldName} must contain only one value. Please remove pipe characters.`;
  }
  
  return null; // Valid
}

// Build query function - matches backend logic
function buildQuery(keywords, role, company) {
  return `site:linkedin.com/in/ "${keywords} ${role} ${company}"`;
}

// Search prospects function - performs actual Google search
async function searchProspects() {
  // Hide previous errors
  const errorBox = $("prospectingErrorBox");
  errorBox.classList.add("hidden");
  errorBox.textContent = "";

  const keywords = $("prospectingKeywords").value.trim();
  const role = $("prospectingRole").value.trim();
  const company = $("prospectingCompany").value.trim();

  // Validate single values
  const errors = [];
  const keywordError = validateSingleValue(keywords, "Keywords");
  if (keywordError) errors.push(keywordError);
  
  const roleError = validateSingleValue(role, "Role");
  if (roleError) errors.push(roleError);
  
  const companyError = validateSingleValue(company, "Company Name");
  if (companyError) errors.push(companyError);

  // Show errors if any
  if (errors.length > 0) {
    errorBox.textContent = errors.join(" ");
    errorBox.classList.remove("hidden");
    return; // Stop execution
  }

  // Show loading state
  $("prospectingLoading").classList.remove("hidden");
  $("prospectingResults").classList.add("hidden");
  $("prospectingScroll").innerHTML = "";

  try {
    const API_URL = "";
    const response = await fetch(`${API_URL}/api/prospecting/search`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ keywords, role, company }),
    });

    const data = await response.json();

    if (!data.success) {
      throw new Error(data.error || "Search failed");
    }

    // Store results for export
    currentProspectingResults = data.data || [];
    
    // Display results
    $("prospectingLoading").classList.add("hidden");
    displayProspectingResults(currentProspectingResults);
    
    // Log query for debugging
    console.log("Search query:", data.query);
    console.log("Results count:", currentProspectingResults.length);

  } catch (err) {
    console.error("Prospecting search error:", err);
    $("prospectingLoading").classList.add("hidden");
    $("prospectingResults").classList.remove("hidden");
    errorBox.textContent = `Error: ${err.message}`;
    errorBox.classList.remove("hidden");
    $("prospectingScroll").innerHTML = `
      <p class="text-red-500 px-4">Error: ${err.message}</p>
    `;
  }
}

// Helper function to display prospecting results
function displayProspectingResults(results) {
  const scroll = $("prospectingScroll");
  scroll.innerHTML = "";

  if (!results || results.length === 0) {
    scroll.innerHTML = `<p class="text-gray-500 px-4 py-8 text-center">No results found.</p>`;
    $("prospectingResults").classList.remove("hidden");
    $("exportCsvBtn").classList.add("hidden");
    $("prospectingResultsHeader").textContent = "";
    return;
  }

  // Update result count header and show export button
  $("prospectingResultsHeader").textContent = `Found ${results.length} result${results.length !== 1 ? 's' : ''}`;
  $("exportCsvBtn").classList.remove("hidden");

  // Display all results
  results.forEach((result, index) => {
    const card = document.createElement("div");
    card.className = "bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow";
    
    const name = result.name || "Unknown";
    const jobTitle = result.job_title || "";
    const company = result.company || "";
    const link = result.link || "";
    const description = result.description || "";
    
    card.innerHTML = `
      <div class="space-y-2">
        <div class="flex items-start justify-between">
          <div class="flex-1">
            <h3 class="font-semibold text-brand text-lg">${name}</h3>
            ${jobTitle ? `<p class="text-sm text-gray-700 mt-1">${jobTitle}</p>` : ""}
          </div>
          ${link ? `<a href="${link}" target="_blank" rel="noopener noreferrer" 
                      class="ml-4 text-blue-600 hover:text-blue-800 text-sm font-medium whitespace-nowrap">
                      View Profile →
                    </a>` : ""}
        </div>
        ${description ? `<p class="text-xs text-gray-500 mt-2">${description}</p>` : ""}
      </div>
    `;
    scroll.appendChild(card);
  });

  $("prospectingResults").classList.remove("hidden");
  
  // Log to console for debugging
  console.log(`Displayed ${results.length} results`);
}

// Export prospecting results to CSV
function exportProspectingResultsToCSV() {
  if (!currentProspectingResults || currentProspectingResults.length === 0) {
    alert("No results to export");
    return;
  }

  // Define CSV headers
  const headers = ["Name", "Job Title", "Company", "LinkedIn URL", "Description"];
  
  // Convert results to CSV rows
  const csvRows = [
    headers.join(","), // Header row
    ...currentProspectingResults.map(result => {
      const escapeCSV = (field) => {
        if (!field) return "";
        // Escape quotes and wrap in quotes if contains comma, quote, or newline
        const str = String(field);
        if (str.includes(",") || str.includes('"') || str.includes("\n")) {
          return `"${str.replace(/"/g, '""')}"`;
        }
        return str;
      };
      
      return [
        escapeCSV(result.name || ""),
        escapeCSV(result.job_title || ""),
        escapeCSV(result.company || ""),
        escapeCSV(result.link || ""),
        escapeCSV(result.description || "")
      ].join(",");
    })
  ];

  // Create CSV content
  const csvContent = csvRows.join("\n");
  
  // Create blob and download
  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  const url = URL.createObjectURL(blob);
  
  // Generate filename with timestamp
  const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, "-");
  link.setAttribute("href", url);
  link.setAttribute("download", `prospecting_results_${timestamp}.csv`);
  link.style.visibility = "hidden";
  
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  // Clean up the URL object
  URL.revokeObjectURL(url);
}

</script>


</body>
</html>
