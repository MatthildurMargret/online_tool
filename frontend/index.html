<!DOCTYPE html>
<html lang="en">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Valuation Tool</title>
        <link rel="icon" type="image/png" href="favicon.png" />
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .animate-fadeIn {
                animation: fadeIn 0.3s ease-out;
            }
            /* Custom brand colors */
            .btn-primary {
                background-color: #161f6d;
            }
            .btn-primary:hover {
                background-color: #0f1751;
            }
            .text-brand {
                color: #131f72;
            }
        </style>
    </head>
<body class="bg-gray-50 min-h-screen">
    <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 py-12 px-4">
        <div class="max-w-5xl mx-auto">
            <!-- Header spacing -->
            <div class="mb-16"></div>

            <!-- Primary layout: left = compact individual stock search, right = industry comparison -->
            <!-- Note: We keep IDs so existing JS continues to work. Tabs are removed. -->
            

            <!-- Responsive grid wrapper for search modules -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 max-w-4xl mx-auto">
            
            <!-- Stock Search Box (compact, left column) -->
            <div id="stockSearchBox" class="bg-white rounded-lg shadow-md p-4 md:p-6 md:col-span-1 flex flex-col">
                <!-- Search Input -->
                <div class="flex flex-col gap-3 mb-4">
                    <input 
                        type="text" 
                        id="tickerInput" 
                        placeholder="Enter ticker symbol" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        onkeypress="if(event.key === 'Enter') fetchIncomeStatement()"
                    >
                    <button 
                        onclick="fetchIncomeStatement()"
                        class="w-full px-4 py-3 btn-primary text-white rounded-lg transition-colors font-semibold"
                    >
                        Search
                    </button>
                </div>

                <!-- Loading State -->
                <div id="stockLoadingInline" class="hidden text-center py-6">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    <p class="mt-2 text-sm text-gray-600">Loading...</p>
                </div>

                <!-- Error State -->
                <div id="stockErrorInline" class="hidden bg-red-50 border border-red-200 rounded-lg p-3">
                    <p class="text-sm text-red-800" id="stockErrorMessageInline"></p>
                </div>

                <!-- Results State -->
                <div id="stockResultsInline" class="hidden border-t border-gray-200 pt-4 flex flex-col flex-1">
                    <!-- Company Header with Price -->
                    <div class="mb-3">
                        <div class="flex items-start justify-between gap-2 mb-1">
                            <h3 class="text-base font-bold text-brand flex-1" id="stockCompanyNameInline"></h3>
                            <div id="stockPriceInline" class="hidden text-right">
                                <p class="text-xl font-bold text-green-600" id="stockPriceValueInline">-</p>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500" id="stockPeriodInline"></p>
                        <p class="text-xs text-gray-400 mt-0.5" id="stockPriceTimestampInline"></p>
                    </div>

                    <!-- Key Ratios -->
                    <div id="stockRatiosInline" class="hidden space-y-2 mb-3 flex-1">
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div class="bg-gray-50 rounded p-2">
                                <p class="text-gray-500 mb-0.5">P/E (TTM)</p>
                                <p class="font-semibold text-gray-800" id="ratioPE">-</p>
                            </div>
                            <div class="bg-gray-50 rounded p-2">
                                <p class="text-gray-500 mb-0.5">P/S (TTM)</p>
                                <p class="font-semibold text-gray-800" id="ratioPS">-</p>
                            </div>
                            <div class="bg-gray-50 rounded p-2">
                                <p class="text-gray-500 mb-0.5">P/B Ratio</p>
                                <p class="font-semibold text-gray-800" id="ratioPB">-</p>
                            </div>
                            <div class="bg-gray-50 rounded p-2">
                                <p class="text-gray-500 mb-0.5">ROE</p>
                                <p class="font-semibold text-gray-800" id="ratioROE">-</p>
                            </div>
                        </div>
                    </div>

                    <!-- View Details Button -->
                    <button 
                        onclick="openStockDetailsModal()"
                        class="w-full mt-auto px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm font-medium"
                    >
                        View Full Details →
                    </button>
                </div>
            </div>

            <!-- Industry Search Box (primary, right content) -->
            <div id="industrySearchBox" class="bg-white rounded-lg shadow-md p-6 md:col-span-2 flex flex-col">
                <h2 class="text-base font-bold text-brand mb-4">Industry Comparison Table</h2>
                <div class="space-y-5 flex-1 flex flex-col">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Industry</label>
                        <select 
                            id="industrySelect" 
                            onchange="updateSectorOptions()"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                            <option value="">-- Select Industry --</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Sector</label>
                        <select 
                            id="sectorSelect" 
                            onchange="updateIndustryGroupOptions()"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            disabled
                        >
                        </select>
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Industry Group (Optional)</label>
                        <select 
                            id="industryGroupSelect" 
                            disabled 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-100"
                        >
                            <option value="">-- All Groups in Sector --</option>
                        </select>
                    </div>
                    
                    <button 
                        onclick="fetchIndustryComparison()" 
                        class="w-full btn-primary text-white py-3 px-6 rounded-lg transition-colors font-semibold mt-auto"
                    >
                        Compare Companies
                    </button>
                </div>
            </div>

            </div> <!-- end grid wrapper -->

        </div>

        <!-- Modal Overlay -->
        <div id="modalOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40" onclick="closeModal()"></div>

        <!-- Modal Content -->
        <div id="modal" class="hidden fixed inset-4 md:inset-8 bg-white rounded-lg shadow-2xl z-50 overflow-hidden flex flex-col">
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-6 flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold" id="modalCompanyName">Company Name</h2>
                    <p class="text-blue-100 mt-1">
                        <span class="font-semibold" id="modalTicker"></span> • 
                        <span id="modalPeriod"></span>
                    </p>
                </div>
                <button 
                    onclick="closeModal()"
                    class="text-white hover:text-gray-200 transition-colors text-3xl leading-none"
                >
                    ×
                </button>
            </div>

            <!-- Loading Indicator -->
            <div id="loading" class="hidden text-center py-12">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                <p class="mt-4 text-gray-600">Fetching data from SEC Edgar...</p>
            </div>

            <!-- Error Message -->
            <div id="error" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 m-6">
                <p class="text-red-800" id="errorMessage"></p>
            </div>

            <!-- Modal Body (Scrollable) -->
            <div id="modalBody" class="flex-1 overflow-y-auto p-6">
                <!-- Results will be inserted here -->
                <div id="results" class="hidden">
            <!-- Company Info -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800" id="companyName"></h2>
                <p class="text-gray-600 mt-1">
                    <span class="font-semibold" id="ticker"></span> • 
                    <span id="period"></span>
                </p>
            </div>

            <!-- Stock Price -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div id="stockPriceSection" class="hidden flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-2">Latest Trade Price</p>
                        <p class="text-3xl font-bold text-gray-800" id="stockPrice">-</p>
                    </div>
                    <p class="text-xs text-gray-500" id="stockTimestamp">-</p>
                </div>
            </div>

            <!-- Income Statement Table -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800">Income Statement</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100 border-b border-gray-200">
                            <tr id="tableHeader">
                                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700 sticky left-0 bg-gray-100">Line Item</th>
                                <!-- Period columns will be inserted here -->
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="hidden" id="additionalFinancialData">
                <!-- Additional financial data will be inserted here -->
            </div>

            </div>
        </div>
    </div>

    <script>
        // Use relative URL so it works regardless of how you access it
        const API_URL = '';

        // Store industry map data
        let industryMapData = null;

        // Load industry map on page load
        async function loadIndustryMap() {
            try {
                const response = await fetch(`${API_URL}/api/industry-map`);
                const result = await response.json();
                
                if (result.success) {
                    industryMapData = result.data;
                    populateIndustryDropdown();
                }
            } catch (error) {
                console.error('Error loading industry map:', error);
            }
        }

        function populateIndustryDropdown() {
            const industrySelect = document.getElementById('industrySelect');
            const industries = Object.keys(industryMapData.industries).sort();
            
            industries.forEach(industry => {
                const option = document.createElement('option');
                option.value = industry;
                option.textContent = industry;
                industrySelect.appendChild(option);
            });
        }

        function updateSectorOptions() {
            const industrySelect = document.getElementById('industrySelect');
            const sectorSelect = document.getElementById('sectorSelect');
            const industryGroupSelect = document.getElementById('industryGroupSelect');
            
            // Reset dependent dropdowns
            sectorSelect.innerHTML = '<option value="">-- Select Sector --</option>';
            industryGroupSelect.innerHTML = '<option value="">-- Select Industry Group --</option>';
            industryGroupSelect.disabled = true;
            
            const selectedIndustry = industrySelect.value;
            
            if (!selectedIndustry) {
                sectorSelect.disabled = true;
                return;
            }
            
            sectorSelect.disabled = false;
            
            const sectors = Object.keys(industryMapData.industries[selectedIndustry].sectors).sort();
            sectors.forEach(sector => {
                const option = document.createElement('option');
                option.value = sector;
                option.textContent = sector;
                sectorSelect.appendChild(option);
            });
        }

        function updateIndustryGroupOptions() {
            const industrySelect = document.getElementById('industrySelect');
            const sectorSelect = document.getElementById('sectorSelect');
            const industryGroupSelect = document.getElementById('industryGroupSelect');
            
            // Reset industry group dropdown
            industryGroupSelect.innerHTML = '<option value="">-- Select Industry Group --</option>';
            
            const selectedIndustry = industrySelect.value;
            const selectedSector = sectorSelect.value;
            
            if (!selectedSector) {
                industryGroupSelect.disabled = true;
                return;
            }
            
            industryGroupSelect.disabled = false;
            
            const industryGroups = Object.keys(
                industryMapData.industries[selectedIndustry].sectors[selectedSector].industry_groups
            ).sort();
            
            industryGroups.forEach(group => {
                const option = document.createElement('option');
                option.value = group;
                option.textContent = group;
                industryGroupSelect.appendChild(option);
            });
        }

        function switchTab(tab) {
            const stockTab = document.getElementById('stockTab');
            const industryTab = document.getElementById('industryTab');
            const stockSearchBox = document.getElementById('stockSearchBox');
            const industrySearchBox = document.getElementById('industrySearchBox');
            
            if (tab === 'stock') {
                stockTab.classList.add('border-blue-600', 'text-blue-600');
                stockTab.classList.remove('border-transparent', 'text-gray-600');
                industryTab.classList.remove('border-blue-600', 'text-blue-600');
                industryTab.classList.add('border-transparent', 'text-gray-600');
                
                stockSearchBox.classList.remove('hidden');
                industrySearchBox.classList.add('hidden');
            } else {
                industryTab.classList.add('border-blue-600', 'text-blue-600');
                industryTab.classList.remove('border-transparent', 'text-gray-600');
                stockTab.classList.remove('border-blue-600', 'text-blue-600');
                stockTab.classList.add('border-transparent', 'text-gray-600');
                
                industrySearchBox.classList.remove('hidden');
                stockSearchBox.classList.add('hidden');
            }
            
            // Close modal if open
            closeModal();
        }

        async function fetchIndustryComparison() {
            const industrySelect = document.getElementById('industrySelect');
            const sectorSelect = document.getElementById('sectorSelect');
            const industryGroupSelect = document.getElementById('industryGroupSelect');
            
            const industry = industrySelect.value;
            const sector = sectorSelect.value;
            const industryGroup = industryGroupSelect.value;
            
            if (!industry || !sector) {
                showError('Please select at least an industry and sector');
                return;
            }
            
            // Get tickers - either from specific industry group or all groups in sector
            let tickers = [];
            let displayName = '';
            
            if (industryGroup) {
                // Specific industry group selected
                tickers = industryMapData.industries[industry].sectors[sector].industry_groups[industryGroup];
                displayName = industryGroup;
            } else {
                // No industry group - get all tickers from all groups in this sector
                const industryGroups = industryMapData.industries[industry].sectors[sector].industry_groups;
                for (const group in industryGroups) {
                    tickers = tickers.concat(industryGroups[group]);
                }
                displayName = sector;
            }
            
            if (!tickers || tickers.length === 0) {
                showError('No companies found in this selection');
                return;
            }
            
            // Open modal
            openModal();
            
            // Update modal header
            document.getElementById('modalCompanyName').textContent = displayName;
            document.getElementById('modalTicker').textContent = `${industry} > ${sector}`;
            document.getElementById('modalPeriod').textContent = `Loading ${tickers.length} companies...`;
            
            // Hide previous results and errors
            const resultsEl = document.getElementById('results');
            if (resultsEl) resultsEl.classList.add('hidden');
            const errorEl = document.getElementById('error');
            if (errorEl) errorEl.classList.add('hidden');
            
            // Show progressive loading UI
            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <div class="space-y-6">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">${displayName}</h3>
                        <p class="text-sm text-gray-600">Loading companies with real-time prices...</p>
                        <div class="mt-2">
                            <div class="flex items-center justify-between text-sm text-gray-600 mb-1">
                                <span id="progressText">0 / ${tickers.length}</span>
                                <span id="progressPercent">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="progressBar" class="btn-primary h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-md overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-100 border-b border-gray-200">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Ticker</th>
                                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Company</th>
                                        <th class="px-6 py-3 text-right text-sm font-semibold text-gray-700">Market Cap</th>
                                        <th class="px-6 py-3 text-right text-sm font-semibold text-gray-700">Revenue (TTM)</th>
                                        <th class="px-6 py-3 text-right text-sm font-semibold text-gray-700">P/S (TTM)</th>
                                        <th class="px-6 py-3 text-right text-sm font-semibold text-gray-700">P/E (TTM)</th>
                                        <th class="px-6 py-3 text-right text-sm font-semibold text-gray-700">P/B</th>
                                        <th class="px-6 py-3 text-right text-sm font-semibold text-gray-700">D/E</th>
                                    </tr>
                                </thead>
                                <tbody id="comparisonTableBody" class="divide-y divide-gray-200">
                                    <!-- Companies will appear here as they load -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            // Start streaming
            try {
                comparisonActive = true;
                // Create abortable stream fetch
                streamController = new AbortController();
                const response = await fetch(`${API_URL}/api/industry-comparison-stream`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ tickers: tickers }),
                    signal: streamController.signal
                });
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                const companies = [];
                
                while (true) {
                    const {done, value} = await reader.read();
                    
                    if (done) break;
                    
                    buffer += decoder.decode(value, {stream: true});
                    const lines = buffer.split('\n');
                    buffer = lines.pop(); // Keep incomplete line in buffer
                    
                    for (const line of lines) {
                        if (!line.trim()) continue;
                        
                        try {
                            const message = JSON.parse(line);
                            
                            if (message.type === 'company') {
                                companies.push(message.data);
                                addCompanyRow(message.data);
                            } else if (message.type === 'progress') {
                                updateProgress(message.processed, message.total);
                            } else if (message.type === 'complete') {
                                finishComparison(companies, displayName);
                            }
                        } catch (e) {
                            console.error('Error parsing message:', e, line);
                        }
                    }
                }
            } catch (error) {
                showError('Failed to connect to the server. Make sure the backend is running.');
                console.error('Error:', error);
            }
        }
        
        async function addCompanyRow(company) {
            const tbody = document.getElementById('comparisonTableBody');
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50 animate-fadeIn';
            row.setAttribute('data-ticker', company.ticker);
            
            // Add warning indicator if present
            const warningIcon = company.warnings && company.warnings.length > 0 
                ? `<span title="${company.warnings.join('; ')}" class="text-yellow-600 cursor-help">⚠️</span>` 
                : '';
            
            row.innerHTML = `
                <td class="px-6 py-4 text-sm font-medium text-blue-600">${company.ticker} ${warningIcon}</td>
                <td class="px-6 py-4 text-sm text-gray-800">${company.company_name}</td>
                <td class="px-6 py-4 text-sm text-gray-800 text-right">${formatCurrency(company.market_cap)}</td>
                <td class="px-6 py-4 text-sm text-gray-800 text-right">${formatCurrency(company.revenue)}</td>
                <td class="px-6 py-4 text-sm text-gray-800 text-right">${company.ps_ratio ? company.ps_ratio.toFixed(2) + 'x' : 'N/A'}</td>
                <td class="px-6 py-4 text-sm text-gray-800 text-right" data-field="pe">…</td>
                <td class="px-6 py-4 text-sm text-gray-800 text-right" data-field="pb">…</td>
                <td class="px-6 py-4 text-sm text-gray-800 text-right" data-field="de">…</td>
            `;
            tbody.appendChild(row);
            // Fetch stored financial metrics for ratios with throttling and abort/timeout
            enqueueFinancialTask(async (signal) => {
                if (!comparisonActive) return;
                try {
                    const resp = await fetch(`${API_URL}/api/stored-metrics/${company.ticker}`, { signal });
                    const result = await resp.json();
                    if (!result.success) return;

                    const data = result.data;
                    const metrics = data.metrics || {};
                    // Helper to pick the latest non-null value, prefer matching company.period_end_date
                    const periods = Array.isArray(data.periods) ? data.periods : [];
                    const prefer = company.period_end_date || null;
                    const pickValue = (map) => {
                        if (!map) return null;
                        if (prefer && map.hasOwnProperty(prefer) && map[prefer] !== null && map[prefer] !== undefined) {
                            return map[prefer];
                        }
                        for (const p of periods) {
                            if (map.hasOwnProperty(p) && map[p] !== null && map[p] !== undefined) {
                                return map[p];
                            }
                        }
                        return null;
                    };

                    const equity = pickValue(metrics.equity);
                    const debt = pickValue(metrics.debt);
                    const netIncome = pickValue(metrics.net_income);
                    const epsBasicMap = metrics.eps_basic || null;
                    const epsDilutedMap = metrics.eps_diluted || null;

                    const peCell = row.querySelector('[data-field="pe"]');
                    const pbCell = row.querySelector('[data-field="pb"]');
                    const deCell = row.querySelector('[data-field="de"]');

                    // Compute P/E using EPS TTM when possible
                    if (peCell) {
                        // Determine price: prefer stock_price from stream; else derive from market_cap/shares
                        const price = Number.isFinite(company.stock_price)
                            ? company.stock_price
                            : (Number.isFinite(company.market_cap) && Number.isFinite(company.shares_outstanding) && company.shares_outstanding !== 0
                                ? (company.market_cap / company.shares_outstanding)
                                : null);
                        let epsTTM = null;
                        let epsMethod = '';
                        
                        // Build ordered periods if available from stored metrics
                        const periods = Array.isArray(data.periods) ? data.periods.slice() : [];
                        // Ensure most recent first by string sort desc (ISO date strings)
                        periods.sort((a, b) => (a > b ? -1 : a < b ? 1 : 0));
                        const getEps = (p) => {
                            const b = epsBasicMap && epsBasicMap[p];
                            const d = epsDilutedMap && epsDilutedMap[p];
                            return Number.isFinite(b) ? b : (Number.isFinite(d) ? d : null);
                        };
                        
                        // Validate periods are consecutive quarters before summing
                        const isQuarterly = (p) => {
                            try {
                                const date = new Date(p);
                                const month = date.getMonth();
                                // Quarters typically end in Mar(2), Jun(5), Sep(8), Dec(11)
                                return [2, 5, 8, 11].includes(month);
                            } catch {
                                return false;
                            }
                        };
                        
                        const quarterlyPeriods = periods.filter(isQuarterly);
                        const annualPeriods = periods.filter(p => !isQuarterly(p));
                        
                        // Try to sum 4 consecutive quarters for TTM
                        if (quarterlyPeriods.length >= 4) {
                            const last4Quarters = quarterlyPeriods.slice(0, 4);
                            const epsValues = last4Quarters.map(getEps).filter(v => Number.isFinite(v));
                            if (epsValues.length === 4) {
                                epsTTM = epsValues.reduce((a, b) => a + b, 0);
                                epsMethod = 'TTM (4Q)';
                            }
                        }
                        
                        // Fallback to most recent annual
                        if (!Number.isFinite(epsTTM) && annualPeriods.length > 0) {
                            const annualEps = getEps(annualPeriods[0]);
                            if (Number.isFinite(annualEps)) {
                                epsTTM = annualEps;
                                epsMethod = 'Annual';
                            }
                        }
                        
                        // Last resort: use most recent period (don't annualize to avoid seasonal errors)
                        if (!Number.isFinite(epsTTM) && periods.length > 0) {
                            const latestEps = getEps(periods[0]);
                            if (Number.isFinite(latestEps)) {
                                epsTTM = latestEps;
                                epsMethod = 'Latest';
                            }
                        }
                        
                        const pe = (Number.isFinite(price) && Number.isFinite(epsTTM) && epsTTM > 0)
                            ? (price / epsTTM)
                            : null;
                        if (Number.isFinite(pe)) {
                            peCell.textContent = `${pe.toFixed(2)}x`;
                            peCell.dataset.value = String(pe);
                            peCell.title = `P/E based on ${epsMethod} EPS`;
                        } else if (Number.isFinite(epsTTM) && epsTTM <= 0) {
                            peCell.textContent = 'Neg.';
                            peCell.dataset.value = '';
                            peCell.title = 'Negative earnings';
                        } else {
                            peCell.textContent = 'N/A';
                            peCell.dataset.value = '';
                            peCell.title = 'EPS data not available';
                        }
                    }
                    if (pbCell) {
                        if (Number.isFinite(company.market_cap) && Number.isFinite(equity)) {
                            if (equity > 0) {
                                const pb = company.market_cap / equity;
                                pbCell.textContent = `${pb.toFixed(2)}x`;
                                pbCell.dataset.value = String(pb);
                                pbCell.title = 'Price-to-Book ratio';
                            } else if (equity < 0) {
                                pbCell.textContent = 'N/M';
                                pbCell.dataset.value = '';
                                pbCell.title = 'Negative equity - ratio not meaningful';
                            } else {
                                pbCell.textContent = 'N/A';
                                pbCell.dataset.value = '';
                                pbCell.title = 'Zero equity';
                            }
                        } else {
                            pbCell.textContent = 'N/A';
                            pbCell.dataset.value = '';
                            pbCell.title = 'Equity data not available';
                        }
                    }
                    if (deCell) {
                        if (Number.isFinite(debt) && Number.isFinite(equity)) {
                            if (equity > 0) {
                                const de = debt / equity;
                                deCell.textContent = `${de.toFixed(2)}x`;
                                deCell.dataset.value = String(de);
                                deCell.title = 'Debt-to-Equity ratio';
                            } else if (equity < 0) {
                                deCell.textContent = 'N/M';
                                deCell.dataset.value = '';
                                deCell.title = 'Negative equity - ratio not meaningful';
                            } else {
                                deCell.textContent = 'N/A';
                                deCell.dataset.value = '';
                                deCell.title = 'Zero equity';
                            }
                        } else {
                            deCell.textContent = 'N/A';
                            deCell.dataset.value = '';
                            deCell.title = 'Debt or equity data not available';
                        }
                    }
                    // Recompute averages whenever we fill a row
                    if (typeof window.recomputeAverages === 'function') {
                        window.recomputeAverages();
                    }
                } catch (_) {
                    // On error or abort, set placeholders
                    const peCell = row.querySelector('[data-field="pe"]');
                    const pbCell = row.querySelector('[data-field="pb"]');
                    const deCell = row.querySelector('[data-field="de"]');
                    if (peCell) peCell.textContent = 'N/A';
                    if (pbCell) pbCell.textContent = 'N/A';
                    if (deCell) deCell.textContent = 'N/A';
                }
            });
        }
        
        function updateProgress(processed, total) {
            const progressText = document.getElementById('progressText');
            const progressPercent = document.getElementById('progressPercent');
            const progressBar = document.getElementById('progressBar');
            
            if (progressText && progressPercent && progressBar) {
                const percent = Math.round((processed / total) * 100);
                progressText.textContent = `${processed} / ${total}`;
                progressPercent.textContent = `${percent}%`;
                progressBar.style.width = `${percent}%`;
            }
        }
        
        function finishComparison(companies, industryGroupName) {
            // Calculate averages
            const validData = companies.filter(d => d.market_cap !== null || d.revenue !== null);
            
            if (validData.length === 0) {
                showError('No financial data available for companies in this industry group');
                return;
            }
            
            const nums = (arr) => arr.filter(v => Number.isFinite(v));
            const safeMean = (arr) => arr.length ? (arr.reduce((a,b)=>a+b,0) / arr.length) : NaN;
            const marketCaps = nums(validData.map(d => d.market_cap));
            const revenues = nums(validData.map(d => d.revenue));
            const psValues = nums(validData.map(d => d.ps_ratio));
            const avgMarketCap = safeMean(marketCaps);
            const avgRevenue = safeMean(revenues);
            const avgPSRatio = safeMean(psValues);
            
            // Add average row
            const tbody = document.getElementById('comparisonTableBody');
            const avgRow = document.createElement('tr');
            avgRow.className = 'bg-blue-50 font-semibold';
            avgRow.innerHTML = `
                <td class="px-6 py-4 text-sm text-gray-900" colspan="2">Industry Average</td>
                <td class="px-6 py-4 text-sm text-gray-900 text-right">${Number.isFinite(avgMarketCap) ? formatCurrency(avgMarketCap) : 'N/A'}</td>
                <td class="px-6 py-4 text-sm text-gray-900 text-right">${Number.isFinite(avgRevenue) ? formatCurrency(avgRevenue) : 'N/A'}</td>
                <td class="px-6 py-4 text-sm text-gray-900 text-right">${Number.isFinite(avgPSRatio) ? (avgPSRatio.toFixed(2) + 'x') : 'N/A'}</td>
                <td class="px-6 py-4 text-sm text-gray-900 text-right" data-field="avg-pe">Calculating…</td>
                <td class="px-6 py-4 text-sm text-gray-900 text-right" data-field="avg-pb">Calculating…</td>
                <td class="px-6 py-4 text-sm text-gray-900 text-right" data-field="avg-de">Calculating…</td>
            `;
            tbody.appendChild(avgRow);
            
            // Update header
            document.getElementById('modalPeriod').textContent = `${validData.length} companies loaded`;

            // Define a reusable averages recompute function and call it periodically as rows fill
            window.recomputeAverages = () => {
                const rows = Array.from(document.querySelectorAll('#comparisonTableBody tr'));
                const valuesFrom = (attr) => rows
                    .map(r => {
                        const cell = r.querySelector(`[data-field="${attr}"]`);
                        const raw = cell && cell.dataset ? cell.dataset.value : undefined;
                        const v = parseFloat(raw);
                        return Number.isFinite(v) ? v : NaN;
                    })
                    .filter(v => Number.isFinite(v));
                const mean = (arr) => arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length) : NaN;
                const peVals = valuesFrom('pe');
                const pbVals = valuesFrom('pb');
                const deVals = valuesFrom('de');
                const avgPe = mean(peVals);
                const avgPb = mean(pbVals);
                const avgDe = mean(deVals);
                const setCell = (sel, val, suffix = 'x') => {
                    const el = document.querySelector(sel);
                    if (!el) return;
                    if (Number.isFinite(val)) {
                        el.textContent = `${val.toFixed(2)}${suffix}`;
                    } else {
                        el.textContent = 'N/A';
                    }
                };
                setCell('[data-field="avg-pe"]', avgPe, 'x');
                setCell('[data-field="avg-pb"]', avgPb, 'x');
                setCell('[data-field="avg-de"]', avgDe, 'x');
            };
            // Initial computation after creating average row
            window.recomputeAverages();
        }

        function displayIndustryComparison(comparisonResult, industryGroupName) {
            const data = comparisonResult.data;
            const missingTickers = comparisonResult.missing_tickers || [];
            
            // Filter out companies with no data
            const validData = data.filter(d => d.market_cap !== null || d.revenue !== null);
            
            if (validData.length === 0 && missingTickers.length === 0) {
                showError('No financial data available for companies in this industry group');
                return;
            }
            
            // Calculate averages
            const avgMarketCap = validData.filter(d => d.market_cap).reduce((sum, d) => sum + d.market_cap, 0) / validData.filter(d => d.market_cap).length;
            const avgRevenue = validData.filter(d => d.revenue).reduce((sum, d) => sum + d.revenue, 0) / validData.filter(d => d.revenue).length;
            const avgPSRatio = validData.filter(d => d.ps_ratio).reduce((sum, d) => sum + d.ps_ratio, 0) / validData.filter(d => d.ps_ratio).length;
            
            // Build the comparison table
            const modalBody = document.getElementById('modalBody');
            
            let missingTickersHTML = '';
            if (missingTickers.length > 0) {
                missingTickersHTML = `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <h4 class="text-sm font-semibold text-yellow-800 mb-2">⚠️ ${missingTickers.length} companies not cached</h4>
                                <p class="text-xs text-yellow-700 mb-2">These companies need to be cached before they can be displayed:</p>
                                <p class="text-xs text-yellow-600 font-mono">${missingTickers.join(', ')}</p>
                            </div>
                            <button 
                                onclick="cacheIndustryTickers(${JSON.stringify(missingTickers)})"
                                class="ml-4 px-4 py-2 bg-yellow-600 text-white text-sm rounded hover:bg-yellow-700 transition-colors whitespace-nowrap"
                            >
                                Cache Now
                            </button>
                        </div>
                    </div>
                `;
            }
            
            modalBody.innerHTML = `
                <div class="space-y-6">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">${industryGroupName}</h3>
                        <p class="text-sm text-gray-600">Showing ${validData.length} companies with available financial data</p>
                    </div>
                    
                    ${missingTickersHTML}
                    
                    <div class="bg-white rounded-lg shadow-md overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-100 border-b border-gray-200">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Ticker</th>
                                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Company</th>
                                        <th class="px-6 py-3 text-right text-sm font-semibold text-gray-700">Market Cap</th>
                                        <th class="px-6 py-3 text-right text-sm font-semibold text-gray-700">Revenue (TTM)</th>
                                        <th class="px-6 py-3 text-right text-sm font-semibold text-gray-700">P/S (TTM)</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${validData.map(company => `
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-6 py-4 text-sm font-medium text-blue-600">${company.ticker}</td>
                                            <td class="px-6 py-4 text-sm text-gray-800">${company.company_name}</td>
                                            <td class="px-6 py-4 text-sm text-gray-800 text-right">${formatCurrency(company.market_cap)}</td>
                                            <td class="px-6 py-4 text-sm text-gray-800 text-right">${formatCurrency(company.revenue)}</td>
                                            <td class="px-6 py-4 text-sm text-gray-800 text-right">${company.ps_ratio ? company.ps_ratio.toFixed(2) + 'x' : 'N/A'}</td>
                                        </tr>
                                    `).join('')}
                                    <tr class="bg-blue-50 font-semibold">
                                        <td class="px-6 py-4 text-sm text-gray-900" colspan="2">Industry Average</td>
                                        <td class="px-6 py-4 text-sm text-gray-900 text-right">${formatCurrency(avgMarketCap)}</td>
                                        <td class="px-6 py-4 text-sm text-gray-900 text-right">${formatCurrency(avgRevenue)}</td>
                                        <td class="px-6 py-4 text-sm text-gray-900 text-right">${avgPSRatio ? avgPSRatio.toFixed(2) + 'x' : 'N/A'}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            // Show results
            document.getElementById('results').classList.remove('hidden');
        }

        // --- Concurrency and cancellation for financial-data requests ---
        let comparisonActive = false;
        let maxConcurrentFinancial = 2;
        let currentFinancial = 0;
        let financialQueue = [];
        let streamController = null;

        function enqueueFinancialTask(task) {
            if (!comparisonActive) return; // don't start if comparison closed
            if (currentFinancial < maxConcurrentFinancial) {
                runFinancialTask(task);
            } else {
                financialQueue.push(task);
            }
        }

        function runFinancialTask(task) {
            currentFinancial++;
            // Wrap with timeout using AbortController
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 20000); // 20s timeout
            task(controller.signal)
                .catch(() => { /* swallow per-row errors */ })
                .finally(() => {
                    clearTimeout(timeoutId);
                    currentFinancial--;
                    if (!comparisonActive) {
                        financialQueue = [];
                        return;
                    }
                    if (financialQueue.length > 0) {
                        const next = financialQueue.shift();
                        runFinancialTask(next);
                    }
                });
        }

        async function cacheIndustryTickers(tickers) {
            // Show loading in modal
            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <div class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
                    <p class="text-gray-600 mb-2">Caching ${tickers.length} companies...</p>
                    <p class="text-sm text-gray-500">This may take a few minutes. Only annual (10-K) data is being fetched.</p>
                </div>
            `;
            
            try {
                const response = await fetch(`${API_URL}/api/cache-tickers`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ tickers: tickers })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Show success message
                    modalBody.innerHTML = `
                        <div class="text-center py-12">
                            <div class="text-6xl mb-4">✅</div>
                            <h3 class="text-2xl font-semibold text-gray-800 mb-4">Caching Complete!</h3>
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4 max-w-md mx-auto text-left">
                                <p class="text-sm text-green-800 mb-2"><strong>Cached:</strong> ${result.results.cached.length} companies</p>
                                <p class="text-sm text-blue-800 mb-2"><strong>Already cached:</strong> ${result.results.already_cached.length} companies</p>
                                <p class="text-sm text-red-800"><strong>Failed:</strong> ${result.results.failed.length} companies</p>
                            </div>
                            <button 
                                onclick="fetchIndustryComparison()"
                                class="mt-6 px-6 py-3 btn-primary text-white rounded-lg transition-colors"
                            >
                                Reload Comparison
                            </button>
                        </div>
                    `;
                } else {
                    showError('Failed to cache tickers: ' + result.error);
                }
            } catch (error) {
                showError('Failed to connect to the server.');
                console.error('Error:', error);
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                fetchIncomeStatement();
            }
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadIndustryMap();
            
            // Auto-load AAPL as default stock
            const tickerInput = document.getElementById('tickerInput');
            if (tickerInput) {
                tickerInput.value = 'AAPL';
                // Fetch AAPL data automatically
                fetchIncomeStatement();
            }
        });

        function formatCurrency(value) {
            if (value === null || value === undefined) {
                return 'N/A';
            }
            
            const absValue = Math.abs(value);
            
            // Format in billions if >= 1B
            if (absValue >= 1e9) {
                const billions = value / 1e9;
                return `$${billions.toFixed(2)}B`;
            }
            // Format in millions if >= 1M
            else if (absValue >= 1e6) {
                const millions = value / 1e6;
                return `$${millions.toFixed(2)}M`;
            }
            // Format in thousands if >= 1K
            else if (absValue >= 1e3) {
                const thousands = value / 1e3;
                return `$${thousands.toFixed(2)}K`;
            }
            // Format as regular number
            else {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(value);
            }
        }

        function formatPeriod(period) {
            try {
                const date = new Date(period);
                return date.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
            } catch {
                return period;
            }
        }

        async function fetchStockPrice(ticker) {
            try {
                const response = await fetch(`${API_URL}/api/stock-price/${ticker}`);
                const result = await response.json();
                
                if (result.success) {
                    displayStockPrice(result.data);
                } else {
                    console.warn('Stock price fetch failed:', result.error);
                    
                    // Show rate limit message if applicable
                    if (response.status === 429) {
                        const stockPriceSection = document.getElementById('stockPriceSection');
                        stockPriceSection.innerHTML = `
                            <div class="text-center py-4 text-yellow-600">
                                <p class="font-semibold">⚠️ Rate limit reached</p>
                                <p class="text-sm">Stock price temporarily unavailable. Please try again in a moment.</p>
                            </div>
                        `;
                        stockPriceSection.classList.remove('hidden');
                    } else {
                        // Don't show error for other cases, just hide the section
                        document.getElementById('stockPriceSection').classList.add('hidden');
                    }
                }
            } catch (error) {
                console.warn('Stock price fetch error:', error);
                document.getElementById('stockPriceSection').classList.add('hidden');
            }
        }

        async function fetchRecentFilings(ticker) {
            try {
                const response = await fetch(`${API_URL}/api/recent-filings/${ticker}`);
                const result = await response.json();
                
                if (result.success) {
                    displayRecentFilings(result.data);
                } else {
                    console.warn('Recent filings fetch failed:', result.error);
                    document.getElementById('recentFilings').innerHTML = '<p class="text-xs text-gray-500">Unable to load filings</p>';
                }
            } catch (error) {
                console.warn('Recent filings fetch error:', error);
                document.getElementById('recentFilings').innerHTML = '<p class="text-xs text-gray-500">Unable to load filings</p>';
            }
        }

        function openModal() {
            const overlay = document.getElementById('modalOverlay');
            if (overlay) overlay.classList.remove('hidden');
            const modal = document.getElementById('modal');
            if (modal) modal.classList.remove('hidden');
            const welcome = document.getElementById('welcomeMessage');
            if (welcome) welcome.classList.add('hidden');
            if (document && document.body) {
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
            }
        }

        function closeModal() {
            // Signal comparison to stop queuing more work and abort pending financial fetches
            comparisonActive = false;
            financialQueue = [];
            // Abort streaming request if active
            if (streamController) {
                try { streamController.abort(); } catch (_) {}
                streamController = null;
            }
            // Toggle elements defensively
            const overlay = document.getElementById('modalOverlay');
            if (overlay) overlay.classList.add('hidden');
            const modal = document.getElementById('modal');
            if (modal) modal.classList.add('hidden');
            if (document && document.body) {
                document.body.style.overflow = 'auto';
            }
            
            // Restore original modal structure if it was replaced by industry comparison
            const modalBody = document.getElementById('modalBody');
            if (modalBody && !document.getElementById('results')) {
                // The results container is missing - restore the original structure
                modalBody.innerHTML = `
                    <!-- Results will be inserted here -->
                    <div id="results" class="hidden">
                <!-- Company Info -->
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-2xl font-bold text-gray-800" id="companyName"></h2>
                    <p class="text-gray-600 mt-1">
                        <span class="font-semibold" id="ticker"></span> • 
                        <span id="period"></span>
                    </p>
                </div>

                <!-- Stock Price -->
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <div id="stockPriceSection" class="hidden flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-2">Latest Trade Price</p>
                            <p class="text-3xl font-bold text-gray-800" id="stockPrice">-</p>
                        </div>
                        <p class="text-xs text-gray-500" id="stockTimestamp">-</p>
                    </div>
                </div>

                <!-- Income Statement Table -->
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-800">Income Statement</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-100 border-b border-gray-200">
                                <tr id="tableHeader">
                                    <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700 sticky left-0 bg-gray-100">Line Item</th>
                                    <!-- Period columns will be inserted here -->
                                </tr>
                            </thead>
                            <tbody id="tableBody" class="divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="hidden" id="additionalFinancialData">
                    <!-- Additional financial data will be inserted here -->
                </div>

                </div>
                `;
            }
            
            const results = document.getElementById('results');
            if (results) results.classList.add('hidden');
            const loading = document.getElementById('loading');
            if (loading) loading.classList.add('hidden');
            const errorBox = document.getElementById('error');
            if (errorBox) errorBox.classList.add('hidden');
        }

        async function fetchIncomeStatement() {
            const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
            
            if (!ticker) {
                showStockErrorInline('Please enter a ticker symbol');
                return;
            }

            // Hide previous results and errors
            const resultsEl = document.getElementById('stockResultsInline');
            if (resultsEl) resultsEl.classList.add('hidden');
            const errorEl = document.getElementById('stockErrorInline');
            if (errorEl) errorEl.classList.add('hidden');
            
            // Show loading
            const loadingEl = document.getElementById('stockLoadingInline');
            if (loadingEl) loadingEl.classList.remove('hidden');

            try {
                const response = await fetch(`${API_URL}/api/income/${ticker}`);
                const result = await response.json();

                if (loadingEl) loadingEl.classList.add('hidden');

                if (!result.success) {
                    showStockErrorInline(result.error || 'Failed to fetch data');
                    return;
                }

                displayStockResultsInline(result.data, result.cached);
                
                // Fetch stock price in parallel
                fetchStockPriceInline(ticker);
            } catch (error) {
                if (loadingEl) loadingEl.classList.add('hidden');
                showStockErrorInline('Failed to connect to the server. Make sure the backend is running.');
                console.error('Error:', error);
            }
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('error').classList.remove('hidden');
        }

        function showStockErrorInline(message) {
            document.getElementById('stockErrorMessageInline').textContent = message;
            document.getElementById('stockErrorInline').classList.remove('hidden');
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('error').classList.remove('hidden');
        }

        function displayStockPrice(data) {
            // Store stock price for calculations
            currentStockPrice = data.price;
            
            // Format and display stock price data from Alpaca
            const priceEl = document.getElementById('stockPrice');
            const timestampEl = document.getElementById('stockTimestamp');
            
            priceEl.textContent = data.price ? `$${data.price.toFixed(2)}` : 'N/A';
            
            if (data.timestamp) {
                try {
                    const date = new Date(data.timestamp);
                    const now = new Date();
                    const diffMs = now - date;
                    const diffMins = Math.floor(diffMs / 60000);
                    
                    let timeText;
                    if (diffMins < 1) {
                        timeText = 'Just now';
                    } else if (diffMins < 60) {
                        timeText = `${diffMins} min ago`;
                    } else if (diffMins < 1440) {
                        const hours = Math.floor(diffMins / 60);
                        timeText = `${hours} hour${hours > 1 ? 's' : ''} ago`;
                    } else {
                        timeText = date.toLocaleString('en-US', { 
                            month: 'short', 
                            day: 'numeric',
                            hour: 'numeric',
                            minute: '2-digit'
                        });
                    }
                    
                    timestampEl.textContent = timeText;
                } catch {
                    timestampEl.textContent = '';
                }
            } else {
                timestampEl.textContent = '';
            }
            
            // Show the stock price section
            document.getElementById('stockPriceSection').classList.remove('hidden');
            
            // Recalculate ratios if we have financial data
            if (currentFinancialData) {
                addRevenueMultiples(currentFinancialData);
                // Re-render the table
                renderFinancialTable(currentFinancialData);
            }
        }

        async function fetchAdditionalFinancialData(ticker) {
            try {
                const response = await fetch(`${API_URL}/api/financial-data/${ticker}`);
                const result = await response.json();
                
                if (result.success) {
                    additionalFinancialData = result.data;
                    // Recalculate ratios with new data
                    if (currentFinancialData) {
                        addRevenueMultiples(currentFinancialData);
                        renderFinancialTable(currentFinancialData);
                    }
                } else {
                    console.warn('Additional financial data fetch failed:', result.error);
                }
            } catch (error) {
                console.warn('Additional financial data fetch error:', error);
            }
        }

        function addRevenueMultiples(data) {
            // Find key financial metrics
            const revenueContract = data.items.find(item => item.concept === 'us-gaap_RevenueFromContractWithCustomerExcludingAssessedTax');
            const revenueGeneric = data.items.find(item => item.concept === 'us-gaap_Revenues');
            // Helper: pick first non-null per period between contract revenue and generic revenues
            const revenueForPeriod = (period) => {
                const v1 = revenueContract && revenueContract.values ? revenueContract.values[period] : undefined;
                if (Number.isFinite(v1)) return v1;
                const v2 = revenueGeneric && revenueGeneric.values ? revenueGeneric.values[period] : undefined;
                return Number.isFinite(v2) ? v2 : null;
            };
            
            const sharesItem = data.items.find(item => 
                item.concept === 'us-gaap_WeightedAverageNumberOfSharesOutstandingBasic' ||
                item.concept === 'us-gaap_CommonStockSharesOutstanding'
            );
            
            const netIncomeItem = data.items.find(item => 
                item.concept === 'us-gaap_NetIncomeLoss'
            );

            const epsBasicItem = data.items.find(item => 
                item.concept === 'us-gaap_EarningsPerShareBasic'
            );

            const calculatedItems = [];

            // 1. Market Cap
            const marketCapItem = {
                label: '💰 Market Cap',
                concept: 'calculated_market_cap',
                values: {}
            };
            
            // Helper to get shares for a period with fallback to additionalFinancialData.metrics.shares
            const getShares = (period) => {
                const fromIncome = sharesItem && sharesItem.values ? sharesItem.values[period] : null;
                if (Number.isFinite(fromIncome)) return fromIncome;
                const sharesMap = (additionalFinancialData && additionalFinancialData.metrics) ? additionalFinancialData.metrics.shares : null;
                if (sharesMap && sharesMap.hasOwnProperty(period) && Number.isFinite(sharesMap[period])) return sharesMap[period];
                return null;
            };

            data.periods.forEach(period => {
                const shares = getShares(period);
                if (Number.isFinite(shares) && currentStockPrice) {
                    marketCapItem.values[period] = currentStockPrice * shares;
                }
            });
            calculatedItems.push(marketCapItem);
            
            // 2. Price-to-Sales (P/S) - Revenue Multiple
            if (revenueContract || revenueGeneric) {
                const psItem = {
                    label: '📊 Price-to-Sales (P/S TTM)',
                    concept: 'calculated_ps_ratio',
                    values: {}
                };
                
                data.periods.forEach(period => {
                    const revenue = revenueForPeriod(period);
                    const shares = getShares(period);
                    if (Number.isFinite(revenue) && Number.isFinite(shares) && currentStockPrice) {
                        const marketCap = currentStockPrice * shares;
                        const ps = marketCap / revenue;
                        psItem.values[period] = Number.isFinite(ps) ? ps : null;
                    }
                });
                calculatedItems.push(psItem);
            }
            
            // 3. Price-to-Earnings (P/E)
            if (epsBasicItem) {
                const peItem = {
                    label: '📈 Price-to-Earnings (P/E TTM)',
                    concept: 'calculated_pe_ratio',
                    values: {}
                };
                
                data.periods.forEach(period => {
                    const eps = epsBasicItem.values[period];
                    if (eps && eps > 0 && currentStockPrice) {
                        peItem.values[period] = currentStockPrice / eps;
                    }
                });
                calculatedItems.push(peItem);
            }
            
            // Additional ratios from balance sheet and cash flow data
            if (additionalFinancialData && additionalFinancialData.metrics) {
                const metrics = additionalFinancialData.metrics;
                
                // 4. Price-to-Book (P/B)
                if (metrics.equity) {
                    const pbItem = {
                        label: '📚 Price-to-Book (P/B)',
                        concept: 'calculated_pb_ratio',
                        values: {}
                    };
                    
                    data.periods.forEach(period => {
                        const equity = metrics.equity[period];
                        const shares = getShares(period);
                        if (Number.isFinite(equity) && Number.isFinite(shares) && currentStockPrice && shares > 0) {
                            const bookValuePerShare = equity / shares;
                            const pb = currentStockPrice / bookValuePerShare;
                            pbItem.values[period] = Number.isFinite(pb) ? pb : null;
                        }
                    });
                    calculatedItems.push(pbItem);
                }
                
                // 5. Debt-to-Equity (D/E)
                if (metrics.debt && metrics.equity) {
                    const deItem = {
                        label: '⚖️ Debt-to-Equity (D/E)',
                        concept: 'calculated_de_ratio',
                        values: {}
                    };
                    
                    data.periods.forEach(period => {
                        const debt = metrics.debt[period];
                        const equity = metrics.equity[period];
                        if (Number.isFinite(debt) && Number.isFinite(equity) && equity) {
                            const de = debt / equity;
                            deItem.values[period] = Number.isFinite(de) ? de : null;
                        }
                    });
                    calculatedItems.push(deItem);
                }
                
                // 7. Return on Equity (ROE)
                if (metrics.equity && netIncomeItem) {
                    const roeItem = {
                        label: '💎 Return on Equity (ROE)',
                        concept: 'calculated_roe',
                        values: {}
                    };
                    
                    data.periods.forEach(period => {
                        const netIncome = netIncomeItem.values[period];
                        const equity = metrics.equity[period];
                        
                        if (Number.isFinite(netIncome) && Number.isFinite(equity) && equity) {
                            const roe = (netIncome / equity) * 100;
                            roeItem.values[period] = Number.isFinite(roe) ? roe : null; // percentage
                        }
                    });
                    calculatedItems.push(roeItem);
                }
            }
            
            // Remove old calculated items if they exist
            data.items = data.items.filter(item => 
                !item.concept.startsWith('calculated_')
            );
            
            // Add new calculated items at the top
            data.items.unshift(...calculatedItems);
        }

        function isTotalRevenue(label, concept) {
            // Check if this is a total revenue line item (not a sub-component)
            if (!label || !concept) return false;
            
            // Main revenue concepts we accept
            const validConcepts = [
                'us-gaap_RevenueFromContractWithCustomerExcludingAssessedTax',
                'us-gaap_Revenues',
                'us-gaap_SalesRevenueNet',
                'us-gaap_Revenue'
            ];
            
            if (!validConcepts.includes(concept)) return false;
            
            // Convert label to lowercase for case-insensitive matching
            const labelLower = label.toLowerCase();
            
            // Exclude sub-components - these indicate it's NOT total revenue
            const exclusionKeywords = [
                'product',
                'service',
                'segment',
                'goods',
                'licensing',
                'subscription',
                'advertising',
                'cloud',
                'hardware',
                'software',
                'other',
                'domestic',
                'international',
                'related party',
                'affiliate'
            ];
            
            for (const keyword of exclusionKeywords) {
                if (labelLower.includes(keyword)) {
                    return false;
                }
            }
            
            return true;
        }

        function filterDuplicateRevenue(items, periods) {
            // Merge duplicate revenue items - combine values from all total revenue concepts into one row
            const revenueConcepts = [
                'us-gaap_RevenueFromContractWithCustomerExcludingAssessedTax',
                'us-gaap_Revenues',
                'us-gaap_SalesRevenueNet',
                'us-gaap_Revenue'
            ];
            
            const filtered = [];
            const revenueItems = [];
            
            for (const item of items) {
                // Always include calculated items
                if (item.concept && item.concept.startsWith('calculated_')) {
                    filtered.push(item);
                    continue;
                }
                
                // Collect revenue items that are total revenue (not sub-components)
                if (revenueConcepts.includes(item.concept) && isTotalRevenue(item.label, item.concept)) {
                    revenueItems.push(item);
                } else if (!revenueConcepts.includes(item.concept)) {
                    // Not a revenue item - include it
                    filtered.push(item);
                }
                // Skip revenue sub-components (they don't pass isTotalRevenue)
            }
            
            // Merge all total revenue items into one
            if (revenueItems.length > 0) {
                const mergedRevenue = {
                    label: 'Revenues',
                    concept: revenueItems[0].concept, // Use first concept found
                    values: {}
                };
                
                // For each period, use the first non-null revenue value we find
                if (periods && Array.isArray(periods)) {
                    periods.forEach(period => {
                        for (const revenueItem of revenueItems) {
                            const value = revenueItem.values[period];
                            if (value !== null && value !== undefined) {
                                mergedRevenue.values[period] = value;
                                break; // Use first non-null value for this period
                            }
                        }
                    });
                }
                
                // Insert merged revenue at the beginning (after calculated items)
                filtered.unshift(mergedRevenue);
            }
            
            return filtered;
        }

        function renderFinancialTable(data) {
            // Populate table body
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';

            // Filter out duplicate revenue items before rendering
            const filteredItems = filterDuplicateRevenue(data.items, data.periods);

            filteredItems.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                // Label cell
                const labelCell = document.createElement('td');
                labelCell.className = 'px-6 py-4 text-sm text-gray-800 sticky left-0 bg-white';
                labelCell.textContent = item.label;
                row.appendChild(labelCell);
                
                // Value cells for each period
                data.periods.forEach(period => {
                    const valueCell = document.createElement('td');
                    valueCell.className = 'px-6 py-4 text-sm text-gray-800 text-right font-medium';
                    const value = item.values[period];
                    
                    // Special formatting for calculated ratios
                    if (item.concept === 'calculated_ps_ratio' || 
                        item.concept === 'calculated_pe_ratio' ||
                        item.concept === 'calculated_pb_ratio' ||
                        item.concept === 'calculated_de_ratio' ||
                        item.concept === 'calculated_revenue_multiple') {
                        valueCell.textContent = Number.isFinite(value) ? `${value.toFixed(2)}x` : 'N/A';
                    } else if (item.concept === 'calculated_roe') {
                        // ROE as percentage
                        valueCell.textContent = Number.isFinite(value) ? `${value.toFixed(2)}%` : 'N/A';
                    } else {
                        valueCell.textContent = formatCurrency(value);
                    }
                    
                    row.appendChild(valueCell);
                });
                
                tableBody.appendChild(row);
            });
        }

        function displayStockPrice(data) {
            // Store stock price for calculations
            currentStockPrice = data.price;
            
            // Format and display stock price data from Alpaca
            const priceEl = document.getElementById('stockPrice');
            const timestampEl = document.getElementById('stockTimestamp');
            
            priceEl.textContent = data.price ? `$${data.price.toFixed(2)}` : 'N/A';
            
            if (data.timestamp) {
                try {
                    const date = new Date(data.timestamp);
                    const now = new Date();
                    const diffMs = now - date;
                    const diffMins = Math.floor(diffMs / 60000);
                    
                    let timeText;
                    if (diffMins < 1) {
                        timeText = 'Just now';
                    } else if (diffMins < 60) {
                        timeText = `${diffMins} min ago`;
                    } else if (diffMins < 1440) {
                        const hours = Math.floor(diffMins / 60);
                        timeText = `${hours} hour${hours > 1 ? 's' : ''} ago`;
                    } else {
                        timeText = date.toLocaleString('en-US', { 
                            month: 'short', 
                            day: 'numeric',
                            hour: 'numeric',
                            minute: '2-digit'
                        });
                    }
                    
                    timestampEl.textContent = timeText;
                } catch {
                    timestampEl.textContent = '';
                }
            } else {
                timestampEl.textContent = '';
            }
            
            // Show the stock price section
            const priceSection = document.getElementById('stockPriceSection');
            if (priceSection) priceSection.classList.remove('hidden');
            
            // Recalculate ratios if we have financial data
            if (currentFinancialData) {
                addRevenueMultiples(currentFinancialData);
                // Re-render the table
                renderFinancialTable(currentFinancialData);
            }
        }
        
        function displayRecentFilings(data) {
            const filingsContainer = document.getElementById('recentFilings');
            if (!filingsContainer || !data.filings) return;
            
            filingsContainer.innerHTML = '';
            
            data.filings.forEach(filing => {
                const filingEl = document.createElement('div');
                filingEl.className = 'flex justify-between items-center py-2 border-b border-gray-100 last:border-0';
                
                const formBadgeColor = filing.form === '10-K' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800';
                
                filingEl.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="px-2 py-0.5 ${formBadgeColor} text-xs font-medium rounded">${filing.form}</span>
                        <span class="text-xs text-gray-600">${formatPeriod(filing.period)}</span>
                    </div>
                    <span class="text-xs text-gray-500">${formatFilingDate(filing.filing_date)}</span>
                `;
                
                filingsContainer.appendChild(filingEl);
            });
        }

        function formatFilingDate(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric',
                    year: 'numeric'
                });
            } catch {
                return dateString;
            }
        }

        // Store current stock price and data for calculations
        let currentStockPrice = null;
        let currentFinancialData = null;
        let additionalFinancialData = null;

        function displayStockResultsInline(data, cached) {
            // Store data for modal view
            currentFinancialData = data;
            
            // Update company info in inline box
            const companyNameEl = document.getElementById('stockCompanyNameInline');
            if (companyNameEl) companyNameEl.textContent = `${data.company_name} (${data.ticker})`;
            
            // Handle old cache format (single period) vs new format (multiple periods)
            const isOldFormat = !data.periods && data.period;
            
            if (isOldFormat) {
                data.periods = [data.period];
                data.items = data.items.map(item => ({
                    label: item.label,
                    concept: item.concept,
                    values: { [data.period]: item.value }
                }));
            }
            
            // Format period display with data age indicator
            if (data.periods && data.periods.length > 0) {
                const latestPeriod = data.periods[0];
                let formattedPeriod = `${formatPeriod(latestPeriod)}`;
                
                // Add data age warning if period is old
                try {
                    const periodDate = new Date(latestPeriod);
                    const daysOld = Math.floor((new Date() - periodDate) / (1000 * 60 * 60 * 24));
                    if (daysOld > 180) {
                        formattedPeriod += ` ⚠️ ${Math.floor(daysOld / 30)} months old`;
                    } else if (daysOld > 90) {
                        formattedPeriod += ` (${Math.floor(daysOld / 30)} months old)`;
                    }
                } catch (e) {
                    // Ignore date parsing errors
                }
                
                const periodEl = document.getElementById('stockPeriodInline');
                if (periodEl) periodEl.textContent = formattedPeriod;
            }

            // Show results
            const resultsEl = document.getElementById('stockResultsInline');
            if (resultsEl) resultsEl.classList.remove('hidden');
            
            // Fetch additional financial data to calculate ratios
            fetchStockRatiosInline(data.ticker);
        }
        
        async function fetchStockRatiosInline(ticker) {
            try {
                const response = await fetch(`${API_URL}/api/stored-metrics/${ticker}`);
                const result = await response.json();
                
                // Always show the ratios grid
                const ratiosEl = document.getElementById('stockRatiosInline');
                if (ratiosEl) ratiosEl.classList.remove('hidden');

                // Initialize placeholders
                const setNA = () => {
                    const peEl = document.getElementById('ratioPE'); if (peEl) peEl.textContent = 'N/A';
                    const psEl = document.getElementById('ratioPS'); if (psEl) psEl.textContent = 'N/A';
                    const pbEl = document.getElementById('ratioPB'); if (pbEl) pbEl.textContent = 'N/A';
                    const roeEl = document.getElementById('ratioROE'); if (roeEl) roeEl.textContent = 'N/A';
                };
                setNA();

                if (!result.success) {
                    console.warn('Stored metrics fetch failed:', result.error);
                    return;
                }

                // If we don't yet have the financial data structure, wait for it
                if (!currentFinancialData) {
                    console.warn('No currentFinancialData available yet');
                    return;
                }

                const data = result.data;
                const metrics = data.metrics || {};
                const periods = Array.isArray(data.periods) ? data.periods : [];
                
                console.log('Stored metrics data:', { 
                    hasEpsBasic: !!metrics.eps_basic, 
                    hasEpsDiluted: !!metrics.eps_diluted,
                    epsBasicKeys: metrics.eps_basic ? Object.keys(metrics.eps_basic) : [],
                    epsDilutedKeys: metrics.eps_diluted ? Object.keys(metrics.eps_diluted) : [],
                    allMetricKeys: Object.keys(metrics)
                });
                    
                    // Find the most recent ANNUAL (10-K) period for ratio calculations
                    let latestPeriod = currentFinancialData.periods[0];
                    if (currentFinancialData.period_metadata) {
                        const annualPeriod = currentFinancialData.period_metadata.find(p => p.type === '10-K');
                        if (annualPeriod) {
                            latestPeriod = annualPeriod.date;
                        }
                    }
                    
                    // Helper to pick the latest non-null value
                    const pickValue = (map) => {
                        if (!map) return null;
                        // Try latest period first
                        if (latestPeriod && map.hasOwnProperty(latestPeriod) && map[latestPeriod] !== null && map[latestPeriod] !== undefined) {
                            return map[latestPeriod];
                        }
                        // Fall back to first available
                        for (const p of periods) {
                            if (map.hasOwnProperty(p) && map[p] !== null && map[p] !== undefined) {
                                return map[p];
                            }
                        }
                        return null;
                    };
                    
                    // Get shares outstanding
                    const sharesItem = currentFinancialData.items?.find(item => 
                        item.concept === 'us-gaap_WeightedAverageNumberOfSharesOutstandingBasic' ||
                        item.concept === 'us-gaap_CommonStockSharesOutstanding'
                    );
                    const shares = sharesItem?.values?.[latestPeriod];
                    
                    // Get metrics from stored data (including EPS)
                    const equity = pickValue(metrics.equity);
                    const netIncome = pickValue(metrics.net_income);
                    const epsBasicMap = metrics.eps_basic || {};
                    const epsDilutedMap = metrics.eps_diluted || {};
                    
                    // Calculate TTM metrics for ratios
                    const meta = Array.isArray(currentFinancialData.period_metadata) ? currentFinancialData.period_metadata : [];
                    const periodsOrdered = Array.isArray(currentFinancialData.periods) ? currentFinancialData.periods.slice() : [];
                    
                    // Identify quarterly and annual periods from metadata
                    const quarterlyPeriods = meta
                        .filter(m => m && m.type === '10-Q')
                        .map(m => m.date)
                        .filter(p => periodsOrdered.includes(p));
                    const annualPeriods = meta
                        .filter(m => m && m.type === '10-K')
                        .map(m => m.date)
                        .filter(p => periodsOrdered.includes(p));
                    
                    // Revenue concepts to search for
                    const revenueConcepts = [
                        'us-gaap_RevenueFromContractWithCustomerExcludingAssessedTax',
                        'us-gaap_RevenueFromContractWithCustomerIncludingAssessedTax',
                        'us-gaap_Revenues',
                        'us-gaap_SalesRevenueNet',
                        'us-gaap_Revenue',
                        'us-gaap_RevenuesNetOfInterestExpense',
                        'us-gaap_RegulatedAndUnregulatedOperatingRevenue'
                    ];
                    
                    // Helper to get revenue for a specific period
                    const getRevenueFor = (period) => {
                        for (const item of currentFinancialData.items || []) {
                            if (revenueConcepts.includes(item.concept)) {
                                const val = item.values?.[period];
                                if (Number.isFinite(val)) return val;
                            }
                        }
                        return null;
                    };
                    
                    // Calculate TTM Revenue (same logic as EPS)
                    let revenueTTM = null;
                    // Prefer sum of last four 10-Q revenues if available
                    if (quarterlyPeriods.length >= 4) {
                        const last4 = quarterlyPeriods.slice(0, 4);
                        const vals = last4.map(getRevenueFor).filter(v => Number.isFinite(v));
                        if (vals.length === 4) {
                            revenueTTM = vals.reduce((a,b)=>a+b,0);
                        }
                    }
                    // Fallback: use most recent annual revenue
                    if (!Number.isFinite(revenueTTM) && annualPeriods.length > 0) {
                        const v = getRevenueFor(annualPeriods[0]);
                        if (Number.isFinite(v)) revenueTTM = v;
                    }
                    // Fallback: if only latest quarter revenue available, annualize by *4
                    if (!Number.isFinite(revenueTTM) && quarterlyPeriods.length > 0) {
                        const vq = getRevenueFor(quarterlyPeriods[0]);
                        if (Number.isFinite(vq)) revenueTTM = vq * 4;
                    }
                    // Last resort: use latest period
                    if (!Number.isFinite(revenueTTM)) {
                        revenueTTM = getRevenueFor(latestPeriod);
                    }
                    
                    // Helper to get EPS value for a period from stored metrics
                    const getEpsFor = (period) => {
                        const vB = epsBasicMap[period];
                        const vD = epsDilutedMap[period];
                        return Number.isFinite(vB) ? vB : (Number.isFinite(vD) ? vD : null);
                    };
                    
                    // Calculate TTM EPS
                    let epsTTM = null;
                    
                    // Get all available EPS periods from the stored metrics (sorted newest first)
                    const epsPeriodsAvailable = Object.keys(epsBasicMap).length > 0 
                        ? Object.keys(epsBasicMap).sort().reverse() 
                        : Object.keys(epsDilutedMap).sort().reverse();
                    
                    // Try to sum last 4 quarters of EPS from stored metrics
                    if (epsPeriodsAvailable.length >= 4) {
                        const last4 = epsPeriodsAvailable.slice(0, 4);
                        const vals = last4.map(getEpsFor).filter(v => Number.isFinite(v));
                        if (vals.length === 4) {
                            epsTTM = vals.reduce((a,b)=>a+b,0);
                            console.log('Calculated TTM EPS from 4 quarters:', { periods: last4, values: vals, epsTTM });
                        }
                    }
                    
                    // Fallback: use most recent annual EPS from metadata periods
                    if (!Number.isFinite(epsTTM) && annualPeriods.length > 0) {
                        const v = getEpsFor(annualPeriods[0]);
                        if (Number.isFinite(v)) epsTTM = v;
                    }
                    
                    // Fallback: use most recent EPS and annualize by *4
                    if (!Number.isFinite(epsTTM) && epsPeriodsAvailable.length > 0) {
                        const vq = getEpsFor(epsPeriodsAvailable[0]);
                        if (Number.isFinite(vq)) {
                            epsTTM = vq * 4;
                            console.log('Annualized single quarter EPS:', { period: epsPeriodsAvailable[0], quarterEPS: vq, epsTTM });
                        }
                    }
                    
                    // Last resort fallback: Calculate EPS from net income if EPS not available
                    if (!Number.isFinite(epsTTM) && Number.isFinite(netIncome) && Number.isFinite(shares) && shares > 0) {
                        epsTTM = netIncome / shares;
                        console.log('Calculated EPS from net income (QUARTERLY - needs TTM fix):', { netIncome, shares, epsTTM });
                    }
                    
                    // Get shares for TTM calculation (prefer annual period shares)
                    let sharesTTM = shares;
                    if (annualPeriods.length > 0) {
                        const annualShares = sharesItem?.values?.[annualPeriods[0]];
                        if (Number.isFinite(annualShares)) sharesTTM = annualShares;
                    }
                    
                    // Calculate P/E using TTM EPS
                    let pe = null;
                    if (currentStockPrice && Number.isFinite(epsTTM) && epsTTM > 0) {
                        pe = currentStockPrice / epsTTM;
                    }
                    
                    // Calculate P/S using TTM Revenue
                    let ps = null;
                    if (sharesTTM && revenueTTM && revenueTTM > 0 && currentStockPrice) {
                        const marketCap = currentStockPrice * sharesTTM;
                        ps = marketCap / revenueTTM;
                    }
                    
                    let pb = null;
                    if (equity && shares && shares > 0 && currentStockPrice) {
                        const bookValuePerShare = equity / shares;
                        pb = currentStockPrice / bookValuePerShare;
                    }
                    
                    let roe = null;
                    if (netIncome && equity && equity > 0) {
                        roe = (netIncome / equity) * 100;
                    }
                    
                    // Display ratios with logging
                    console.log('Calculated ratios:', { pe, ps, pb, roe, currentStockPrice, epsTTM, revenueTTM, sharesTTM });
                    document.getElementById('ratioPE').textContent = Number.isFinite(pe) ? `${pe.toFixed(2)}x` : 'N/A';
                    document.getElementById('ratioPS').textContent = Number.isFinite(ps) ? `${ps.toFixed(2)}x` : 'N/A';
                    document.getElementById('ratioPB').textContent = Number.isFinite(pb) ? `${pb.toFixed(2)}x` : 'N/A';
                    document.getElementById('ratioROE').textContent = Number.isFinite(roe) ? `${roe.toFixed(1)}%` : 'N/A';
                
            } catch (error) {
                console.error('Failed to fetch ratios:', error);
            }
        }

        function openStockDetailsModal() {
            if (!currentFinancialData) return;
            
            // Open modal and display full results
            openModal();
            displayResults(currentFinancialData, true);
            
            // Fetch additional data for modal
            if (currentFinancialData.ticker) {
                fetchStockPrice(currentFinancialData.ticker);
                fetchAdditionalFinancialData(currentFinancialData.ticker);
            }
        }

        function displayResults(data, cached) {
            // Store data for later calculations
            currentFinancialData = data;
            
            // Update company info
            const companyNameEl = document.getElementById('stockCompanyName');
            if (companyNameEl) companyNameEl.textContent = data.company_name;
            const tickerEl = document.getElementById('stockTicker');
            if (tickerEl) tickerEl.textContent = data.ticker;
            
            // Handle old cache format (single period) vs new format (multiple periods)
            const isOldFormat = !data.periods && data.period;
            
            if (isOldFormat) {
                // Old format - convert to new format
                data.periods = [data.period];
                data.items = data.items.map(item => ({
                    label: item.label,
                    concept: item.concept,
                    values: { [data.period]: item.value }
                }));
            }
            
            // Format period display
            if (data.periods && data.periods.length > 0) {
                const latestPeriod = data.periods[0];
                const formattedPeriod = `Latest: ${formatPeriod(latestPeriod)}`;
                const periodEl = document.getElementById('stockPeriod');
                if (periodEl) periodEl.textContent = formattedPeriod;
            }
            
            // Calculate and add revenue multiples if we have stock price
            if (currentStockPrice) {
                addRevenueMultiples(data);
            }

            // Create table header with period columns (use correct ID in modal)
            const tableHeader = document.getElementById('tableHeader');
            // Clear existing period headers (keep the Line Item header)
            if (tableHeader) {
                while (tableHeader.children.length > 1) {
                    tableHeader.removeChild(tableHeader.lastChild);
                }
            }
            
            // Add columns based on period metadata (if available) or periods
            if (data.period_metadata && data.period_metadata.length > 0) {
                // Use metadata to correctly label columns
                if (tableHeader) {
                    data.period_metadata.forEach(periodInfo => {
                        const th = document.createElement('th');
                        th.className = 'px-6 py-3 text-right text-sm font-semibold text-gray-700';
                        const date = new Date(periodInfo.date);
                        const formatted = date.toLocaleDateString('en-US', { 
                            month: 'short', 
                            year: 'numeric' 
                        });
                        
                        // Label based on filing type
                        const label = periodInfo.type === '10-Q' ? 'Quarterly' : 'Annual';
                        th.textContent = `${label} (${formatted})`;
                        tableHeader.appendChild(th);
                    });
                }
            } else {
                // Fallback: Detect quarterly vs annual from period end dates
                // Annual reports typically end in Dec (month 11), quarterly can be Mar/Jun/Sep/Dec
                if (tableHeader) {
                    data.periods.forEach((period, index) => {
                        const th = document.createElement('th');
                        th.className = 'px-6 py-3 text-right text-sm font-semibold text-gray-700';
                        const date = new Date(period);
                        const formatted = date.toLocaleDateString('en-US', { 
                            month: 'short', 
                            year: 'numeric' 
                        });
                        
                        // Heuristic: If month is December, likely annual; otherwise quarterly
                        const month = date.getMonth();
                        const isLikelyAnnual = (month === 11); // December = month 11
                        const label = isLikelyAnnual ? 'Annual' : 'Quarterly';
                        
                        th.textContent = `${label} (${formatted})`;
                        tableHeader.appendChild(th);
                    });
                }
            }

            // Render the table using shared renderer for modal
            renderFinancialTable(data);

            // Show results
            const resultsEl = document.getElementById('results');
            if (resultsEl) resultsEl.classList.remove('hidden');
        }

        async function fetchStockPriceInline(ticker) {
            try {
                const response = await fetch(`${API_URL}/api/stock-price/${ticker}`);
                const result = await response.json();
                
                if (result.success) {
                    displayStockPriceInline(result.data);
                } else {
                    const priceSection = document.getElementById('stockPriceInline');
                    if (priceSection) priceSection.classList.add('hidden');
                }
            } catch (error) {
                console.warn('Stock price fetch error:', error);
                const priceSection = document.getElementById('stockPriceInline');
                if (priceSection) priceSection.classList.add('hidden');
            }
        }

        function displayStockPriceInline(data) {
            // Store stock price for calculations
            currentStockPrice = data.price;
            
            // Format and display stock price data in inline box
            const priceEl = document.getElementById('stockPriceValueInline');
            const timestampEl = document.getElementById('stockPriceTimestampInline');
            
            if (priceEl) priceEl.textContent = data.price ? `$${data.price.toFixed(2)}` : 'N/A';
            
            if (data.timestamp) {
                try {
                    const date = new Date(data.timestamp);
                    const now = new Date();
                    const diffMs = now - date;
                    const diffMins = Math.floor(diffMs / 60000);
                    
                    let timeText;
                    if (diffMins < 1) {
                        timeText = 'Just now';
                    } else if (diffMins < 60) {
                        timeText = `${diffMins} min ago`;
                    } else if (diffMins < 1440) {
                        const hours = Math.floor(diffMins / 60);
                        timeText = `${hours} hour${hours > 1 ? 's' : ''} ago`;
                    } else {
                        timeText = date.toLocaleString('en-US', { 
                            month: 'short', 
                            day: 'numeric',
                            hour: 'numeric',
                            minute: '2-digit'
                        });
                    }
                    
                    if (timestampEl) timestampEl.textContent = timeText;
                } catch {
                    if (timestampEl) timestampEl.textContent = '';
                }
            } else {
                if (timestampEl) timestampEl.textContent = '';
            }
            
            // Show the stock price section
            const priceSection = document.getElementById('stockPriceInline');
            if (priceSection) priceSection.classList.remove('hidden');
            
            // Recalculate ratios now that we have the price
            if (currentFinancialData) {
                fetchStockRatiosInline(currentFinancialData.ticker);
            }
        }

        async function fetchAdditionalFinancialDataInline(ticker) {
            try {
                const response = await fetch(`${API_URL}/api/financial-data/${ticker}`);
                const result = await response.json();
                
                if (result.success) {
                    additionalFinancialData = result.data;
                    // Recalculate ratios with new data
                    if (currentFinancialData) {
                        addRevenueMultiples(currentFinancialData);
                        renderStockFinancialTable(currentFinancialData);
                    }
                } else {
                    console.warn('Additional financial data fetch failed:', result.error);
                }
            } catch (error) {
                console.warn('Additional financial data fetch error:', error);
            }
        }

        function displayResults(data, cached) {
            // Store data for later calculations
            currentFinancialData = data;
            
            // Update modal header
            const modalCompanyEl = document.getElementById('modalCompanyName');
            if (modalCompanyEl) modalCompanyEl.textContent = data.company_name;
            const modalTickerEl = document.getElementById('modalTicker');
            if (modalTickerEl) modalTickerEl.textContent = data.ticker;
            
            // Update company info in results section
            const companyNameEl = document.getElementById('companyName');
            if (companyNameEl) companyNameEl.textContent = data.company_name;
            const tickerEl = document.getElementById('ticker');
            if (tickerEl) tickerEl.textContent = data.ticker;
            
            // Handle old cache format (single period) vs new format (multiple periods)
            const isOldFormat = !data.periods && data.period;
            
            if (isOldFormat) {
                // Old format - convert to new format
                data.periods = [data.period];
                data.items = data.items.map(item => ({
                    label: item.label,
                    concept: item.concept,
                    values: { [data.period]: item.value }
                }));
            }
            
            // Format period display
            if (data.periods && data.periods.length > 0) {
                const latestPeriod = data.periods[0];
                const formattedPeriod = `Latest: ${formatPeriod(latestPeriod)}`;
                const periodEl = document.getElementById('period');
                if (periodEl) periodEl.textContent = formattedPeriod;
                const modalPeriodEl = document.getElementById('modalPeriod');
                if (modalPeriodEl) modalPeriodEl.textContent = formattedPeriod;
            }
            
            // Calculate and add revenue multiples if we have stock price
            if (currentStockPrice) {
                addRevenueMultiples(data);
            }

            // Create table header with period columns
            const tableHeader = document.getElementById('tableHeader');
            // Clear existing period headers (keep the Line Item header)
            if (tableHeader) {
                while (tableHeader.children.length > 1) {
                    tableHeader.removeChild(tableHeader.lastChild);
                }
            }
            
            // Add columns based on period metadata (if available) or periods
            if (data.period_metadata && data.period_metadata.length > 0) {
                // Use metadata to correctly label columns
                if (tableHeader) {
                    data.period_metadata.forEach(periodInfo => {
                        const th = document.createElement('th');
                        th.className = 'px-6 py-3 text-right text-sm font-semibold text-gray-700';
                        const date = new Date(periodInfo.date);
                        const formatted = date.toLocaleDateString('en-US', { 
                            month: 'short', 
                            year: 'numeric' 
                        });
                        
                        // Label based on filing type
                        const label = periodInfo.type === '10-Q' ? 'Quarterly' : 'Annual';
                        th.textContent = `${label} (${formatted})`;
                        tableHeader.appendChild(th);
                    });
                }
            } else {
                // Fallback: Detect quarterly vs annual from period end dates
                // Annual reports typically end in Dec (month 11), quarterly can be Mar/Jun/Sep/Dec
                if (tableHeader) {
                    data.periods.forEach((period, index) => {
                        const th = document.createElement('th');
                        th.className = 'px-6 py-3 text-right text-sm font-semibold text-gray-700';
                        const date = new Date(period);
                        const formatted = date.toLocaleDateString('en-US', { 
                            month: 'short', 
                            year: 'numeric' 
                        });
                        
                        // Heuristic: If month is December, likely annual; otherwise quarterly
                        const month = date.getMonth();
                        const isLikelyAnnual = (month === 11); // December = month 11
                        const label = isLikelyAnnual ? 'Annual' : 'Quarterly';
                        
                        th.textContent = `${label} (${formatted})`;
                        tableHeader.appendChild(th);
                    });
                }
            }

            // Render the table
            renderFinancialTable(data);

            // Show results
            const resultsEl = document.getElementById('results');
            if (resultsEl) resultsEl.classList.remove('hidden');
        }
    </script>
</body>
</html>
